<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Property Management System</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            opacity: 0.9;
            font-size: 1.1em;
        }

        .tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 2px solid #dee2e6;
            overflow-x: auto;
        }

        .tab {
            padding: 18px 30px;
            cursor: pointer;
            border: none;
            background: transparent;
            font-size: 16px;
            font-weight: 600;
            color: #6c757d;
            transition: all 0.3s;
            white-space: nowrap;
            position: relative;
        }

        .tab:hover {
            background: #e9ecef;
            color: #495057;
        }

        .tab.active {
            color: #667eea;
            background: white;
        }

        .tab.active::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            right: 0;
            height: 3px;
            background: #667eea;
        }

        .content {
            padding: 30px;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.3s;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .form-section {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 12px;
            margin-bottom: 30px;
        }

        .form-section h3 {
            margin-bottom: 20px;
            color: #333;
            font-size: 1.4em;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        label {
            font-weight: 600;
            margin-bottom: 8px;
            color: #495057;
            font-size: 14px;
        }

        input, select, textarea {
            padding: 12px;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            font-size: 15px;
            transition: border-color 0.3s;
            font-family: inherit;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        textarea {
            resize: vertical;
            min-height: 100px;
        }

        .btn {
            padding: 12px 30px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        .btn-warning {
            background: #ffc107;
            color: #212529;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-whatsapp {
            background: #25D366;
            color: white;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            font-size: 14px;
        }

        .btn-whatsapp:hover {
            background: #1fb855;
        }

        .reminder-card {
            background: white;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #667eea;
            margin-bottom: 15px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .reminder-card h4 {
            margin-bottom: 8px;
            color: #333;
        }

        .reminder-card p {
            margin: 5px 0;
            color: #6c757d;
            font-size: 14px;
        }

        .data-table {
            width: 100%;
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .data-table table {
            width: 100%;
            border-collapse: collapse;
        }

        .data-table th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px;
            text-align: left;
            font-weight: 600;
        }

        .data-table td {
            padding: 15px;
            border-bottom: 1px solid #dee2e6;
        }

        .data-table tr:hover {
            background: #f8f9fa;
        }

        .badge {
            display: inline-block;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .badge-success {
            background: #d4edda;
            color: #155724;
        }

        .badge-warning {
            background: #fff3cd;
            color: #856404;
        }

        .badge-danger {
            background: #f8d7da;
            color: #721c24;
        }

        .badge-info {
            background: #d1ecf1;
            color: #0c5460;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .stat-card h4 {
            font-size: 14px;
            opacity: 0.9;
            margin-bottom: 10px;
        }

        .stat-card .value {
            font-size: 2.5em;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .action-buttons {
            display: flex;
            gap: 10px;
        }

        .search-box {
            margin-bottom: 20px;
        }

        .search-box input {
            width: 100%;
            max-width: 400px;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #6c757d;
        }

        .empty-state svg {
            width: 100px;
            height: 100px;
            margin-bottom: 20px;
            opacity: 0.5;
        }

        @media (max-width: 768px) {
            .form-grid {
                grid-template-columns: 1fr;
            }
            
            .action-buttons {
                flex-direction: column;
            }
            
            .data-table {
                overflow-x: auto;
            }
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div id="loginScreen" style="display: flex; align-items: center; justify-content: center; min-height: 100vh; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
        <div style="background: white; padding: 40px; border-radius: 20px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); max-width: 450px; width: 90%;">
            <h2 style="text-align: center; margin-bottom: 10px; color: #333;">üïå Adam's Masjid</h2>
            <h3 style="text-align: center; margin-bottom: 30px; color: #6c757d; font-weight: normal;">Property Management System</h3>
            
            <div id="loginForm">
                <div class="form-group" style="margin-bottom: 20px;">
                    <label style="font-weight: 600; margin-bottom: 8px; color: #495057; display: block;">Username</label>
                    <input type="text" id="loginUsername" placeholder="Enter username" style="width: 100%; padding: 12px; border: 2px solid #dee2e6; border-radius: 8px; font-size: 15px;" onkeypress="if(event.key==='Enter') login()">
                </div>
                <div class="form-group" style="margin-bottom: 20px;">
                    <label style="font-weight: 600; margin-bottom: 8px; color: #495057; display: block;">Password</label>
                    <input type="password" id="loginPassword" placeholder="Enter password" style="width: 100%; padding: 12px; border: 2px solid #dee2e6; border-radius: 8px; font-size: 15px;" onkeypress="if(event.key==='Enter') login()">
                </div>
                
                <div style="margin-bottom: 20px;">
                    <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                        <input type="radio" name="userType" value="admin" checked>
                        <span>Admin (Full Access)</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 10px; cursor: pointer; margin-top: 10px;">
                        <input type="radio" name="userType" value="viewer">
                        <span>Viewer (Read Only)</span>
                    </label>
                </div>
                
                <button onclick="login()" style="width: 100%; padding: 14px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; margin-bottom: 15px;">
                    Login
                </button>
                
                <div id="loginError" style="display: none; padding: 12px; background: #f8d7da; color: #721c24; border-radius: 8px; margin-top: 15px; text-align: center;">
                </div>
                
                <div style="margin-top: 30px; padding: 20px; background: #e3f2fd; border-radius: 8px; border-left: 4px solid #2196F3;">
                    <h4 style="margin-bottom: 10px; color: #1565c0; font-size: 14px;">Default Credentials</h4>
                    <p style="color: #1565c0; margin: 5px 0; font-size: 13px;"><strong>Admin:</strong> admin / admin123</p>
                    <p style="color: #1565c0; margin: 5px 0; font-size: 13px;"><strong>Viewer:</strong> viewer / viewer123</p>
                    <p style="color: #d32f2f; margin-top: 10px; font-size: 12px;"><strong>‚ö†Ô∏è Change these in Settings after first login!</strong></p>
                </div>
            </div>
        </div>
    </div>

    <div class="container" id="mainApp" style="display: none;">
        <div class="header">
            <h1>üïå Adam's Masjid Property Management System</h1>
            <p>Complete solution for maintenance, equipment, tenants & financials</p>
            <div style="display: flex; align-items: center; justify-content: center; gap: 15px; margin-top: 15px; flex-wrap: wrap;">
                <div id="connectionStatus" style="padding: 8px 16px; border-radius: 20px; display: inline-block; font-size: 14px; background: #ffc107; color: #000;">
                    üîÑ Connecting to cloud...
                </div>
                <div id="userInfo" style="padding: 8px 16px; border-radius: 20px; display: inline-block; font-size: 14px; background: #2196F3; color: white;">
                    üë§ <span id="currentUser"></span> (<span id="currentRole"></span>)
                </div>
                <button onclick="logout()" style="padding: 8px 20px; border-radius: 20px; border: 2px solid white; background: transparent; color: white; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.3s;">
                    üö™ Logout
                </button>
            </div>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="switchTab('dashboard')">üìä Dashboard</button>
            <button class="tab" onclick="switchTab('maintenance')">üîß Maintenance</button>
            <button class="tab" onclick="switchTab('equipment')">‚öôÔ∏è Equipment</button>
            <button class="tab" onclick="switchTab('preventive')">üìÖ Preventive Maintenance</button>
            <button class="tab" onclick="switchTab('tenants')">üë• Tenants</button>
            <button class="tab" onclick="switchTab('rent')">üí∞ Rent & Arrears</button>
            <button class="tab" onclick="switchTab('insurance')">üõ°Ô∏è Insurance Claims</button>
            <button class="tab" onclick="switchTab('reports')">üìà Reports</button>
            <button class="tab" onclick="switchTab('settings')">‚öôÔ∏è Settings</button>
        </div>

        <div class="content">
            <!-- Dashboard Tab -->
            <div id="dashboard" class="tab-content active">
                <div class="stats-grid">
                    <div class="stat-card">
                        <h4>Total Properties</h4>
                        <div class="value" id="totalProperties">0</div>
                    </div>
                    <div class="stat-card">
                        <h4>Active Tenants</h4>
                        <div class="value" id="totalTenants">0</div>
                    </div>
                    <div class="stat-card">
                        <h4>Pending Maintenance</h4>
                        <div class="value" id="pendingMaintenance">0</div>
                    </div>
                    <div class="stat-card">
                        <h4>Total Arrears</h4>
                        <div class="value" id="totalArrears">KES 0</div>
                    </div>
                </div>

                <div class="form-section">
                    <h3>Recent Activity</h3>
                    <div id="recentActivity"></div>
                </div>
            </div>

            <!-- Maintenance Tab -->
            <div id="maintenance" class="tab-content">
                <div class="form-section">
                    <h3>Add Maintenance Task</h3>
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Property/Unit</label>
                            <input type="text" id="maintProperty" placeholder="e.g., Unit 101">
                        </div>
                        <div class="form-group">
                            <label>Task Type</label>
                            <select id="maintType">
                                <option value="Plumbing">Plumbing</option>
                                <option value="Electrical">Electrical</option>
                                <option value="HVAC">HVAC</option>
                                <option value="Appliance">Appliance</option>
                                <option value="Structural">Structural</option>
                                <option value="Cleaning">Cleaning</option>
                                <option value="Landscaping">Landscaping</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Priority</label>
                            <select id="maintPriority">
                                <option value="Low">Low</option>
                                <option value="Medium">Medium</option>
                                <option value="High">High</option>
                                <option value="Emergency">Emergency</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Status</label>
                            <select id="maintStatus">
                                <option value="Pending">Pending</option>
                                <option value="In Progress">In Progress</option>
                                <option value="Completed">Completed</option>
                                <option value="On Hold">On Hold</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Scheduled Date</label>
                            <input type="date" id="maintDate">
                        </div>
                        <div class="form-group">
                            <label>Assigned To</label>
                            <input type="text" id="maintAssigned" placeholder="Technician/Contractor">
                        </div>
                        <div class="form-group">
                            <label>Insured</label>
                            <select id="maintInsured">
                                <option value="Yes">Yes</option>
                                <option value="No">No</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Cost (KES)</label>
                            <input type="number" id="maintCost" placeholder="0.00" step="0.01">
                        </div>
                        <div class="form-group">
                            <label>Set Reminder</label>
                            <input type="datetime-local" id="maintReminder" title="Set a reminder for this task">
                        </div>
                        <div class="form-group">
                            <label>Related Equipment (Optional)</label>
                            <select id="maintEquipment">
                                <option value="">Select Equipment (Optional)</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Description</label>
                        <textarea id="maintDescription" placeholder="Detailed description of the maintenance task..."></textarea>
                    </div>
                    <div class="form-group">
                        <label>Notes</label>
                        <textarea id="maintNotes" placeholder="Additional notes, follow-up required, etc..."></textarea>
                    </div>
                    <button class="btn btn-primary" onclick="addMaintenance()">Add Maintenance Task</button>
                </div>

                <div class="search-box">
                    <input type="text" id="maintSearch" placeholder="üîç Search maintenance tasks..." oninput="filterMaintenance()">
                </div>

                <div class="data-table">
                    <table>
                        <thead>
                            <tr>
                                <th>Property</th>
                                <th>Type</th>
                                <th>Description</th>
                                <th>Priority</th>
                                <th>Status</th>
                                <th>Date</th>
                                <th>Reminder</th>
                                <th>Assigned</th>
                                <th>Insured</th>
                                <th>Cost</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="maintenanceList"></tbody>
                    </table>
                </div>
            </div>

            <!-- Equipment Tab -->
            <div id="equipment" class="tab-content">
                <div class="form-section">
                    <h3>Add Equipment</h3>
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Equipment Name</label>
                            <input type="text" id="equipName" placeholder="e.g., Water Heater, LED Light, Tap">
                        </div>
                        <div class="form-group">
                            <label>Category</label>
                            <select id="equipCategory">
                                <option value="HVAC">HVAC</option>
                                <option value="Plumbing - Taps">Plumbing - Taps</option>
                                <option value="Plumbing - Fixtures">Plumbing - Fixtures</option>
                                <option value="Plumbing - Other">Plumbing - Other</option>
                                <option value="Electrical - LED Lights">Electrical - LED Lights</option>
                                <option value="Electrical - Tube Lights">Electrical - Tube Lights</option>
                                <option value="Electrical - Flood Lights">Electrical - Flood Lights</option>
                                <option value="Electrical - Switches">Electrical - Switches</option>
                                <option value="Electrical - Sockets">Electrical - Sockets</option>
                                <option value="Electrical - Other">Electrical - Other</option>
                                <option value="Appliances">Appliances</option>
                                <option value="Security">Security</option>
                                <option value="Furniture">Furniture</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Floor</label>
                            <select id="equipFloor">
                                <option value="">Select Floor</option>
                                <option value="Ground Floor">Ground Floor</option>
                                <option value="First Floor">First Floor</option>
                                <option value="Second Floor">Second Floor</option>
                                <option value="Third Floor">Third Floor</option>
                                <option value="Basement 1">Basement 1</option>
                                <option value="Basement 2">Basement 2</option>
                                <option value="Basement 3">Basement 3</option>
                                <option value="Rooftop">Rooftop</option>
                                <option value="Parking">Parking</option>
                                <option value="Exterior">Exterior</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Section/Area</label>
                            <select id="equipSection">
                                <option value="">Select Section</option>
                                <option value="Ladies Prayer Hall">Ladies Prayer Hall</option>
                                <option value="Gents Prayer Hall">Gents Prayer Hall</option>
                                <option value="Ladies Washroom">Ladies Washroom</option>
                                <option value="Gents Washroom">Gents Washroom</option>
                                <option value="Ladies Wudu Area">Ladies Wudu Area</option>
                                <option value="Gents Wudu Area">Gents Wudu Area</option>
                                <option value="Main Entrance">Main Entrance</option>
                                <option value="Office">Office</option>
                                <option value="Kitchen">Kitchen</option>
                                <option value="Storage">Storage</option>
                                <option value="Hallway">Hallway</option>
                                <option value="Staircase">Staircase</option>
                                <option value="Common Area">Common Area</option>
                                <option value="Exterior">Exterior</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Specific Location</label>
<input type="text" id="equipLocation" placeholder="e.g., Near entrance, Corner position">
                        </div>
                        <div class="form-group">
                            <label>Total Quantity</label>
                            <input type="number" id="equipQuantity" placeholder="1" min="0" value="1" oninput="updateReplacementCalculation()">
                        </div>
                        <div class="form-group">
                            <label>Working Quantity</label>
                            <input type="number" id="equipWorkingQty" placeholder="1" min="0" value="1" oninput="updateReplacementCalculation()">
                        </div>
                        <div class="form-group" style="display: flex; align-items: center; background: #f8f9fa; padding: 10px; border-radius: 8px;">
                            <label style="margin: 0; flex: 1;">Needs Replacement:</label>
                            <strong id="equipNeedsReplacement" style="color: #dc3545; font-size: 18px;">0</strong>
                        </div>
                        <div class="form-group">
                            <label>Brand/Model</label>
                            <input type="text" id="equipModel" placeholder="Brand and model number">
                        </div>
                        <div class="form-group">
                            <label>Serial Number</label>
                            <input type="text" id="equipSerial" placeholder="Serial number (if applicable)">
                        </div>
                        <div class="form-group">
                            <label>Insured</label>
                            <select id="equipInsured">
                                <option value="Yes">Yes - Covered by Insurance</option>
                                <option value="No">No - Not Insured</option>
                                <option value="Partial">Partially Insured</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Insurance Company</label>
                            <input type="text" id="equipInsuranceCompany" placeholder="Insurance provider (if insured)">
                        </div>
                        <div class="form-group">
                            <label>Service Contract</label>
                            <select id="equipServiceContract">
                                <option value="None">No Service Contract</option>
                                <option value="Active">Active Service Contract</option>
                                <option value="Expired">Expired Contract</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Service Provider</label>
                            <input type="text" id="equipServiceProvider" placeholder="Service provider company">
                        </div>
                        <div class="form-group">
                            <label>Contract Expiry Date</label>
                            <input type="date" id="equipContractExpiry">
                        </div>
                        <div class="form-group">
                            <label>Install Date</label>
                            <input type="date" id="equipInstall">
                        </div>
                        <div class="form-group">
                            <label>Last Service Date</label>
                            <input type="date" id="equipLastService">
                        </div>
                        <div class="form-group">
                            <label>Next Service Due</label>
                            <input type="date" id="equipNextService">
                        </div>
                        <div class="form-group">
                            <label>Warranty Expires</label>
                            <input type="date" id="equipWarranty">
                        </div>
                        <div class="form-group">
                            <label>Status</label>
                            <select id="equipStatus">
                                <option value="Operational">Operational</option>
                                <option value="Needs Service">Needs Service</option>
                                <option value="Needs Replacement">Needs Replacement</option>
                                <option value="Out of Service">Out of Service</option>
                                <option value="Under Warranty">Under Warranty</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Service Records</label>
                        <textarea id="equipServiceRecords" placeholder="Service history, repairs, maintenance performed..."></textarea>
                    </div>
                    <div class="form-group">
                        <label>Notes</label>
                        <textarea id="equipNotes" placeholder="Additional information, specifications, etc..."></textarea>
                    </div>
                    <button class="btn btn-primary" onclick="addEquipment()">Add Equipment</button>
                </div>

                <div class="search-box">
                    <input type="text" id="equipSearch" placeholder="üîç Search equipment..." oninput="filterEquipment()">
                </div>

                <div class="data-table">
                    <table>
                        <thead>
                            <tr>
                                <th>Equipment</th>
                                <th>Category</th>
                                <th>Floor</th>
                                <th>Section</th>
                                <th>Location</th>
                                <th>Qty</th>
                                <th>Status</th>
                                <th>Insurance Claim</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="equipmentList"></tbody>
                    </table>
                </div>
            </div>

            <!-- Preventive Maintenance Tab -->
            <div id="preventive" class="tab-content">
                <div class="form-section">
                    <h3>Create Preventive Maintenance Schedule</h3>
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Select Equipment</label>
                            <select id="pmEquipment">
                                <option value="">Select Equipment</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Maintenance Type</label>
                            <select id="pmType">
                                <option value="Inspection">Inspection</option>
                                <option value="Cleaning">Cleaning</option>
                                <option value="Lubrication">Lubrication</option>
                                <option value="Filter Replacement">Filter Replacement</option>
                                <option value="Testing">Testing</option>
                                <option value="Calibration">Calibration</option>
                                <option value="General Service">General Service</option>
                                <option value="Safety Check">Safety Check</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Frequency</label>
                            <select id="pmFrequency">
                                <option value="Weekly">Weekly</option>
                                <option value="Bi-weekly">Every 2 Weeks</option>
                                <option value="Monthly">Monthly</option>
                                <option value="Quarterly">Every 3 Months</option>
                                <option value="Semi-annually">Every 6 Months</option>
                                <option value="Annually">Yearly</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Next Due Date</label>
                            <input type="date" id="pmNextDue">
                        </div>
                        <div class="form-group">
                            <label>Estimated Duration (minutes)</label>
                            <input type="number" id="pmDuration" placeholder="30" min="5">
                        </div>
                        <div class="form-group">
                            <label>Assigned To</label>
                            <input type="text" id="pmAssignedTo" placeholder="Person/Team responsible">
                        </div>
                        <div class="form-group">
                            <label>Priority</label>
                            <select id="pmPriority">
                                <option value="Low">Low</option>
                                <option value="Medium">Medium</option>
                                <option value="High">High</option>
                                <option value="Critical">Critical</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Status</label>
                            <select id="pmStatus">
                                <option value="Active">Active</option>
                                <option value="Paused">Paused</option>
                                <option value="Inactive">Inactive</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Maintenance Tasks/Checklist</label>
                        <textarea id="pmTasks" placeholder="List tasks to be performed:
- Check oil levels
- Inspect for leaks
- Test safety features
- Clean filters
etc..."></textarea>
                    </div>
                    <div class="form-group">
                        <label>Notes</label>
                        <textarea id="pmNotes" placeholder="Special instructions, safety warnings, required tools..."></textarea>
                    </div>
                    <button class="btn btn-primary" onclick="addPreventiveMaintenance()">Add PM Schedule</button>
                </div>

                <div class="stats-grid">
                    <div class="stat-card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                        <h4>Active Schedules</h4>
                        <div class="value" id="activePMCount">0</div>
                    </div>
                    <div class="stat-card" style="background: linear-gradient(135deg, #dc3545 0%, #ff6b6b 100%);">
                        <h4>Overdue</h4>
                        <div class="value" id="overduePMCount">0</div>
                    </div>
                    <div class="stat-card" style="background: linear-gradient(135deg, #ffc107 0%, #ff9800 100%);">
                        <h4>Due This Week</h4>
                        <div class="value" id="dueWeekPMCount">0</div>
                    </div>
                    <div class="stat-card" style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%);">
                        <h4>Completed This Month</h4>
                        <div class="value" id="completedPMCount">0</div>
                    </div>
                </div>

                <div id="pmOverdueWarnings" style="margin: 20px 0;"></div>

                <div class="search-box">
                    <input type="text" id="pmSearch" placeholder="üîç Search PM schedules..." oninput="filterPMSchedules()">
                    <select id="pmFilterStatus" onchange="filterPMSchedules()" style="margin-left: 10px; padding: 12px; border: 2px solid #dee2e6; border-radius: 8px;">
                        <option value="">All Statuses</option>
                        <option value="Active">Active</option>
                        <option value="Overdue">Overdue</option>
                        <option value="Due Soon">Due This Week</option>
                    </select>
                </div>

                <div class="data-table">
                    <table>
                        <thead>
                            <tr>
                                <th>Equipment</th>
                                <th>Maintenance Type</th>
                                <th>Frequency</th>
                                <th>Next Due</th>
                                <th>Days Until Due</th>
                                <th>Priority</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="pmSchedulesList"></tbody>
                    </table>
                </div>
            </div>

            <!-- Tenants Tab -->
            <div id="tenants" class="tab-content">
                <div class="form-section">
                    <h3>Add Tenant</h3>
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Tenant Name</label>
                            <input type="text" id="tenantName" placeholder="Full name">
                        </div>
                        <div class="form-group">
                            <label>Property/Unit</label>
                            <input type="text" id="tenantUnit" placeholder="e.g., Unit 101">
                        </div>
                        <div class="form-group">
                            <label>Email</label>
                            <input type="email" id="tenantEmail" placeholder="email@example.com">
                        </div>
                        <div class="form-group">
                            <label>Phone</label>
                            <input type="tel" id="tenantPhone" placeholder="(555) 123-4567">
                        </div>
                        <div class="form-group">
                            <label>Lease Start</label>
                            <input type="date" id="tenantLeaseStart">
                        </div>
                        <div class="form-group">
                            <label>Lease End</label>
                            <input type="date" id="tenantLeaseEnd">
                        </div>
                        <div class="form-group">
                            <label>Monthly Rent (KES)</label>
                            <input type="number" id="tenantRent" placeholder="0.00" step="0.01">
                        </div>
                        <div class="form-group">
                            <label>Service Charge (KES)</label>
                            <input type="number" id="tenantServiceCharge" placeholder="0.00" step="0.01">
                        </div>
                        <div class="form-group">
                            <label>VAT (%)</label>
                            <input type="number" id="tenantVAT" placeholder="0" step="0.01" value="16">
                        </div>
                        <div class="form-group">
                            <label>Water Rate (KES per unit)</label>
                            <input type="number" id="tenantWaterRate" placeholder="0.00" step="0.01">
                        </div>
                        <div class="form-group">
                            <label>Electricity Rate (KES per unit)</label>
                            <input type="number" id="tenantElectricityRate" placeholder="0.00" step="0.01">
                        </div>
                        <div class="form-group">
                            <label>Security Deposit (KES)</label>
                            <input type="number" id="tenantDeposit" placeholder="0.00" step="0.01">
                        </div>
                        <div class="form-group">
                            <label>Rent Escalation</label>
                            <select id="tenantEscalation">
                                <option value="None">No Escalation</option>
                                <option value="Annual">Annual Escalation</option>
                                <option value="Biannual">Biannual (Every 6 Months)</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Escalation Rate (%)</label>
                            <input type="number" id="tenantEscalationRate" placeholder="e.g., 5" step="0.1" min="0" max="100">
                        </div>
                        <div class="form-group">
                            <label>Next Escalation Date</label>
                            <input type="date" id="tenantNextEscalation">
                        </div>
                        <div class="form-group">
                            <label>Last Escalation Date</label>
                            <input type="date" id="tenantLastEscalation">
                        </div>
                        <div class="form-group">
                            <label>Status</label>
                            <select id="tenantStatus">
                                <option value="Active">Active</option>
                                <option value="Notice Given">Notice Given</option>
                                <option value="Past Tenant">Past Tenant</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Notes</label>
                        <textarea id="tenantNotes" placeholder="Emergency contacts, special requirements, etc..."></textarea>
                    </div>
                    <button class="btn btn-primary" onclick="addTenant()">Add Tenant</button>
                </div>

                <div id="leaseExpiryWarnings" style="margin-bottom: 20px;"></div>

                <div id="rentEscalationWarnings" style="margin-bottom: 20px;"></div>

                <div class="search-box">
                    <input type="text" id="tenantSearch" placeholder="üîç Search tenants..." oninput="filterTenants()">
                </div>

                <div class="data-table">
                    <table>
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Unit</th>
                                <th>Email</th>
                                <th>Phone</th>
                                <th>Lease Start</th>
                                <th>Lease End</th>
                                <th>Lease Expiry</th>
                                <th>Monthly Rent</th>
                                <th>Rent Escalation</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="tenantsList"></tbody>
                    </table>
                </div>
            </div>

            <!-- Rent & Arrears Tab -->
            <div id="rent" class="tab-content">
                <div class="form-section">
                    <h3>Record Rent Payment</h3>
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Tenant</label>
                            <select id="rentTenant" onchange="calculateTotalBill()">
                                <option value="">Select Tenant</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Payment Date</label>
                            <input type="date" id="rentDate">
                        </div>
                        <div class="form-group">
                            <label>Period (Month/Year)</label>
                            <input type="month" id="rentPeriod">
                        </div>
                    </div>

                    <div style="background: #e3f2fd; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                        <h4 style="margin-bottom: 15px; color: #1565c0;">üí° Bill Calculation</h4>
                        
                        <div class="form-grid">
                            <div class="form-group">
                                <label>Water Units Used</label>
                                <input type="number" id="waterUnits" placeholder="0" step="0.01" oninput="calculateTotalBill()">
                            </div>
                            <div class="form-group">
                                <label>Electricity Units Used</label>
                                <input type="number" id="electricityUnits" placeholder="0" step="0.01" oninput="calculateTotalBill()">
                            </div>
                        </div>

                        <div style="background: white; padding: 15px; border-radius: 8px; margin-top: 15px;">
                            <h5 style="margin-bottom: 10px;">Bill Breakdown:</h5>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; font-size: 14px;">
                                <div><strong>Base Rent:</strong></div>
                                <div id="billRent">KES 0.00</div>
                                
                                <div><strong>Service Charge:</strong></div>
                                <div id="billServiceCharge">KES 0.00</div>
                                
                                <div><strong>Water Charges:</strong></div>
                                <div id="billWater">KES 0.00</div>
                                
                                <div><strong>Electricity Charges:</strong></div>
                                <div id="billElectricity">KES 0.00</div>
                                
                                <div><strong>Subtotal:</strong></div>
                                <div id="billSubtotal">KES 0.00</div>
                                
                                <div><strong>VAT (<span id="billVATPercent">0</span>%):</strong></div>
                                <div id="billVAT">KES 0.00</div>
                                
                                <div style="border-top: 2px solid #667eea; padding-top: 10px; font-size: 16px;"><strong>Total Amount:</strong></div>
                                <div id="billTotal" style="border-top: 2px solid #667eea; padding-top: 10px; font-size: 16px; font-weight: bold; color: #667eea;">KES 0.00</div>
                            </div>
                        </div>
                    </div>

                    <div class="form-grid">
                        <div class="form-group">
                            <label>Amount Paid (KES)</label>
                            <input type="number" id="rentAmount" placeholder="0.00" step="0.01">
                        </div>
                        <div class="form-group">
                            <label>Payment Method</label>
                            <select id="rentMethod">
                                <option value="Bank Transfer">Bank Transfer</option>
                                <option value="Check">Check</option>
                                <option value="Cash">Cash</option>
                                <option value="Credit Card">Credit Card</option>
                                <option value="M-Pesa">M-Pesa</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Notes</label>
                        <textarea id="rentNotes" placeholder="Reference number, late fees, partial payment notes..."></textarea>
                    </div>
                    <button class="btn btn-primary" onclick="addRentPayment()">Record Payment</button>
                </div>

                <div class="form-section">
                    <h3>Rent Status Overview</h3>
                    <div class="data-table">
                        <table>
                            <thead>
                                <tr>
                                    <th>Tenant</th>
                                    <th>Unit</th>
                                    <th>Monthly Rent</th>
                                    <th>Last Payment</th>
                                    <th>Arrears</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="rentStatusList"></tbody>
                        </table>
                    </div>
                </div>

                <div class="form-section">
                    <h3>Payment History</h3>
                    <div class="search-box">
                        <input type="text" id="paymentSearch" placeholder="üîç Search payments..." oninput="filterPayments()">
                    </div>
                    <div class="data-table">
                        <table>
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Tenant</th>
                                    <th>Unit</th>
                                    <th>Amount</th>
                                    <th>Method</th>
                                    <th>Period</th>
                                    <th>Notes</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="paymentsList"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Insurance Claims Tab -->
            <div id="insurance" class="tab-content">
                <div class="form-section">
                    <h3>File Insurance Claim</h3>
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Claim Title</label>
                            <input type="text" id="claimTitle" placeholder="Brief description of claim">
                        </div>
                        <div class="form-group">
                            <label>Related Item/Equipment</label>
                            <select id="claimEquipment">
                                <option value="">Select Equipment (Optional)</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Category</label>
                            <select id="claimCategory">
                                <option value="Property Damage">Property Damage</option>
                                <option value="Equipment Damage">Equipment Damage</option>
                                <option value="Theft">Theft</option>
                                <option value="Water Damage">Water Damage</option>
                                <option value="Fire Damage">Fire Damage</option>
                                <option value="Electrical Damage">Electrical Damage</option>
                                <option value="Natural Disaster">Natural Disaster</option>
                                <option value="Liability">Liability</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Incident Date</label>
                            <input type="date" id="claimIncidentDate">
                        </div>
                        <div class="form-group">
                            <label>Claim Date Filed</label>
                            <input type="date" id="claimFiledDate">
                        </div>
                        <div class="form-group">
                            <label>Insurance Company</label>
                            <input type="text" id="claimInsuranceCompany" placeholder="e.g., ABC Insurance">
                        </div>
                        <div class="form-group">
                            <label>Policy Number</label>
                            <input type="text" id="claimPolicyNumber" placeholder="Policy/Reference number">
                        </div>
                        <div class="form-group">
                            <label>Claim Amount (KES)</label>
                            <input type="number" id="claimAmount" placeholder="0.00" step="0.01">
                        </div>
                        <div class="form-group">
                            <label>Status</label>
                            <select id="claimStatus">
                                <option value="Pending Submission">Pending Submission</option>
                                <option value="Submitted">Submitted</option>
                                <option value="Under Review">Under Review</option>
                                <option value="Approved">Approved</option>
                                <option value="Partially Approved">Partially Approved</option>
                                <option value="Rejected">Rejected</option>
                                <option value="Cleared/Paid">Cleared/Paid</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Approved Amount (KES)</label>
                            <input type="number" id="claimApprovedAmount" placeholder="0.00" step="0.01">
                        </div>
                        <div class="form-group">
                            <label>Expected Settlement Date</label>
                            <input type="date" id="claimExpectedDate">
                        </div>
                        <div class="form-group">
                            <label>Actual Settlement Date</label>
                            <input type="date" id="claimSettlementDate">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Incident Description</label>
                        <textarea id="claimDescription" placeholder="Detailed description of the incident..."></textarea>
                    </div>
                    <div class="form-group">
                        <label>Documents Submitted</label>
                        <textarea id="claimDocuments" placeholder="List of documents: photos, police report, receipts, etc..."></textarea>
                    </div>
                    <div class="form-group">
                        <label>Notes / Follow-up</label>
                        <textarea id="claimNotes" placeholder="Communication history, follow-up actions, etc..."></textarea>
                    </div>
                    <button class="btn btn-primary" onclick="addInsuranceClaim()">File Insurance Claim</button>
                </div>

                <div class="stats-grid">
                    <div class="stat-card" style="background: linear-gradient(135deg, #ffc107 0%, #ff9800 100%);">
                        <h4>Pending Claims</h4>
                        <div class="value" id="pendingClaims">0</div>
                    </div>
                    <div class="stat-card" style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%);">
                        <h4>Cleared Claims</h4>
                        <div class="value" id="clearedClaims">0</div>
                    </div>
                    <div class="stat-card" style="background: linear-gradient(135deg, #17a2b8 0%, #138496 100%);">
                        <h4>Total Claimed</h4>
                        <div class="value" id="totalClaimed">KES 0</div>
                    </div>
                    <div class="stat-card" style="background: linear-gradient(135deg, #28a745 0%, #218838 100%);">
                        <h4>Total Recovered</h4>
                        <div class="value" id="totalRecovered">KES 0</div>
                    </div>
                </div>

                <div class="search-box">
                    <input type="text" id="claimSearch" placeholder="üîç Search claims..." oninput="filterClaims()">
                    <select id="claimStatusFilter" onchange="filterClaims()" style="margin-left: 10px; padding: 12px; border: 2px solid #dee2e6; border-radius: 8px;">
                        <option value="">All Statuses</option>
                        <option value="Pending">Pending</option>
                        <option value="Cleared">Cleared/Paid</option>
                        <option value="Rejected">Rejected</option>
                    </select>
                </div>

                <div class="data-table">
                    <table>
                        <thead>
                            <tr>
                                <th>Claim Title</th>
                                <th>Category</th>
                                <th>Incident Date</th>
                                <th>Filed Date</th>
                                <th>Amount Claimed</th>
                                <th>Approved Amount</th>
                                <th>Status</th>
                                <th>Settlement Date</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="insuranceClaimsList"></tbody>
                    </table>
                </div>
            </div>

            <!-- Reports Tab -->
            <div id="reports" class="tab-content">
                <div class="form-section">
                    <h3>Generate Reports</h3>
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Report Type</label>
                            <select id="reportType" onchange="toggleReportFilters()">
                                <option value="maintenance">Maintenance Summary (Active)</option>
                                <option value="maintenance-history">Maintenance History (Completed Archive)</option>
                                <option value="equipment">Equipment Inventory</option>
                                <option value="equipment-detailed">Equipment Detailed (Replacements & Status)</option>
                                <option value="equipment-attention">Items Needing Attention</option>
                                <option value="equipment-history">Equipment Changes History</option>
                                <option value="preventive-maintenance">Preventive Maintenance Schedule</option>
                                <option value="pm-overdue">Overdue PM Items</option>
                                <option value="pm-history">PM Completion History</option>
                                <option value="rent">Rent Collection</option>
                                <option value="rent-history">Rent Payment History</option>
                                <option value="arrears">Arrears Report</option>
                                <option value="tenants">Tenant List</option>
                                <option value="tenants-leases">Tenant Leases & Expiry</option>
                                <option value="escalation-history">Rent Escalation History</option>
                                <option value="insurance-claims">Insurance Claims</option>
                                <option value="combined">Combined Report (All Data)</option>
                                <option value="custom-combined">Custom Combined (Select Multiple)</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Date From</label>
                            <input type="date" id="reportFrom">
                        </div>
                        <div class="form-group">
                            <label>Date To</label>
                            <input type="date" id="reportTo">
                        </div>
                    </div>
                    
                    <!-- Advanced Equipment Filters -->
                    <div id="equipmentFilters" style="display: none; margin-top: 20px; padding: 20px; background: #f8f9fa; border-radius: 8px;">
                        <h4 style="margin-bottom: 15px;">üìä Advanced Equipment Filters</h4>
                        <div class="form-grid">
                            <div class="form-group">
                                <label>Floor</label>
                                <select id="filterFloor">
                                    <option value="">All Floors</option>
                                    <option value="Ground Floor">Ground Floor</option>
                                    <option value="First Floor">First Floor</option>
                                    <option value="Second Floor">Second Floor</option>
                                    <option value="Third Floor">Third Floor</option>
                                    <option value="Basement 1">Basement 1</option>
                                    <option value="Basement 2">Basement 2</option>
                                    <option value="Basement 3">Basement 3</option>
                                    <option value="Rooftop">Rooftop</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Section</label>
                                <select id="filterSection">
                                    <option value="">All Sections</option>
                                    <option value="Ladies Prayer Hall">Ladies Prayer Hall</option>
                                    <option value="Gents Prayer Hall">Gents Prayer Hall</option>
                                    <option value="Ladies Washroom">Ladies Washroom</option>
                                    <option value="Gents Washroom">Gents Washroom</option>
                                    <option value="Ladies Wudu Area">Ladies Wudu Area</option>
                                    <option value="Gents Wudu Area">Gents Wudu Area</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Category</label>
                                <select id="filterCategory">
                                    <option value="">All Categories</option>
                                    <option value="Electrical - LED Lights">LED Lights</option>
                                    <option value="Electrical - Tube Lights">Tube Lights</option>
                                    <option value="Electrical - Flood Lights">Flood Lights</option>
                                    <option value="Plumbing - Taps">Taps</option>
                                    <option value="Plumbing - Fixtures">Plumbing Fixtures</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Status</label>
                                <select id="filterStatus">
                                    <option value="">All Statuses</option>
                                    <option value="Operational">Operational</option>
                                    <option value="Needs Service">Needs Service</option>
                                    <option value="Needs Replacement">Needs Replacement</option>
                                    <option value="Out of Service">Out of Service</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Insurance Status</label>
                                <select id="filterInsured">
                                    <option value="">All</option>
                                    <option value="Yes">Insured Only</option>
                                    <option value="No">Not Insured</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Service Contract</label>
                                <select id="filterServiceContract">
                                    <option value="">All</option>
                                    <option value="Active">Active Contract</option>
                                    <option value="None">No Contract</option>
                                    <option value="Expired">Expired</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Replacement Status</label>
                                <select id="filterReplacement">
                                    <option value="">All</option>
                                    <option value="needs">Needs Replacement (Qty > 0)</option>
                                    <option value="ok">All Working</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Custom Combined Report Selector -->
                    <div id="customReportSelector" style="display: none; margin-top: 20px; padding: 20px; background: #e3f2fd; border-radius: 8px;">
                        <h4 style="margin-bottom: 15px;">üìã Select Report Sections to Include</h4>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                            <label style="display: flex; align-items: center; padding: 10px; background: white; border-radius: 4px; cursor: pointer;">
                                <input type="checkbox" id="includeEquipment" checked style="margin-right: 10px;">
                                <span>üì¶ Equipment Detailed</span>
                            </label>
                            <label style="display: flex; align-items: center; padding: 10px; background: white; border-radius: 4px; cursor: pointer;">
                                <input type="checkbox" id="includeAttention" checked style="margin-right: 10px;">
                                <span>‚ö†Ô∏è Items Needing Attention</span>
                            </label>
                            <label style="display: flex; align-items: center; padding: 10px; background: white; border-radius: 4px; cursor: pointer;">
                                <input type="checkbox" id="includeMaintenance" checked style="margin-right: 10px;">
                                <span>üîß Maintenance Summary</span>
                            </label>
                            <label style="display: flex; align-items: center; padding: 10px; background: white; border-radius: 4px; cursor: pointer;">
                                <input type="checkbox" id="includePM" checked style="margin-right: 10px;">
                                <span>üìÖ Preventive Maintenance</span>
                            </label>
                            <label style="display: flex; align-items: center; padding: 10px; background: white; border-radius: 4px; cursor: pointer;">
                                <input type="checkbox" id="includeTenantLeases" checked style="margin-right: 10px;">
                                <span>üìÖ Tenant Leases</span>
                            </label>
                            <label style="display: flex; align-items: center; padding: 10px; background: white; border-radius: 4px; cursor: pointer;">
                                <input type="checkbox" id="includeRent" checked style="margin-right: 10px;">
                                <span>üí∞ Rent Collection</span>
                            </label>
                            <label style="display: flex; align-items: center; padding: 10px; background: white; border-radius: 4px; cursor: pointer;">
                                <input type="checkbox" id="includeArrears" checked style="margin-right: 10px;">
                                <span>üí≥ Arrears Report</span>
                            </label>
                            <label style="display: flex; align-items: center; padding: 10px; background: white; border-radius: 4px; cursor: pointer;">
                                <input type="checkbox" id="includeInsurance" checked style="margin-right: 10px;">
                                <span>üõ°Ô∏è Insurance Claims</span>
                            </label>
                        </div>
                    </div>
                    
                    <button class="btn btn-primary" onclick="generateReport()" style="margin-top: 15px;">Generate Report</button>
                </div>

                <div id="reportOutput" class="form-section" style="display: none;">
                    <h3>Report Results</h3>
                    <div style="margin-bottom: 20px; display: flex; gap: 10px; flex-wrap: wrap;">
                        <button class="btn btn-primary" onclick="downloadReportPDF()">üì• Download as PDF</button>
                        <button class="btn btn-success" onclick="emailReport()">üìß Email Report</button>
                        <button class="btn btn-whatsapp" onclick="sendReportViaWhatsApp()">üì± Share via WhatsApp</button>
                    </div>
                    <div id="reportContent"></div>
                </div>
            </div>

            <!-- Settings Tab -->
            <div id="settings" class="tab-content">
                <!-- Data Recovery Section -->
                <div class="form-section" style="background: #fff3cd; border-left: 4px solid #ffc107;">
                    <h3>üÜò Emergency Data Recovery</h3>
                    <p style="color: #856404; margin-bottom: 15px;"><strong>Critical: Use if data is missing</strong></p>
                    
                    <div style="display: grid; gap: 10px; margin-bottom: 20px;">
                        <button class="btn btn-danger" onclick="deepScanAllStorage()" style="padding: 15px; font-weight: bold;">
                            üîç DEEP SCAN - Check All Browser Storage
                        </button>
                        <button class="btn btn-primary" onclick="checkDataStatus()" style="padding: 15px;">
                            üìä Check What Data Exists
                        </button>
                        <button class="btn btn-success" onclick="viewLocalStorageData()" style="padding: 15px;">
                            üëÅÔ∏è View All LocalStorage Data
                        </button>
                        <button class="btn btn-warning" onclick="forceReloadData()" style="padding: 15px;">
                            üîÑ Force Reload All Data
                        </button>
                        <button class="btn btn-info" onclick="exportAllData()" style="padding: 15px;">
                            üíæ Export Current Data (Backup)
                        </button>
                    </div>
                    
                    <div style="margin-bottom: 20px; padding: 15px; background: #f8d7da; border-left: 4px solid #dc3545; border-radius: 4px;">
                        <h4 style="color: #721c24; margin-bottom: 10px;">üìÇ Import Backup File</h4>
                        <p style="color: #721c24; margin-bottom: 10px; font-size: 14px;">If you have a backup JSON file, upload it here to restore your data</p>
                        <input type="file" id="importFileInput" accept=".json" style="margin-bottom: 10px; padding: 10px; border: 2px solid #dc3545; border-radius: 4px; width: 100%;">
                        <button class="btn btn-danger" onclick="importBackupFile()" style="padding: 12px 20px;">
                            üì• Import & Restore Data
                        </button>
                    </div>
                    
                    <div style="margin-bottom: 20px; padding: 15px; background: #d1ecf1; border-left: 4px solid #0c5460; border-radius: 4px;">
                        <h4 style="color: #0c5460; margin-bottom: 10px;">‚ûï Manual Data Entry</h4>
                        <p style="color: #0c5460; margin-bottom: 10px; font-size: 14px;">If you have data in other formats (Excel, text), paste JSON here</p>
                        <textarea id="manualDataInput" placeholder='Paste JSON data here. Format: {"maintenance": [...], "equipment": [...], "tenants": [...]}' style="width: 100%; height: 150px; padding: 10px; border: 2px solid #0c5460; border-radius: 4px; font-family: monospace; font-size: 12px;"></textarea>
                        <button class="btn btn-info" onclick="importManualData()" style="padding: 12px 20px; margin-top: 10px;">
                            üìù Import Manual Data
                        </button>
                    </div>
                    
                    <div id="dataStatusOutput" style="padding: 20px; background: white; border-radius: 8px; min-height: 100px; font-family: monospace; font-size: 12px; overflow: auto; max-height: 400px; white-space: pre-wrap; display: none;"></div>
                </div>

                <div class="form-section">
                    <h3>üî• Firebase Cloud Database Configuration</h3>
                    <p style="margin-bottom: 20px; color: #6c757d;">Connect to Firebase to enable cloud storage, automatic backups, and multi-device access.</p>
                    
                    <div style="padding: 20px; background: #e3f2fd; border-radius: 8px; border-left: 4px solid #2196F3; margin-bottom: 20px;">
                        <h4 style="margin-bottom: 10px; color: #1565c0;">üìö Setup Instructions</h4>
                        <ol style="color: #1565c0; margin-left: 20px; line-height: 1.8;">
                            <li>Go to <a href="https://console.firebase.google.com" target="_blank" style="color: #1976d2; font-weight: bold;">Firebase Console</a></li>
                            <li>Click "Add project" or select existing project</li>
                            <li>Go to Project Settings (gear icon) ‚Üí Your apps ‚Üí Web app</li>
                            <li>Copy your Firebase configuration values below</li>
                            <li>In Firebase Console, go to "Realtime Database" ‚Üí Create Database ‚Üí Start in test mode</li>
                            <li>Click "Save Firebase Config" button below</li>
                        </ol>
                    </div>

                    <div class="form-grid">
                        <div class="form-group">
                            <label>API Key</label>
                            <input type="text" id="firebaseApiKey" placeholder="AIza...">
                        </div>
                        <div class="form-group">
                            <label>Auth Domain</label>
                            <input type="text" id="firebaseAuthDomain" placeholder="your-project.firebaseapp.com">
                        </div>
                        <div class="form-group">
                            <label>Database URL</label>
                            <input type="text" id="firebaseDatabaseURL" placeholder="https://your-project.firebaseio.com">
                        </div>
                        <div class="form-group">
                            <label>Project ID</label>
                            <input type="text" id="firebaseProjectId" placeholder="your-project-id">
                        </div>
                        <div class="form-group">
                            <label>Storage Bucket</label>
                            <input type="text" id="firebaseStorageBucket" placeholder="your-project.appspot.com">
                        </div>
                        <div class="form-group">
                            <label>Messaging Sender ID</label>
                            <input type="text" id="firebaseMessagingSenderId" placeholder="123456789">
                        </div>
                        <div class="form-group">
                            <label>App ID</label>
                            <input type="text" id="firebaseAppId" placeholder="1:123456789:web:...">
                        </div>
                    </div>
                    
                    <button class="btn btn-primary" onclick="saveFirebaseConfig()">Save Firebase Config & Connect</button>
                    <button class="btn btn-warning" onclick="testConnection()" style="margin-left: 10px;">Test Connection</button>
                    
                    <div id="firebaseStatus" style="margin-top: 20px; padding: 15px; border-radius: 8px; display: none;"></div>
                    
                    <div style="margin-top: 20px; padding: 15px; background: #fff3cd; border-radius: 8px; border-left: 4px solid #ffc107;">
                        <h4 style="margin-bottom: 10px; color: #856404;">üîß Troubleshooting Connection Issues</h4>
                        <ul style="color: #856404; margin-left: 20px; line-height: 1.8; font-size: 13px;">
                            <li><strong>If "Testing connection..." keeps running:</strong> Check your internet connection and Firebase database URL</li>
                            <li><strong>If you see timeout error:</strong> Verify your Firebase Realtime Database is created (not Firestore)</li>
                            <li><strong>If connection fails:</strong> Make sure you created the database in "Test Mode" or have proper security rules</li>
                            <li><strong>Database Rules:</strong> Go to Firebase Console ‚Üí Realtime Database ‚Üí Rules tab. For testing, use:
                                <pre style="background: #fff; padding: 10px; border-radius: 4px; margin-top: 5px; font-size: 11px;">{
  "rules": {
    ".read": true,
    ".write": true
  }
}</pre>
                            </li>
                            <li><strong>Check browser console:</strong> Press F12 to see detailed error messages</li>
                            <li><strong>Still having issues?</strong> Try clearing browser cache and reloading the page</li>
                        </ul>
                    </div>
                </div>

                <div class="form-section">
                    <h3>WhatsApp Notifications Settings</h3>
                    <p style="margin-bottom: 20px; color: #6c757d;">Configure admin phone number to receive WhatsApp reminders for tasks and important events.</p>
                    
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Admin Name</label>
                            <input type="text" id="adminName" placeholder="Enter admin name">
                        </div>
                        <div class="form-group">
                            <label>Admin WhatsApp Number (with country code)</label>
                            <input type="tel" id="adminPhone" placeholder="e.g., +1234567890">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label style="display: flex; align-items: center; gap: 10px;">
                            <input type="checkbox" id="enableReminders" style="width: auto;">
                            <span>Enable WhatsApp Reminders</span>
                        </label>
                    </div>
                    
                    <button class="btn btn-primary" onclick="saveSettings()">Save Settings</button>
                    
                    <div style="margin-top: 30px; padding: 20px; background: #fff3cd; border-radius: 8px; border-left: 4px solid #ffc107;">
                        <h4 style="margin-bottom: 10px; color: #856404;">üì± How WhatsApp Reminders Work</h4>
                        <p style="color: #856404; margin-bottom: 10px;">When you set a reminder for a task, the system will generate a WhatsApp message link that you can click to send the reminder to the admin.</p>
                        <p style="color: #856404; margin-bottom: 10px;"><strong>Features:</strong></p>
                        <ul style="color: #856404; margin-left: 20px;">
                            <li>Set reminders for maintenance tasks</li>
                            <li>Get notified about upcoming equipment service dates</li>
                            <li>Receive alerts for rent arrears</li>
                            <li>Click the WhatsApp button to send instant notifications</li>
                        </ul>
                    </div>
                </div>

                <div class="form-section" id="credentialsSection" style="display: none;">
                    <h3>üîê Change Login Credentials (Admin Only)</h3>
                    <p style="margin-bottom: 20px; color: #6c757d;">Update admin and viewer login credentials. This is highly recommended for security!</p>
                    
                    <div style="padding: 15px; background: #fff3cd; border-radius: 8px; border-left: 4px solid #ffc107; margin-bottom: 20px;">
                        <p style="color: #856404; margin: 0;"><strong>‚ö†Ô∏è Important:</strong> Remember your new credentials! There's no password recovery.</p>
                    </div>

                    <h4 style="margin-bottom: 15px; color: #333;">Admin Credentials</h4>
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Admin Username</label>
                            <input type="text" id="newAdminUsername" placeholder="Enter new admin username">
                        </div>
                        <div class="form-group">
                            <label>Admin Password</label>
                            <input type="password" id="newAdminPassword" placeholder="Enter new admin password">
                        </div>
                    </div>

                    <h4 style="margin: 25px 0 15px; color: #333;">Viewer Credentials</h4>
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Viewer Username</label>
                            <input type="text" id="newViewerUsername" placeholder="Enter new viewer username">
                        </div>
                        <div class="form-group">
                            <label>Viewer Password</label>
                            <input type="password" id="newViewerPassword" placeholder="Enter new viewer password">
                        </div>
                    </div>
                    
                    <button class="btn btn-primary" onclick="updateCredentials()">Update Credentials</button>
                </div>

                <div class="form-section">
                    <h3>Upcoming Reminders</h3>
                    <div id="upcomingReminders"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>

    <!-- jsPDF for PDF generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>

    <script>
        // Firebase Configuration
        let firebaseConfig = JSON.parse(localStorage.getItem('firebaseConfig')) || null;
        let firebaseApp = null;
        let database = null;
        let isFirebaseConnected = false;

        // Authentication
        let currentUser = null;
        let userRole = null; // 'admin' or 'viewer'
        let credentials = JSON.parse(localStorage.getItem('credentials')) || {
            admin: { username: 'admin', password: 'admin123' },
            viewer: { username: 'viewer', password: 'viewer123' }
        };

        // Data Storage
        let maintenance = [];
        let equipment = [];
        let tenants = [];
        let payments = [];
        let insuranceClaims = [];
        let preventiveMaintenance = [];
        let pmCompletionHistory = [];
        let settings = JSON.parse(localStorage.getItem('settings')) || {
            adminName: '',
            adminPhone: '',
            enableReminders: false
        };

        // Authentication Functions
        function login() {
            const username = document.getElementById('loginUsername').value.trim();
            const password = document.getElementById('loginPassword').value.trim();
            const userType = document.querySelector('input[name="userType"]:checked').value;

            if (!username || !password) {
                showLoginError('Please enter both username and password');
                return;
            }

            // Check credentials
            if (credentials[userType].username === username && credentials[userType].password === password) {
                currentUser = username;
                userRole = userType;
                
                // Save session
                sessionStorage.setItem('currentUser', username);
                sessionStorage.setItem('userRole', userType);
                
                // Show main app
                document.getElementById('loginScreen').style.display = 'none';
                document.getElementById('mainApp').style.display = 'block';
                
                // Update UI
                document.getElementById('currentUser').textContent = username;
                document.getElementById('currentRole').textContent = userType === 'admin' ? 'Admin' : 'Viewer';
                
                // Apply role permissions
                applyRolePermissions();
                
                // Initialize app
                initializeApp();
            } else {
                showLoginError('Invalid username or password');
            }
        }

        function logout() {
            if (confirm('Are you sure you want to logout?')) {
                sessionStorage.removeItem('currentUser');
                sessionStorage.removeItem('userRole');
                currentUser = null;
                userRole = null;
                
                document.getElementById('loginScreen').style.display = 'flex';
                document.getElementById('mainApp').style.display = 'none';
                document.getElementById('loginUsername').value = '';
                document.getElementById('loginPassword').value = '';
                document.getElementById('loginError').style.display = 'none';
            }
        }

        function showLoginError(message) {
            const errorDiv = document.getElementById('loginError');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
        }

        function checkSession() {
            const savedUser = sessionStorage.getItem('currentUser');
            const savedRole = sessionStorage.getItem('userRole');
            
            if (savedUser && savedRole) {
                currentUser = savedUser;
                userRole = savedRole;
                document.getElementById('loginScreen').style.display = 'none';
                document.getElementById('mainApp').style.display = 'block';
                document.getElementById('currentUser').textContent = savedUser;
                document.getElementById('currentRole').textContent = savedRole === 'admin' ? 'Admin' : 'Viewer';
                applyRolePermissions();
                return true;
            }
            return false;
        }

        function applyRolePermissions() {
            const isAdmin = userRole === 'admin';
            
            // Hide/show credentials section (admin only)
            const credentialsSection = document.getElementById('credentialsSection');
            if (credentialsSection) {
                credentialsSection.style.display = isAdmin ? 'block' : 'none';
            }
            
            // Disable all buttons and inputs for viewers
            if (!isAdmin) {
                // Disable all form inputs
                document.querySelectorAll('input, select, textarea, button').forEach(element => {
                    if (element.id !== 'maintSearch' && 
                        element.id !== 'equipSearch' && 
                        element.id !== 'tenantSearch' && 
                        element.id !== 'paymentSearch' &&
                        !element.closest('.tabs') &&
                        element.onclick?.name !== 'logout') {
                        element.disabled = true;
                        element.style.opacity = '0.6';
                        element.style.cursor = 'not-allowed';
                    }
                });
                
                // Add read-only banner
                const header = document.querySelector('.header');
                const banner = document.createElement('div');
                banner.style.cssText = 'background: #ff9800; color: white; padding: 10px; text-align: center; font-weight: bold; margin-top: 10px; border-radius: 8px;';
                banner.textContent = 'üëÅÔ∏è READ-ONLY MODE - You have view-only access';
                header.appendChild(banner);
            }
        }

        function updateCredentials() {
            if (userRole !== 'admin') {
                alert('Only admins can update credentials!');
                return;
            }

            const newAdminUsername = document.getElementById('newAdminUsername').value.trim();
            const newAdminPassword = document.getElementById('newAdminPassword').value.trim();
            const newViewerUsername = document.getElementById('newViewerUsername').value.trim();
            const newViewerPassword = document.getElementById('newViewerPassword').value.trim();

            if (!newAdminUsername && !newAdminPassword && !newViewerUsername && !newViewerPassword) {
                alert('Please enter at least one new credential');
                return;
            }

            if (newAdminUsername) credentials.admin.username = newAdminUsername;
            if (newAdminPassword) credentials.admin.password = newAdminPassword;
            if (newViewerUsername) credentials.viewer.username = newViewerUsername;
            if (newViewerPassword) credentials.viewer.password = newViewerPassword;

            // Save to localStorage
            localStorage.setItem('credentials', JSON.stringify(credentials));
            
            // Save to Firebase if connected
            if (isFirebaseConnected && database) {
                database.ref('credentials').set(credentials);
            }

            alert('‚úÖ Credentials updated successfully! Please remember your new login details.');
            
            // Clear fields
            document.getElementById('newAdminUsername').value = '';
            document.getElementById('newAdminPassword').value = '';
            document.getElementById('newViewerUsername').value = '';
            document.getElementById('newViewerPassword').value = '';
        }

        // Load credentials from Firebase
        function loadCredentialsFromFirebase() {
            if (isFirebaseConnected && database) {
                database.ref('credentials').once('value', (snapshot) => {
                    if (snapshot.val()) {
                        credentials = snapshot.val();
                        localStorage.setItem('credentials', JSON.stringify(credentials));
                    }
                });
            }
        }

        // Initialize Firebase if config exists
        function initializeFirebase() {
            if (firebaseConfig) {
                try {
                    console.log('Initializing Firebase with config:', { ...firebaseConfig, apiKey: '***hidden***' });
                    
                    // Check if Firebase is already initialized
                    if (firebase.apps && firebase.apps.length > 0) {
                        console.log('Firebase already initialized, using existing app');
                        firebaseApp = firebase.apps[0];
                    } else {
                        console.log('Initializing new Firebase app');
                        firebaseApp = firebase.initializeApp(firebaseConfig);
                    }
                    
                    database = firebase.database();
                    
                    // Test database connection
                    database.ref('.info/connected').on('value', (snapshot) => {
                        if (snapshot.val() === true) {
                            isFirebaseConnected = true;
                            updateConnectionStatus('connected');
                            console.log('Firebase connected successfully');
                        } else {
                            isFirebaseConnected = false;
                            updateConnectionStatus('error');
                            console.log('Firebase disconnected');
                        }
                    });
                    
                    loadDataFromFirebase();
                    setupFirebaseListeners();
                    loadCredentialsFromFirebase();
                } catch (error) {
                    console.error('Firebase initialization error:', error);
                    isFirebaseConnected = false;
                    updateConnectionStatus('error');
                    loadDataFromLocalStorage();
                    
                    // Show detailed error to user if on settings page
                    const statusDiv = document.getElementById('firebaseStatus');
                    if (statusDiv) {
                        showFirebaseStatus('‚ùå Firebase initialization failed: ' + error.message + '. Please check your configuration.', 'error');
                    }
                }
            } else {
                console.log('No Firebase config found');
                updateConnectionStatus('not-configured');
                loadDataFromLocalStorage();
            }
        }

        // Load data from localStorage as fallback
        function loadDataFromLocalStorage() {
            maintenance = JSON.parse(localStorage.getItem('maintenance')) || [];
            equipment = JSON.parse(localStorage.getItem('equipment')) || [];
            tenants = JSON.parse(localStorage.getItem('tenants')) || [];
            payments = JSON.parse(localStorage.getItem('payments')) || [];
            insuranceClaims = JSON.parse(localStorage.getItem('insuranceClaims')) || [];
            preventiveMaintenance = JSON.parse(localStorage.getItem('preventiveMaintenance')) || [];
            pmCompletionHistory = JSON.parse(localStorage.getItem('pmCompletionHistory')) || [];
        }

        // Load data from Firebase
        function loadDataFromFirebase() {
            database.ref('maintenance').once('value', (snapshot) => {
                maintenance = snapshot.val() ? Object.values(snapshot.val()) : [];
                renderMaintenance();
                updateDashboard();
                renderUpcomingReminders();
            }).catch((error) => {
                console.error('Error loading maintenance:', error);
                if (error.code === 'PERMISSION_DENIED') {
                    handlePermissionDenied('maintenance');
                }
                // Load from localStorage as backup
                maintenance = JSON.parse(localStorage.getItem('maintenance')) || [];
                renderMaintenance();
            });

            database.ref('equipment').once('value', (snapshot) => {
                equipment = snapshot.val() ? Object.values(snapshot.val()) : [];
                renderEquipment();
            }).catch((error) => {
                console.error('Error loading equipment:', error);
                if (error.code === 'PERMISSION_DENIED') {
                    handlePermissionDenied('equipment');
                }
                equipment = JSON.parse(localStorage.getItem('equipment')) || [];
                renderEquipment();
            });

            database.ref('tenants').once('value', (snapshot) => {
                tenants = snapshot.val() ? Object.values(snapshot.val()) : [];
                renderTenants();
                updateTenantDropdown();
                updateRentStatus();
            }).catch((error) => {
                console.error('Error loading tenants:', error);
                if (error.code === 'PERMISSION_DENIED') {
                    handlePermissionDenied('tenants');
                }
                tenants = JSON.parse(localStorage.getItem('tenants')) || [];
                renderTenants();
                updateTenantDropdown();
            });

            database.ref('payments').once('value', (snapshot) => {
                payments = snapshot.val() ? Object.values(snapshot.val()) : [];
                renderPayments();
                updateRentStatus();
            }).catch((error) => {
                console.error('Error loading payments:', error);
                if (error.code === 'PERMISSION_DENIED') {
                    handlePermissionDenied('payments');
                }
                payments = JSON.parse(localStorage.getItem('payments')) || [];
                renderPayments();
            });

            database.ref('insuranceClaims').once('value', (snapshot) => {
                insuranceClaims = snapshot.val() ? Object.values(snapshot.val()) : [];
                renderInsuranceClaims();
                updateClaimsStats();
            }).catch((error) => {
                console.error('Error loading insurance claims:', error);
                if (error.code === 'PERMISSION_DENIED') {
                    handlePermissionDenied('insuranceClaims');
                }
                insuranceClaims = JSON.parse(localStorage.getItem('insuranceClaims')) || [];
                renderInsuranceClaims();
            });

            database.ref('preventiveMaintenance').once('value', (snapshot) => {
                preventiveMaintenance = snapshot.val() ? Object.values(snapshot.val()) : [];
                renderPMSchedules();
                updatePMStats();
            }).catch((error) => {
                console.error('Error loading preventive maintenance:', error);
                if (error.code === 'PERMISSION_DENIED') {
                    handlePermissionDenied('preventiveMaintenance');
                }
                preventiveMaintenance = JSON.parse(localStorage.getItem('preventiveMaintenance')) || [];
                renderPMSchedules();
            });

            database.ref('pmCompletionHistory').once('value', (snapshot) => {
                pmCompletionHistory = snapshot.val() ? Object.values(snapshot.val()) : [];
            }).catch((error) => {
                console.error('Error loading PM history:', error);
                pmCompletionHistory = JSON.parse(localStorage.getItem('pmCompletionHistory')) || [];
            });

            database.ref('settings').once('value', (snapshot) => {
                if (snapshot.val()) {
                    settings = snapshot.val();
                    loadSettings();
                }
            }).catch((error) => {
                console.error('Error loading settings:', error);
            });
        }

        // Handle permission denied errors
        function handlePermissionDenied(dataType) {
            const message = `‚ö†Ô∏è FIREBASE PERMISSION DENIED for ${dataType}

Your data is SAFE in browser localStorage!

WHAT HAPPENED:
Firebase database rules changed or expired.

YOUR DATA IS NOT LOST:
‚úÖ All data backed up in browser
‚úÖ Currently loading from local backup
‚úÖ You can still add/edit/delete
‚úÖ Changes save locally

TO FIX:
1. Go to Settings tab
2. Update Firebase Security Rules (see FIREBASE_SECURITY_RULES.md)
3. Or continue using localStorage only

IMPORTANT:
- Data shows from localStorage backup
- New changes save locally
- Once Firebase rules fixed, sync resumes`;

            console.warn(message);
            
            // Show user-friendly alert only once
            if (!window.permissionDeniedShown) {
                window.permissionDeniedShown = true;
                alert('‚ö†Ô∏è Firebase Connection Issue\n\nYour data is SAFE in browser backup.\nCurrently running in LOCAL MODE.\n\nSee console (F12) for details or check Settings tab to fix Firebase rules.');
            }
        }

        // Setup real-time listeners
        function setupFirebaseListeners() {
            database.ref('maintenance').on('value', (snapshot) => {
                maintenance = snapshot.val() ? Object.values(snapshot.val()) : [];
                renderMaintenance();
                updateDashboard();
                renderUpcomingReminders();
            });

            database.ref('equipment').on('value', (snapshot) => {
                equipment = snapshot.val() ? Object.values(snapshot.val()) : [];
                renderEquipment();
            });

            database.ref('tenants').on('value', (snapshot) => {
                tenants = snapshot.val() ? Object.values(snapshot.val()) : [];
                renderTenants();
                updateTenantDropdown();
                updateRentStatus();
            });

            database.ref('payments').on('value', (snapshot) => {
                payments = snapshot.val() ? Object.values(snapshot.val()) : [];
                renderPayments();
                updateRentStatus();
            });

            database.ref('insuranceClaims').on('value', (snapshot) => {
                insuranceClaims = snapshot.val() ? Object.values(snapshot.val()) : [];
                renderInsuranceClaims();
                renderEquipment(); // Re-render to update claim status
                updateClaimsStats();
            });

            database.ref('preventiveMaintenance').on('value', (snapshot) => {
                preventiveMaintenance = snapshot.val() ? Object.values(snapshot.val()) : [];
                renderPMSchedules();
                updatePMStats();
            });
        }

        // Save data to Firebase or localStorage
        function saveData(dataType, data) {
            if (isFirebaseConnected && database) {
                // Save to Firebase
                database.ref(dataType).set(data).catch((error) => {
                    console.error('Firebase save error:', error);
                    // Fallback to localStorage
                    localStorage.setItem(dataType, JSON.stringify(data));
                });
            } else {
                // Save to localStorage
                localStorage.setItem(dataType, JSON.stringify(data));
            }
        }

        // Update connection status
        function updateConnectionStatus(status) {
            const statusDiv = document.getElementById('connectionStatus');
            switch(status) {
                case 'connected':
                    statusDiv.innerHTML = '‚úÖ Connected to Cloud';
                    statusDiv.style.background = '#4caf50';
                    statusDiv.style.color = 'white';
                    break;
                case 'error':
                    statusDiv.innerHTML = '‚ùå Connection Error - Using Local Storage';
                    statusDiv.style.background = '#f44336';
                    statusDiv.style.color = 'white';
                    break;
                case 'not-configured':
                    statusDiv.innerHTML = '‚ö†Ô∏è Cloud Not Configured - Using Local Storage';
                    statusDiv.style.background = '#ff9800';
                    statusDiv.style.color = 'white';
                    break;
                default:
                    statusDiv.innerHTML = 'üîÑ Connecting...';
                    statusDiv.style.background = '#ffc107';
                    statusDiv.style.color = '#000';
            }
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            // Check if user is already logged in
            if (checkSession()) {
                initializeApp();
            }
        });

        function initializeApp() {
            initializeFirebase();
            loadSettings();
            updateDashboard();
            renderMaintenance();
            renderEquipment();
            renderTenants();
            updateRentStatus();
            renderPayments();
            renderInsuranceClaims();
            renderPMSchedules();
            updateClaimsStats();
            updatePMStats();
            updateTenantDropdown();
            updateEquipmentDropdown();
            updateClaimEquipmentDropdown();
            updatePMEquipmentDropdown();
            checkReminders();
            checkEquipmentReminders();
            checkLeaseExpiry();
            checkRentEscalations();
            renderLeaseExpiryWarnings();
            renderRentEscalationWarnings();
            renderUpcomingReminders();
            loadFirebaseConfigForm();
            
            // Set today's date as default
            const today = new Date().toISOString().split('T')[0];
            const maintDate = document.getElementById('maintDate');
            const rentDate = document.getElementById('rentDate');
            const claimIncidentDate = document.getElementById('claimIncidentDate');
            const claimFiledDate = document.getElementById('claimFiledDate');
            if (maintDate) maintDate.value = today;
            if (rentDate) rentDate.value = today;
            if (claimFiledDate) claimFiledDate.value = today;

            // Check reminders every minute
            setInterval(checkReminders, 60000);
            // Check lease expiry every hour
            setInterval(() => {
                checkLeaseExpiry();
                renderLeaseExpiryWarnings();
            }, 3600000);
        }

        // Tab Switching
        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(tabName).classList.add('active');
        }

        // Maintenance Functions
        function addMaintenance() {
            const task = {
                id: Date.now(),
                property: document.getElementById('maintProperty').value,
                type: document.getElementById('maintType').value,
                priority: document.getElementById('maintPriority').value,
                status: document.getElementById('maintStatus').value,
                date: document.getElementById('maintDate').value,
                assigned: document.getElementById('maintAssigned').value,
                insured: document.getElementById('maintInsured').value,
                cost: parseFloat(document.getElementById('maintCost').value) || 0,
                description: document.getElementById('maintDescription').value,
                notes: document.getElementById('maintNotes').value,
                reminder: document.getElementById('maintReminder').value,
                equipmentId: document.getElementById('maintEquipment').value || null,
                reminderSent: false,
                createdAt: new Date().toISOString()
            };

            if (!task.property || !task.description) {
                alert('Please fill in property and description');
                return;
            }

            maintenance.push(task);
            saveData('maintenance', maintenance);
            renderMaintenance();
            updateDashboard();
            renderUpcomingReminders();
            clearMaintenanceForm();
        }

        function clearMaintenanceForm() {
            document.getElementById('maintProperty').value = '';
            document.getElementById('maintType').value = 'Plumbing';
            document.getElementById('maintPriority').value = 'Low';
            document.getElementById('maintStatus').value = 'Pending';
            document.getElementById('maintAssigned').value = '';
            document.getElementById('maintCost').value = '';
            document.getElementById('maintDescription').value = '';
            document.getElementById('maintNotes').value = '';
            document.getElementById('maintReminder').value = '';
            document.getElementById('maintEquipment').value = '';
        }

        function renderMaintenance() {
            const list = document.getElementById('maintenanceList');
            
            // Show ALL maintenance tasks (including completed) for data recovery
            // Filter can be added back later after confirming data is safe
            
            if (maintenance.length === 0) {
                list.innerHTML = '<tr><td colspan="11" style="text-align: center; padding: 40px; color: #6c757d;">No maintenance tasks yet. Add your first task above!</td></tr>';
                return;
            }

            list.innerHTML = maintenance.map(task => {
                const reminderDisplay = task.reminder ? 
                    new Date(task.reminder).toLocaleString('en-US', {
                        month: 'short',
                        day: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                    }) : 'None';
                
                const whatsappBtn = task.reminder && settings.adminPhone ? 
                    `<button class="btn btn-whatsapp" onclick="sendWhatsAppReminder(${task.id})" title="Send WhatsApp reminder">
                        <span>üì±</span> Send
                    </button>` : '';

                return `
                <tr>
                    <td>${task.property}</td>
                    <td>${task.type}</td>
                    <td>${task.description.substring(0, 50)}${task.description.length > 50 ? '...' : ''}</td>
                    <td><span class="badge badge-${getPriorityColor(task.priority)}">${task.priority}</span></td>
                    <td><span class="badge badge-${getStatusColor(task.status)}">${task.status}</span></td>
                    <td>${task.date}</td>
                    <td>${reminderDisplay}</td>
                    <td>${task.assigned || 'Unassigned'}</td>
                    <td>${task.insured}</td>
                    <td>KES ${task.cost.toFixed(2)}</td>
                    <td>
                        <div class="action-buttons">
                            ${whatsappBtn}
                            <button class="btn btn-warning" onclick="editMaintenance(${task.id})">Edit</button>
                            <button class="btn btn-danger" onclick="deleteMaintenance(${task.id})">Delete</button>
                        </div>
                    </td>
                </tr>
            `;
            }).join('');
        }

        function editMaintenance(id) {
            const task = maintenance.find(t => t.id === id);
            if (!task) return;

            // Populate form with existing data
            document.getElementById('maintProperty').value = task.property;
            document.getElementById('maintType').value = task.type;
            document.getElementById('maintPriority').value = task.priority;
            document.getElementById('maintStatus').value = task.status;
            document.getElementById('maintDate').value = task.date;
            document.getElementById('maintAssigned').value = task.assigned;
            document.getElementById('maintInsured').value = task.insured;
            document.getElementById('maintCost').value = task.cost;
            document.getElementById('maintDescription').value = task.description;
            document.getElementById('maintNotes').value = task.notes;
            document.getElementById('maintReminder').value = task.reminder || '';
            document.getElementById('maintEquipment').value = task.equipmentId || '';

            // Change button to Update mode
            const addButton = document.querySelector('#maintenance .btn-primary');
            addButton.textContent = 'Update Maintenance Task';
            addButton.onclick = () => updateMaintenance(id);

            // Scroll to form
            document.querySelector('#maintenance .form-section').scrollIntoView({ behavior: 'smooth' });
        }

        function updateMaintenance(id) {
            const taskIndex = maintenance.findIndex(t => t.id === id);
            if (taskIndex === -1) return;

            maintenance[taskIndex] = {
                ...maintenance[taskIndex],
                property: document.getElementById('maintProperty').value,
                type: document.getElementById('maintType').value,
                priority: document.getElementById('maintPriority').value,
                status: document.getElementById('maintStatus').value,
                date: document.getElementById('maintDate').value,
                assigned: document.getElementById('maintAssigned').value,
                insured: document.getElementById('maintInsured').value,
                cost: parseFloat(document.getElementById('maintCost').value) || 0,
                description: document.getElementById('maintDescription').value,
                notes: document.getElementById('maintNotes').value,
                reminder: document.getElementById('maintReminder').value,
                equipmentId: document.getElementById('maintEquipment').value || null
            };

            saveData('maintenance', maintenance);
            renderMaintenance();
            updateDashboard();
            renderUpcomingReminders();
            clearMaintenanceForm();
            
            // Reset button to Add mode
            const addButton = document.querySelector('#maintenance .btn-primary');
            addButton.textContent = 'Add Maintenance Task';
            addButton.onclick = addMaintenance;
        }

        function deleteMaintenance(id) {
            if (confirm('Are you sure you want to delete this maintenance task?')) {
                maintenance = maintenance.filter(task => task.id !== id);
                saveData('maintenance', maintenance);
                renderMaintenance();
                updateDashboard();
            }
        }

        function filterMaintenance() {
            const search = document.getElementById('maintSearch').value.toLowerCase();
            const filtered = maintenance.filter(task => 
                task.property.toLowerCase().includes(search) ||
                task.type.toLowerCase().includes(search) ||
                task.description.toLowerCase().includes(search) ||
                task.assigned.toLowerCase().includes(search)
            );
            
            const list = document.getElementById('maintenanceList');
            list.innerHTML = filtered.map(task => {
                const reminderDisplay = task.reminder ? 
                    new Date(task.reminder).toLocaleString('en-US', {
                        month: 'short',
                        day: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                    }) : 'None';
                
                const whatsappBtn = task.reminder && settings.adminPhone ? 
                    `<button class="btn btn-whatsapp" onclick="sendWhatsAppReminder(${task.id})" title="Send WhatsApp reminder">
                        <span>üì±</span> Send
                    </button>` : '';

                return `
                <tr>
                    <td>${task.property}</td>
                    <td>${task.type}</td>
                    <td>${task.description.substring(0, 50)}${task.description.length > 50 ? '...' : ''}</td>
                    <td><span class="badge badge-${getPriorityColor(task.priority)}">${task.priority}</span></td>
                    <td><span class="badge badge-${getStatusColor(task.status)}">${task.status}</span></td>
                    <td>${task.date}</td>
                    <td>${reminderDisplay}</td>
                    <td>${task.assigned || 'Unassigned'}</td>
                    <td>${task.insured}</td>
                    <td>KES ${task.cost.toFixed(2)}</td>
                    <td>
                        <div class="action-buttons">
                            ${whatsappBtn}
                            <button class="btn btn-danger" onclick="deleteMaintenance(${task.id})">Delete</button>
                        </div>
                    </td>
                </tr>
            `;
            }).join('');
        }

        // Equipment Functions
        function addEquipment() {
            const totalQty = parseInt(document.getElementById('equipQuantity').value) || 0;
            const workingQty = parseInt(document.getElementById('equipWorkingQty').value) || 0;
            
            const item = {
                id: Date.now(),
                name: document.getElementById('equipName').value,
                category: document.getElementById('equipCategory').value,
                floor: document.getElementById('equipFloor').value,
                section: document.getElementById('equipSection').value,
                location: document.getElementById('equipLocation').value,
                quantity: totalQty,
                workingQty: workingQty,
                needsReplacement: Math.max(0, totalQty - workingQty),
                insured: document.getElementById('equipInsured').value,
                insuranceCompany: document.getElementById('equipInsuranceCompany').value,
                serviceContract: document.getElementById('equipServiceContract').value,
                serviceProvider: document.getElementById('equipServiceProvider').value,
                contractExpiry: document.getElementById('equipContractExpiry').value,
                model: document.getElementById('equipModel').value,
                serial: document.getElementById('equipSerial').value,
                installDate: document.getElementById('equipInstall').value,
                lastService: document.getElementById('equipLastService').value,
                nextService: document.getElementById('equipNextService').value,
                warranty: document.getElementById('equipWarranty').value,
                status: document.getElementById('equipStatus').value,
                serviceRecords: document.getElementById('equipServiceRecords').value,
                notes: document.getElementById('equipNotes').value
            };

            if (!item.name) {
                alert('Please fill in equipment name');
                return;
            }

            equipment.push(item);
            saveData('equipment', equipment);
            updateEquipmentDropdown();
            updateClaimEquipmentDropdown();
            updatePMEquipmentDropdown();
            renderEquipment();
            clearEquipmentForm();
            checkEquipmentReminders(); // Check if any items need attention
        }

        function updateReplacementCalculation() {
            const total = parseInt(document.getElementById('equipQuantity').value) || 0;
            const working = parseInt(document.getElementById('equipWorkingQty').value) || 0;
            const needsReplacement = Math.max(0, total - working);
            document.getElementById('equipNeedsReplacement').textContent = needsReplacement;
            
            if (needsReplacement > 0) {
                document.getElementById('equipNeedsReplacement').style.color = '#dc3545';
            } else {
                document.getElementById('equipNeedsReplacement').style.color = '#28a745';
            }
        }

        function clearEquipmentForm() {
            document.getElementById('equipName').value = '';
            document.getElementById('equipCategory').value = 'HVAC';
            document.getElementById('equipFloor').value = '';
            document.getElementById('equipSection').value = '';
            document.getElementById('equipLocation').value = '';
            document.getElementById('equipQuantity').value = '1';
            document.getElementById('equipWorkingQty').value = '1';
            document.getElementById('equipNeedsReplacement').textContent = '0';
            document.getElementById('equipInsured').value = 'No';
            document.getElementById('equipInsuranceCompany').value = '';
            document.getElementById('equipServiceContract').value = 'None';
            document.getElementById('equipServiceProvider').value = '';
            document.getElementById('equipContractExpiry').value = '';
            document.getElementById('equipModel').value = '';
            document.getElementById('equipSerial').value = '';
            document.getElementById('equipInstall').value = '';
            document.getElementById('equipLastService').value = '';
            document.getElementById('equipNextService').value = '';
            document.getElementById('equipWarranty').value = '';
            document.getElementById('equipServiceRecords').value = '';
            document.getElementById('equipNotes').value = '';
        }

        function renderEquipment() {
            const list = document.getElementById('equipmentList');
            if (equipment.length === 0) {
                list.innerHTML = '<tr><td colspan="9" style="text-align: center; padding: 40px; color: #6c757d;">No equipment registered yet. Add your first equipment above!</td></tr>';
                return;
            }

            list.innerHTML = equipment.map(item => {
                const claimInfo = getEquipmentClaimStatus(item.id);
                let claimBadge = '<span class="badge badge-secondary">No Claim</span>';
                
                if (claimInfo) {
                    if (claimInfo.status === 'Pending') {
                        claimBadge = `<span class="badge badge-warning">‚è≥ Pending</span>
                                     <br><small style="color: #666;">KES ${claimInfo.claim.claimAmount.toFixed(2)}</small>`;
                    } else if (claimInfo.status === 'Cleared') {
                        claimBadge = `<span class="badge badge-success">‚úÖ Cleared</span>
                                     <br><small style="color: #666;">KES ${(claimInfo.claim.approvedAmount || claimInfo.claim.claimAmount).toFixed(2)}</small>`;
                    }
                }
                
                return `
                <tr>
                    <td>${item.name}</td>
                    <td>${item.category}</td>
                    <td>${item.floor || 'N/A'}</td>
                    <td>${item.section || 'N/A'}</td>
                    <td>${item.location || 'N/A'}</td>
                    <td>${item.quantity || 1}</td>
                    <td><span class="badge badge-${getEquipStatusColor(item.status)}">${item.status}</span></td>
                    <td>${claimBadge}</td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn btn-warning" onclick="editEquipment(${item.id})">Edit</button>
                            <button class="btn btn-danger" onclick="deleteEquipment(${item.id})">Delete</button>
                        </div>
                    </td>
                </tr>
            `;
            }).join('');
        }

        function editEquipment(id) {
            const item = equipment.find(e => e.id === id);
            if (!item) return;

            // Populate form
            document.getElementById('equipName').value = item.name;
            document.getElementById('equipCategory').value = item.category;
            document.getElementById('equipFloor').value = item.floor || '';
            document.getElementById('equipSection').value = item.section || '';
            document.getElementById('equipLocation').value = item.location || '';
            document.getElementById('equipQuantity').value = item.quantity || 1;
            document.getElementById('equipWorkingQty').value = item.workingQty || 1;
            document.getElementById('equipNeedsReplacement').textContent = item.needsReplacement || 0;
            document.getElementById('equipInsured').value = item.insured || 'No';
            document.getElementById('equipInsuranceCompany').value = item.insuranceCompany || '';
            document.getElementById('equipServiceContract').value = item.serviceContract || 'None';
            document.getElementById('equipServiceProvider').value = item.serviceProvider || '';
            document.getElementById('equipContractExpiry').value = item.contractExpiry || '';
            document.getElementById('equipModel').value = item.model || '';
            document.getElementById('equipSerial').value = item.serial || '';
            document.getElementById('equipInstall').value = item.installDate || '';
            document.getElementById('equipLastService').value = item.lastService || '';
            document.getElementById('equipNextService').value = item.nextService || '';
            document.getElementById('equipWarranty').value = item.warranty || '';
            document.getElementById('equipStatus').value = item.status;
            document.getElementById('equipServiceRecords').value = item.serviceRecords || '';
            document.getElementById('equipNotes').value = item.notes || '';

            // Change button to Update mode
            const addButton = document.querySelector('#equipment .btn-primary');
            addButton.textContent = 'Update Equipment';
            addButton.onclick = () => updateEquipment(id);

            // Scroll to form
            document.querySelector('#equipment .form-section').scrollIntoView({ behavior: 'smooth' });
        }

        function updateEquipment(id) {
            const itemIndex = equipment.findIndex(e => e.id === id);
            if (itemIndex === -1) return;

            const totalQty = parseInt(document.getElementById('equipQuantity').value) || 0;
            const workingQty = parseInt(document.getElementById('equipWorkingQty').value) || 0;

            equipment[itemIndex] = {
                ...equipment[itemIndex],
                name: document.getElementById('equipName').value,
                category: document.getElementById('equipCategory').value,
                floor: document.getElementById('equipFloor').value,
                section: document.getElementById('equipSection').value,
                location: document.getElementById('equipLocation').value,
                quantity: totalQty,
                workingQty: workingQty,
                needsReplacement: Math.max(0, totalQty - workingQty),
                insured: document.getElementById('equipInsured').value,
                insuranceCompany: document.getElementById('equipInsuranceCompany').value,
                serviceContract: document.getElementById('equipServiceContract').value,
                serviceProvider: document.getElementById('equipServiceProvider').value,
                contractExpiry: document.getElementById('equipContractExpiry').value,
                model: document.getElementById('equipModel').value,
                serial: document.getElementById('equipSerial').value,
                installDate: document.getElementById('equipInstall').value,
                lastService: document.getElementById('equipLastService').value,
                nextService: document.getElementById('equipNextService').value,
                warranty: document.getElementById('equipWarranty').value,
                status: document.getElementById('equipStatus').value,
                serviceRecords: document.getElementById('equipServiceRecords').value,
                notes: document.getElementById('equipNotes').value
            };

            saveData('equipment', equipment);
            updateEquipmentDropdown();
            updateClaimEquipmentDropdown();
            updatePMEquipmentDropdown();
            renderEquipment();
            clearEquipmentForm();
            checkEquipmentReminders();
            
            // Reset button
            const addButton = document.querySelector('#equipment .btn-primary');
            addButton.textContent = 'Add Equipment';
            addButton.onclick = addEquipment;
        }

        function deleteEquipment(id) {
            if (confirm('Are you sure you want to delete this equipment?')) {
                equipment = equipment.filter(item => item.id !== id);
                saveData('equipment', equipment);
                updateEquipmentDropdown();
                updateClaimEquipmentDropdown();
                updatePMEquipmentDropdown();
                renderEquipment();
            }
        }

        function filterEquipment() {
            const search = document.getElementById('equipSearch').value.toLowerCase();
            const filtered = equipment.filter(item => 
                item.name.toLowerCase().includes(search) ||
                item.location.toLowerCase().includes(search) ||
                item.category.toLowerCase().includes(search) ||
                (item.model && item.model.toLowerCase().includes(search))
            );
            
            const list = document.getElementById('equipmentList');
            list.innerHTML = filtered.map(item => `
                <tr>
                    <td>${item.name}</td>
                    <td>${item.location}</td>
                    <td>${item.category}</td>
                    <td>${item.model || 'N/A'}</td>
                    <td>${item.installDate || 'N/A'}</td>
                    <td>${item.lastService || 'N/A'}</td>
                    <td>${item.nextService || 'N/A'}</td>
                    <td><span class="badge badge-${getEquipStatusColor(item.status)}">${item.status}</span></td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn btn-danger" onclick="deleteEquipment(${item.id})">Delete</button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        // Tenant Functions
        function addTenant() {
            const tenant = {
                id: Date.now(),
                name: document.getElementById('tenantName').value,
                unit: document.getElementById('tenantUnit').value,
                email: document.getElementById('tenantEmail').value,
                phone: document.getElementById('tenantPhone').value,
                leaseStart: document.getElementById('tenantLeaseStart').value,
                leaseEnd: document.getElementById('tenantLeaseEnd').value,
                rent: parseFloat(document.getElementById('tenantRent').value) || 0,
                serviceCharge: parseFloat(document.getElementById('tenantServiceCharge').value) || 0,
                vat: parseFloat(document.getElementById('tenantVAT').value) || 0,
                waterRate: parseFloat(document.getElementById('tenantWaterRate').value) || 0,
                electricityRate: parseFloat(document.getElementById('tenantElectricityRate').value) || 0,
                deposit: parseFloat(document.getElementById('tenantDeposit').value) || 0,
                escalation: document.getElementById('tenantEscalation').value,
                escalationRate: parseFloat(document.getElementById('tenantEscalationRate').value) || 0,
                nextEscalationDate: document.getElementById('tenantNextEscalation').value,
                lastEscalationDate: document.getElementById('tenantLastEscalation').value,
                originalRent: parseFloat(document.getElementById('tenantRent').value) || 0,
                escalationHistory: [],
                status: document.getElementById('tenantStatus').value,
                notes: document.getElementById('tenantNotes').value
            };

            if (!tenant.name || !tenant.unit) {
                alert('Please fill in tenant name and unit');
                return;
            }

            tenants.push(tenant);
            saveData('tenants', tenants);
            renderTenants();
            renderLeaseExpiryWarnings();
            renderRentEscalationWarnings();
            updateDashboard();
            updateTenantDropdown();
            updateRentStatus();
            clearTenantForm();
        }

        function clearTenantForm() {
            document.getElementById('tenantName').value = '';
            document.getElementById('tenantUnit').value = '';
            document.getElementById('tenantEmail').value = '';
            document.getElementById('tenantPhone').value = '';
            document.getElementById('tenantLeaseStart').value = '';
            document.getElementById('tenantLeaseEnd').value = '';
            document.getElementById('tenantRent').value = '';
            document.getElementById('tenantServiceCharge').value = '';
            document.getElementById('tenantVAT').value = '16';
            document.getElementById('tenantWaterRate').value = '';
            document.getElementById('tenantElectricityRate').value = '';
            document.getElementById('tenantDeposit').value = '';
            document.getElementById('tenantNotes').value = '';
        }

        function renderTenants() {
            const list = document.getElementById('tenantsList');
            if (tenants.length === 0) {
                list.innerHTML = '<tr><td colspan="11" style="text-align: center; padding: 40px; color: #6c757d;">No tenants registered yet. Add your first tenant above!</td></tr>';
                return;
            }

            const today = new Date();

            list.innerHTML = tenants.map(tenant => {
                let leaseExpiryBadge = '<span class="badge badge-secondary">N/A</span>';
                
                if (tenant.leaseEnd) {
                    const leaseEndDate = new Date(tenant.leaseEnd);
                    const daysUntilExpiry = Math.floor((leaseEndDate - today) / (1000 * 60 * 60 * 24));
                    const monthsUntilExpiry = Math.floor(daysUntilExpiry / 30);
                    
                    if (daysUntilExpiry < 0) {
                        // Expired
                        leaseExpiryBadge = `<span class="badge badge-danger">‚ö†Ô∏è Expired</span><br><small style="color: #dc3545;">${Math.abs(daysUntilExpiry)} days ago</small>`;
                    } else if (daysUntilExpiry <= 30) {
                        // Less than 1 month
                        leaseExpiryBadge = `<span class="badge badge-danger">üî¥ ${daysUntilExpiry} days</span><br><small style="color: #dc3545;">Urgent!</small>`;
                    } else if (daysUntilExpiry <= 60) {
                        // 1-2 months
                        leaseExpiryBadge = `<span class="badge badge-warning">üü° ${daysUntilExpiry} days</span><br><small style="color: #856404;">~${monthsUntilExpiry} month(s)</small>`;
                    } else if (daysUntilExpiry <= 90) {
                        // 2-3 months - Warning period
                        leaseExpiryBadge = `<span class="badge badge-warning">‚ö†Ô∏è ${daysUntilExpiry} days</span><br><small style="color: #856404;">~3 months</small>`;
                    } else {
                        // More than 3 months
                        leaseExpiryBadge = `<span class="badge badge-success">‚úÖ ${daysUntilExpiry} days</span><br><small style="color: #28a745;">~${monthsUntilExpiry} months</small>`;
                    }
                }
                
                // Rent Escalation Badge
                let escalationBadge = '<span class="badge badge-secondary">None</span>';
                if (tenant.escalation && tenant.escalation !== 'None' && tenant.nextEscalationDate) {
                    const escalationDate = new Date(tenant.nextEscalationDate);
                    const daysUntilEscalation = Math.floor((escalationDate - today) / (1000 * 60 * 60 * 24));
                    const newRent = calculateNewRent(tenant.rent, tenant.escalationRate || 0);
                    
                    if (daysUntilEscalation < 0) {
                        escalationBadge = `<span class="badge badge-danger">‚ö†Ô∏è Overdue</span><br><small style="color: #dc3545;">${tenant.escalation} (+${tenant.escalationRate}%)</small>`;
                    } else if (daysUntilEscalation <= 7) {
                        escalationBadge = `<span class="badge badge-danger">üî¥ ${daysUntilEscalation}d</span><br><small style="color: #dc3545;">${tenant.escalation} ‚Üí KES ${newRent.toFixed(0)}</small>`;
                    } else if (daysUntilEscalation <= 30) {
                        escalationBadge = `<span class="badge badge-warning">üü° ${daysUntilEscalation}d</span><br><small style="color: #856404;">${tenant.escalation} (+${tenant.escalationRate}%)</small>`;
                    } else {
                        escalationBadge = `<span class="badge badge-info">${tenant.escalation}</span><br><small>+${tenant.escalationRate}% in ${daysUntilEscalation}d</small>`;
                    }
                }
                
                return `
                <tr>
                    <td>${tenant.name}</td>
                    <td>${tenant.unit}</td>
                    <td>${tenant.email || 'N/A'}</td>
                    <td>${tenant.phone || 'N/A'}</td>
                    <td>${tenant.leaseStart || 'N/A'}</td>
                    <td>${tenant.leaseEnd || 'N/A'}</td>
                    <td>${leaseExpiryBadge}</td>
                    <td>KES ${tenant.rent.toFixed(2)}</td>
                    <td>${escalationBadge}</td>
                    <td><span class="badge badge-${getTenantStatusColor(tenant.status)}">${tenant.status}</span></td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn btn-warning" onclick="editTenant(${tenant.id})">Edit</button>
                            <button class="btn btn-danger" onclick="deleteTenant(${tenant.id})">Delete</button>
                        </div>
                    </td>
                </tr>
            `;
            }).join('');
        }

        function editTenant(id) {
            const tenant = tenants.find(t => t.id === id);
            if (!tenant) return;

            // Populate form
            document.getElementById('tenantName').value = tenant.name;
            document.getElementById('tenantUnit').value = tenant.unit;
            document.getElementById('tenantEmail').value = tenant.email || '';
            document.getElementById('tenantPhone').value = tenant.phone || '';
            document.getElementById('tenantLeaseStart').value = tenant.leaseStart || '';
            document.getElementById('tenantLeaseEnd').value = tenant.leaseEnd || '';
            document.getElementById('tenantRent').value = tenant.rent;
            document.getElementById('tenantServiceCharge').value = tenant.serviceCharge || 0;
            document.getElementById('tenantVAT').value = tenant.vat || 16;
            document.getElementById('tenantWaterRate').value = tenant.waterRate || 0;
            document.getElementById('tenantElectricityRate').value = tenant.electricityRate || 0;
            document.getElementById('tenantDeposit').value = tenant.deposit;
            document.getElementById('tenantStatus').value = tenant.status;
            document.getElementById('tenantNotes').value = tenant.notes || '';

            // Change button to Update mode
            const addButton = document.querySelector('#tenants .btn-primary');
            addButton.textContent = 'Update Tenant';
            addButton.onclick = () => updateTenant(id);

            // Scroll to form
            document.querySelector('#tenants .form-section').scrollIntoView({ behavior: 'smooth' });
        }

        function updateTenant(id) {
            const tenantIndex = tenants.findIndex(t => t.id === id);
            if (tenantIndex === -1) return;

            tenants[tenantIndex] = {
                ...tenants[tenantIndex],
                name: document.getElementById('tenantName').value,
                unit: document.getElementById('tenantUnit').value,
                email: document.getElementById('tenantEmail').value,
                phone: document.getElementById('tenantPhone').value,
                leaseStart: document.getElementById('tenantLeaseStart').value,
                leaseEnd: document.getElementById('tenantLeaseEnd').value,
                rent: parseFloat(document.getElementById('tenantRent').value) || 0,
                serviceCharge: parseFloat(document.getElementById('tenantServiceCharge').value) || 0,
                vat: parseFloat(document.getElementById('tenantVAT').value) || 0,
                waterRate: parseFloat(document.getElementById('tenantWaterRate').value) || 0,
                electricityRate: parseFloat(document.getElementById('tenantElectricityRate').value) || 0,
                deposit: parseFloat(document.getElementById('tenantDeposit').value) || 0,
                status: document.getElementById('tenantStatus').value,
                notes: document.getElementById('tenantNotes').value
            };

            saveData('tenants', tenants);
            renderTenants();
            renderLeaseExpiryWarnings();
            updateDashboard();
            updateTenantDropdown();
            updateRentStatus();
            clearTenantForm();
            
            // Reset button
            const addButton = document.querySelector('#tenants .btn-primary');
            addButton.textContent = 'Add Tenant';
            addButton.onclick = addTenant;
        }

        function deleteTenant(id) {
            if (confirm('Are you sure you want to delete this tenant?')) {
                tenants = tenants.filter(tenant => tenant.id !== id);
                saveData('tenants', tenants);
                renderTenants();
                renderLeaseExpiryWarnings();
                updateDashboard();
                updateTenantDropdown();
                updateRentStatus();
            }
        }

        function filterTenants() {
            const search = document.getElementById('tenantSearch').value.toLowerCase();
            const filtered = tenants.filter(tenant => 
                tenant.name.toLowerCase().includes(search) ||
                tenant.unit.toLowerCase().includes(search) ||
                (tenant.email && tenant.email.toLowerCase().includes(search))
            );
            
            const list = document.getElementById('tenantsList');
            list.innerHTML = filtered.map(tenant => `
                <tr>
                    <td>${tenant.name}</td>
                    <td>${tenant.unit}</td>
                    <td>${tenant.email || 'N/A'}</td>
                    <td>${tenant.phone || 'N/A'}</td>
                    <td>${tenant.leaseStart || 'N/A'}</td>
                    <td>${tenant.leaseEnd || 'N/A'}</td>
                    <td>KES ${tenant.rent.toFixed(2)}</td>
                    <td><span class="badge badge-${getTenantStatusColor(tenant.status)}">${tenant.status}</span></td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn btn-danger" onclick="deleteTenant(${tenant.id})">Delete</button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        // Payment Functions
        function updateTenantDropdown() {
            const dropdown = document.getElementById('rentTenant');
            dropdown.innerHTML = '<option value="">Select Tenant</option>' + 
                tenants.map(tenant => `<option value="${tenant.id}">${tenant.name} - ${tenant.unit}</option>`).join('');
        }

        function updateEquipmentDropdown() {
            const dropdown = document.getElementById('maintEquipment');
            if (dropdown) {
                dropdown.innerHTML = '<option value="">Select Equipment (Optional)</option>' + 
                    equipment.map(item => {
                        const locationInfo = [item.floor, item.section, item.location].filter(Boolean).join(' - ') || 'Location N/A';
                        return `<option value="${item.id}">${item.name} (${locationInfo})</option>`;
                    }).join('');
            }
        }

        // Bill Calculation Function
        function calculateTotalBill() {
            const tenantId = parseInt(document.getElementById('rentTenant').value);
            if (!tenantId) {
                // Clear all bill displays
                document.getElementById('billRent').textContent = 'KES 0.00';
                document.getElementById('billServiceCharge').textContent = 'KES 0.00';
                document.getElementById('billWater').textContent = 'KES 0.00';
                document.getElementById('billElectricity').textContent = 'KES 0.00';
                document.getElementById('billSubtotal').textContent = 'KES 0.00';
                document.getElementById('billVAT').textContent = 'KES 0.00';
                document.getElementById('billVATPercent').textContent = '0';
                document.getElementById('billTotal').textContent = 'KES 0.00';
                document.getElementById('rentAmount').value = '';
                return;
            }

            const tenant = tenants.find(t => t.id === tenantId);
            if (!tenant) return;

            // Get utility units
            const waterUnits = parseFloat(document.getElementById('waterUnits').value) || 0;
            const electricityUnits = parseFloat(document.getElementById('electricityUnits').value) || 0;

            // Calculate charges
            const rent = tenant.rent || 0;
            const serviceCharge = tenant.serviceCharge || 0;
            const waterCharge = waterUnits * (tenant.waterRate || 0);
            const electricityCharge = electricityUnits * (tenant.electricityRate || 0);
            
            const subtotal = rent + serviceCharge + waterCharge + electricityCharge;
            const vatAmount = subtotal * ((tenant.vat || 0) / 100);
            const total = subtotal + vatAmount;

            // Update display
            document.getElementById('billRent').textContent = `KES ${rent.toFixed(2)}`;
            document.getElementById('billServiceCharge').textContent = `KES ${serviceCharge.toFixed(2)}`;
            document.getElementById('billWater').textContent = `KES ${waterCharge.toFixed(2)}`;
            document.getElementById('billElectricity').textContent = `KES ${electricityCharge.toFixed(2)}`;
            document.getElementById('billSubtotal').textContent = `KES ${subtotal.toFixed(2)}`;
            document.getElementById('billVATPercent').textContent = tenant.vat || 0;
            document.getElementById('billVAT').textContent = `KES ${vatAmount.toFixed(2)}`;
            document.getElementById('billTotal').textContent = `KES ${total.toFixed(2)}`;

            // Auto-fill amount
            document.getElementById('rentAmount').value = total.toFixed(2);
        }

        function addRentPayment() {
            const tenantId = parseInt(document.getElementById('rentTenant').value);
            const waterUnits = parseFloat(document.getElementById('waterUnits').value) || 0;
            const electricityUnits = parseFloat(document.getElementById('electricityUnits').value) || 0;

            const payment = {
                id: Date.now(),
                tenantId: tenantId,
                date: document.getElementById('rentDate').value,
                amount: parseFloat(document.getElementById('rentAmount').value) || 0,
                method: document.getElementById('rentMethod').value,
                period: document.getElementById('rentPeriod').value,
                waterUnits: waterUnits,
                electricityUnits: electricityUnits,
                notes: document.getElementById('rentNotes').value
            };

            if (!payment.tenantId || !payment.amount) {
                alert('Please select tenant and enter amount');
                return;
            }

            payments.push(payment);
            saveData('payments', payments);
            renderPayments();
            updateRentStatus();
            updateDashboard();
            clearPaymentForm();
        }

        function clearPaymentForm() {
            document.getElementById('rentTenant').value = '';
            document.getElementById('rentAmount').value = '';
            document.getElementById('rentPeriod').value = '';
            document.getElementById('waterUnits').value = '';
            document.getElementById('electricityUnits').value = '';
            document.getElementById('rentNotes').value = '';
            calculateTotalBill();
        }

        function renderPayments() {
            const list = document.getElementById('paymentsList');
            if (payments.length === 0) {
                list.innerHTML = '<tr><td colspan="8" style="text-align: center; padding: 40px; color: #6c757d;">No payments recorded yet. Record your first payment above!</td></tr>';
                return;
            }

            list.innerHTML = payments.map(payment => {
                const tenant = tenants.find(t => t.id === payment.tenantId);
                return `
                    <tr>
                        <td>${payment.date}</td>
                        <td>${tenant ? tenant.name : 'Unknown'}</td>
                        <td>${tenant ? tenant.unit : 'N/A'}</td>
                        <td>KES ${payment.amount.toFixed(2)}</td>
                        <td>${payment.method}</td>
                        <td>${payment.period || 'N/A'}</td>
                        <td>${payment.notes || '-'}</td>
                        <td>
                            <button class="btn btn-warning" onclick="editPayment(${payment.id})">Edit</button>
                            <button class="btn btn-danger" onclick="deletePayment(${payment.id})">Delete</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function editPayment(id) {
            const payment = payments.find(p => p.id === id);
            if (!payment) return;

            // Populate form
            document.getElementById('rentTenant').value = payment.tenantId;
            document.getElementById('rentDate').value = payment.date;
            document.getElementById('waterUnits').value = payment.waterUnits || 0;
            document.getElementById('electricityUnits').value = payment.electricityUnits || 0;
            document.getElementById('rentAmount').value = payment.amount;
            document.getElementById('rentMethod').value = payment.method;
            document.getElementById('rentPeriod').value = payment.period || '';
            document.getElementById('rentNotes').value = payment.notes || '';
            
            // Trigger bill calculation
            calculateTotalBill();

            // Change button to Update mode
            const addButton = document.querySelector('#rent .btn-primary');
            addButton.textContent = 'Update Payment';
            addButton.onclick = () => updatePayment(id);

            // Scroll to form
            document.querySelector('#rent .form-section').scrollIntoView({ behavior: 'smooth' });
        }

        function updatePayment(id) {
            const paymentIndex = payments.findIndex(p => p.id === id);
            if (paymentIndex === -1) return;

            const tenantId = parseInt(document.getElementById('rentTenant').value);
            if (!tenantId) {
                alert('Please select a tenant');
                return;
            }

            payments[paymentIndex] = {
                ...payments[paymentIndex],
                tenantId: tenantId,
                date: document.getElementById('rentDate').value,
                amount: parseFloat(document.getElementById('rentAmount').value) || 0,
                method: document.getElementById('rentMethod').value,
                period: document.getElementById('rentPeriod').value,
                waterUnits: parseFloat(document.getElementById('waterUnits').value) || 0,
                electricityUnits: parseFloat(document.getElementById('electricityUnits').value) || 0,
                notes: document.getElementById('rentNotes').value
            };

            saveData('payments', payments);
            renderPayments();
            updateRentStatus();
            updateDashboard();
            clearPaymentForm();
            
            // Reset button
            const addButton = document.querySelector('#rent .btn-primary');
            addButton.textContent = 'Record Payment';
            addButton.onclick = addRentPayment;
        }

        function deletePayment(id) {
            if (confirm('Are you sure you want to delete this payment?')) {
                payments = payments.filter(payment => payment.id !== id);
                saveData('payments', payments);
                renderPayments();
                updateRentStatus();
                updateDashboard();
            }
        }

        function filterPayments() {
            const search = document.getElementById('paymentSearch').value.toLowerCase();
            const filtered = payments.filter(payment => {
                const tenant = tenants.find(t => t.id === payment.tenantId);
                return (tenant && tenant.name.toLowerCase().includes(search)) ||
                       (tenant && tenant.unit.toLowerCase().includes(search)) ||
                       payment.method.toLowerCase().includes(search);
            });
            
            const list = document.getElementById('paymentsList');
            list.innerHTML = filtered.map(payment => {
                const tenant = tenants.find(t => t.id === payment.tenantId);
                return `
                    <tr>
                        <td>${payment.date}</td>
                        <td>${tenant ? tenant.name : 'Unknown'}</td>
                        <td>${tenant ? tenant.unit : 'N/A'}</td>
                        <td>KES ${payment.amount.toFixed(2)}</td>
                        <td>${payment.method}</td>
                        <td>${payment.period || 'N/A'}</td>
                        <td>${payment.notes || '-'}</td>
                        <td>
                            <button class="btn btn-danger" onclick="deletePayment(${payment.id})">Delete</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function updateRentStatus() {
            const list = document.getElementById('rentStatusList');
            if (tenants.length === 0) {
                list.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 40px; color: #6c757d;">No tenants to display rent status.</td></tr>';
                return;
            }

            list.innerHTML = tenants.map(tenant => {
                const tenantPayments = payments.filter(p => p.tenantId === tenant.id);
                const totalPaid = tenantPayments.reduce((sum, p) => sum + p.amount, 0);
                const lastPayment = tenantPayments.length > 0 ? 
                    tenantPayments.sort((a, b) => new Date(b.date) - new Date(a.date))[0].date : 'Never';
                
                // Calculate months since lease start
                const leaseStart = new Date(tenant.leaseStart);
                const now = new Date();
                const monthsDiff = (now.getFullYear() - leaseStart.getFullYear()) * 12 + 
                                   (now.getMonth() - leaseStart.getMonth());
                const expectedTotal = tenant.rent * Math.max(0, monthsDiff);
                const arrears = Math.max(0, expectedTotal - totalPaid);

                return `
                    <tr>
                        <td>${tenant.name}</td>
                        <td>${tenant.unit}</td>
                        <td>KES ${tenant.rent.toFixed(2)}</td>
                        <td>${lastPayment}</td>
                        <td>KES ${arrears.toFixed(2)}</td>
                        <td><span class="badge badge-${arrears > 0 ? 'danger' : 'success'}">${arrears > 0 ? 'Outstanding' : 'Current'}</span></td>
                        <td>
                            <button class="btn btn-warning" onclick="viewTenantDetails(${tenant.id})">View Details</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function viewTenantDetails(id) {
            const tenant = tenants.find(t => t.id === id);
            const tenantPayments = payments.filter(p => p.tenantId === id);
            alert(`Tenant: ${tenant.name}\nUnit: ${tenant.unit}\nMonthly Rent: KES ${tenant.rent}\nTotal Payments: ${tenantPayments.length}\nTotal Paid: KES ${tenantPayments.reduce((sum, p) => sum + p.amount, 0).toFixed(2)}`);
        }

        // Dashboard
        function updateDashboard() {
            const uniqueProperties = [...new Set(maintenance.map(m => m.property))].length;
            const activeTenants = tenants.filter(t => t.status === 'Active').length;
            const pendingMaint = maintenance.filter(m => m.status === 'Pending').length;
            
            let totalArrears = 0;
            tenants.forEach(tenant => {
                const tenantPayments = payments.filter(p => p.tenantId === tenant.id);
                const totalPaid = tenantPayments.reduce((sum, p) => sum + p.amount, 0);
                const leaseStart = new Date(tenant.leaseStart);
                const now = new Date();
                const monthsDiff = (now.getFullYear() - leaseStart.getFullYear()) * 12 + 
                                   (now.getMonth() - leaseStart.getMonth());
                const expectedTotal = tenant.rent * Math.max(0, monthsDiff);
                totalArrears += Math.max(0, expectedTotal - totalPaid);
            });

            document.getElementById('totalProperties').textContent = uniqueProperties;
            document.getElementById('totalTenants').textContent = activeTenants;
            document.getElementById('pendingMaintenance').textContent = pendingMaint;
            document.getElementById('totalArrears').textContent = 'KES ' + totalArrears.toFixed(2);

            // Recent Activity
            const activity = document.getElementById('recentActivity');
            const recentItems = [
                ...maintenance.slice(-5).map(m => ({date: m.createdAt, text: `Maintenance: ${m.description.substring(0, 50)}...`})),
                ...payments.slice(-5).map(p => {
                    const tenant = tenants.find(t => t.id === p.tenantId);
                    return {date: p.date, text: `Payment received: KES ${p.amount} from ${tenant ? tenant.name : 'Unknown'}`};
                })
            ].sort((a, b) => new Date(b.date) - new Date(a.date)).slice(0, 10);

            if (recentItems.length === 0) {
                activity.innerHTML = '<p style="color: #6c757d; text-align: center; padding: 20px;">No recent activity</p>';
            } else {
                activity.innerHTML = '<ul style="list-style: none; padding: 0;">' + 
                    recentItems.map(item => `<li style="padding: 10px; border-bottom: 1px solid #dee2e6;">${item.text}</li>`).join('') + 
                    '</ul>';
            }
        }

        // Reports
        function generateReport() {
            const reportType = document.getElementById('reportType').value;
            const dateFrom = document.getElementById('reportFrom').value;
            const dateTo = document.getElementById('reportTo').value;

            const output = document.getElementById('reportOutput');
            const content = document.getElementById('reportContent');
            
            let html = '';

            switch(reportType) {
                case 'maintenance':
                    html = generateMaintenanceReport(dateFrom, dateTo);
                    break;
                case 'equipment':
                    html = generateEquipmentReport();
                    break;
                case 'equipment-detailed':
                    html = generateEquipmentDetailedReport();
                    break;
                case 'equipment-attention':
                    html = generateAttentionReport();
                    break;
                case 'maintenance-history':
                    html = generateMaintenanceHistoryReport(dateFrom, dateTo);
                    break;
                case 'equipment-history':
                    html = generateEquipmentHistoryReport(dateFrom, dateTo);
                    break;
                case 'rent':
                    html = generateRentReport(dateFrom, dateTo);
                    break;
                case 'rent-history':
                    html = generateRentHistoryReport(dateFrom, dateTo);
                    break;
                case 'arrears':
                    html = generateArrearsReport();
                    break;
                case 'tenants':
                    html = generateTenantsReport();
                    break;
                case 'tenants-leases':
                    html = generateTenantLeasesReport();
                    break;
                case 'escalation-history':
                    html = generateEscalationHistoryReport(dateFrom, dateTo);
                    break;
                case 'preventive-maintenance':
                    html = generatePMReport();
                    break;
                case 'pm-overdue':
                    html = generatePMOverdueReport();
                    break;
                case 'pm-history':
                    html = generatePMHistoryReport(dateFrom, dateTo);
                    break;
                case 'insurance-claims':
                    html = generateInsuranceClaimsReport();
                    break;
                case 'combined':
                    html = generateCombinedReport(dateFrom, dateTo);
                    break;
                case 'custom-combined':
                    html = generateCustomCombinedReport(dateFrom, dateTo);
                    break;
            }

            console.log('Report Type:', reportType);
            console.log('Generated HTML length:', html ? html.length : 0);
            console.log('HTML preview:', html ? html.substring(0, 100) : 'EMPTY');
            
            if (!html || html.trim() === '') {
                content.innerHTML = '<div style="padding: 40px; text-align: center; color: #dc3545;"><h4>‚ö†Ô∏è Report Generation Error</h4><p>No data available for this report type or the report function failed to generate content.</p><p><strong>Report Type:</strong> ' + reportType + '</p><p><strong>Debug Info:</strong> Please check browser console (F12) for details.</p></div>';
            } else {
                content.innerHTML = html;
            }
            output.style.display = 'block';
            
            // Scroll to report output
            setTimeout(() => {
                output.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }, 100);
        }

        function generateInsuranceClaimsReport() {
            let html = '<h4>Insurance Claims Report</h4>';
            html += `<p><strong>Total Claims:</strong> ${insuranceClaims.length}</p>`;
            
            const pending = insuranceClaims.filter(c => !['Cleared/Paid', 'Rejected'].includes(c.status));
            const cleared = insuranceClaims.filter(c => c.status === 'Cleared/Paid');
            const totalClaimed = insuranceClaims.reduce((sum, c) => sum + c.claimAmount, 0);
            const totalRecovered = cleared.reduce((sum, c) => sum + (c.approvedAmount || c.claimAmount), 0);
            
            html += `<p><strong>Pending Claims:</strong> ${pending.length}</p>`;
            html += `<p><strong>Cleared Claims:</strong> ${cleared.length}</p>`;
            html += `<p><strong>Total Claimed:</strong> KES ${totalClaimed.toFixed(2)}</p>`;
            html += `<p><strong>Total Recovered:</strong> KES ${totalRecovered.toFixed(2)}</p>`;
            
            return html;
        }

        function generateMaintenanceReport(from, to) {
            let filtered = maintenance;
            if (from) filtered = filtered.filter(m => m.date >= from);
            if (to) filtered = filtered.filter(m => m.date <= to);

            const totalCost = filtered.reduce((sum, m) => sum + m.cost, 0);
            const byStatus = {};
            filtered.forEach(m => {
                byStatus[m.status] = (byStatus[m.status] || 0) + 1;
            });

            return `
                <h4>Maintenance Summary</h4>
                <p><strong>Total Tasks:</strong> ${filtered.length}</p>
                <p><strong>Total Cost:</strong> KES ${totalCost.toFixed(2)}</p>
                <p><strong>By Status:</strong> ${Object.entries(byStatus).map(([k,v]) => `${k}: ${v}`).join(', ')}</p>
            `;
        }

        function generateEquipmentReport() {
            const byCategory = {};
            equipment.forEach(e => {
                byCategory[e.category] = (byCategory[e.category] || 0) + 1;
            });

            return `
                <h4>Equipment Inventory</h4>
                <p><strong>Total Equipment:</strong> ${equipment.length}</p>
                <p><strong>By Category:</strong> ${Object.entries(byCategory).map(([k,v]) => `${k}: ${v}`).join(', ')}</p>
            `;
        }

        function generateRentReport(from, to) {
            let filtered = payments;
            if (from) filtered = filtered.filter(p => p.date >= from);
            if (to) filtered = filtered.filter(p => p.date <= to);

            const total = filtered.reduce((sum, p) => sum + p.amount, 0);

            return `
                <h4>Rent Collection</h4>
                <p><strong>Total Payments:</strong> ${filtered.length}</p>
                <p><strong>Total Collected:</strong> KES ${total.toFixed(2)}</p>
            `;
        }

        function generateArrearsReport() {
            let html = '<h4>Arrears Report</h4><table class="data-table" style="width: 100%;"><tr><th>Tenant</th><th>Unit</th><th>Monthly Rent</th><th>Arrears</th></tr>';
            
            tenants.forEach(tenant => {
                const tenantPayments = payments.filter(p => p.tenantId === tenant.id);
                const totalPaid = tenantPayments.reduce((sum, p) => sum + p.amount, 0);
                const leaseStart = new Date(tenant.leaseStart);
                const now = new Date();
                const monthsDiff = (now.getFullYear() - leaseStart.getFullYear()) * 12 + 
                                   (now.getMonth() - leaseStart.getMonth());
                const expectedTotal = tenant.rent * Math.max(0, monthsDiff);
                const arrears = Math.max(0, expectedTotal - totalPaid);

                if (arrears > 0) {
                    html += `<tr><td>${tenant.name}</td><td>${tenant.unit}</td><td>KES ${tenant.rent.toFixed(2)}</td><td>KES ${arrears.toFixed(2)}</td></tr>`;
                }
            });

            html += '</table>';
            return html;
        }

        function generateTenantsReport() {
            return `
                <h4>Tenant List</h4>
                <p><strong>Total Tenants:</strong> ${tenants.length}</p>
                <p><strong>Active:</strong> ${tenants.filter(t => t.status === 'Active').length}</p>
                <p><strong>Past:</strong> ${tenants.filter(t => t.status === 'Past Tenant').length}</p>
            `;
        }

        // Insurance Claims Functions
        function updateClaimEquipmentDropdown() {
            const dropdown = document.getElementById('claimEquipment');
            if (dropdown) {
                dropdown.innerHTML = '<option value="">Select Equipment (Optional)</option>' + 
                    equipment.map(item => {
                        const locationInfo = [item.floor, item.section, item.location].filter(Boolean).join(' - ') || 'Location N/A';
                        return `<option value="${item.id}">${item.name} (${locationInfo})</option>`;
                    }).join('');
            }
        }

        function addInsuranceClaim() {
            const claim = {
                id: Date.now(),
                title: document.getElementById('claimTitle').value,
                equipmentId: document.getElementById('claimEquipment').value || null,
                category: document.getElementById('claimCategory').value,
                incidentDate: document.getElementById('claimIncidentDate').value,
                filedDate: document.getElementById('claimFiledDate').value,
                insuranceCompany: document.getElementById('claimInsuranceCompany').value,
                policyNumber: document.getElementById('claimPolicyNumber').value,
                claimAmount: parseFloat(document.getElementById('claimAmount').value) || 0,
                status: document.getElementById('claimStatus').value,
                approvedAmount: parseFloat(document.getElementById('claimApprovedAmount').value) || 0,
                expectedDate: document.getElementById('claimExpectedDate').value,
                settlementDate: document.getElementById('claimSettlementDate').value,
                description: document.getElementById('claimDescription').value,
                documents: document.getElementById('claimDocuments').value,
                notes: document.getElementById('claimNotes').value,
                createdAt: new Date().toISOString()
            };

            if (!claim.title || !claim.category) {
                alert('Please fill in claim title and category');
                return;
            }

            insuranceClaims.push(claim);
            saveData('insuranceClaims', insuranceClaims);
            renderInsuranceClaims();
            renderMaintenance(); // Re-render to show claim status
            renderEquipment(); // Re-render to show claim status
            updateClaimsStats();
            clearClaimForm();
        }

        function clearClaimForm() {
            document.getElementById('claimTitle').value = '';
            document.getElementById('claimEquipment').value = '';
            document.getElementById('claimCategory').value = 'Property Damage';
            document.getElementById('claimIncidentDate').value = '';
            document.getElementById('claimFiledDate').value = new Date().toISOString().split('T')[0];
            document.getElementById('claimInsuranceCompany').value = '';
            document.getElementById('claimPolicyNumber').value = '';
            document.getElementById('claimAmount').value = '';
            document.getElementById('claimStatus').value = 'Pending Submission';
            document.getElementById('claimApprovedAmount').value = '';
            document.getElementById('claimExpectedDate').value = '';
            document.getElementById('claimSettlementDate').value = '';
            document.getElementById('claimDescription').value = '';
            document.getElementById('claimDocuments').value = '';
            document.getElementById('claimNotes').value = '';
        }

        function renderInsuranceClaims() {
            const list = document.getElementById('insuranceClaimsList');
            if (!list) return;
            
            if (insuranceClaims.length === 0) {
                list.innerHTML = '<tr><td colspan="9" style="text-align: center; padding: 40px; color: #6c757d;">No insurance claims filed yet. File your first claim above!</td></tr>';
                return;
            }

            list.innerHTML = insuranceClaims.map(claim => {
                const statusColor = getClaimStatusColor(claim.status);
                const equipmentName = claim.equipmentId ? 
                    (equipment.find(e => e.id == claim.equipmentId)?.name || 'Unknown') : 
                    'N/A';
                
                return `
                <tr>
                    <td>${claim.title}</td>
                    <td>${claim.category}</td>
                    <td>${claim.incidentDate || 'N/A'}</td>
                    <td>${claim.filedDate || 'N/A'}</td>
                    <td>KES ${claim.claimAmount.toFixed(2)}</td>
                    <td>${claim.approvedAmount > 0 ? 'KES ' + claim.approvedAmount.toFixed(2) : 'N/A'}</td>
                    <td><span class="badge badge-${statusColor}">${claim.status}</span></td>
                    <td>${claim.settlementDate || 'Pending'}</td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn btn-warning" onclick="editInsuranceClaim(${claim.id})">Edit</button>
                            <button class="btn btn-danger" onclick="deleteInsuranceClaim(${claim.id})">Delete</button>
                        </div>
                    </td>
                </tr>
            `;
            }).join('');
        }

        function getClaimStatusColor(status) {
            const statusColors = {
                'Pending Submission': 'warning',
                'Submitted': 'info',
                'Under Review': 'info',
                'Approved': 'success',
                'Partially Approved': 'warning',
                'Rejected': 'danger',
                'Cleared/Paid': 'success'
            };
            return statusColors[status] || 'secondary';
        }

        function updateClaimsStats() {
            const pendingStatuses = ['Pending Submission', 'Submitted', 'Under Review', 'Approved', 'Partially Approved'];
            const clearedStatuses = ['Cleared/Paid'];
            
            const pendingCount = insuranceClaims.filter(c => pendingStatuses.includes(c.status)).length;
            const clearedCount = insuranceClaims.filter(c => clearedStatuses.includes(c.status)).length;
            const totalClaimed = insuranceClaims.reduce((sum, c) => sum + c.claimAmount, 0);
            const totalRecovered = insuranceClaims
                .filter(c => c.status === 'Cleared/Paid')
                .reduce((sum, c) => sum + (c.approvedAmount || c.claimAmount), 0);

            const pendingEl = document.getElementById('pendingClaims');
            const clearedEl = document.getElementById('clearedClaims');
            const claimedEl = document.getElementById('totalClaimed');
            const recoveredEl = document.getElementById('totalRecovered');

            if (pendingEl) pendingEl.textContent = pendingCount;
            if (clearedEl) clearedEl.textContent = clearedCount;
            if (claimedEl) claimedEl.textContent = `KES ${totalClaimed.toFixed(2)}`;
            if (recoveredEl) recoveredEl.textContent = `KES ${totalRecovered.toFixed(2)}`;
        }

        function editInsuranceClaim(id) {
            const claim = insuranceClaims.find(c => c.id === id);
            if (!claim) return;

            document.getElementById('claimTitle').value = claim.title;
            document.getElementById('claimEquipment').value = claim.equipmentId || '';
            document.getElementById('claimCategory').value = claim.category;
            document.getElementById('claimIncidentDate').value = claim.incidentDate || '';
            document.getElementById('claimFiledDate').value = claim.filedDate || '';
            document.getElementById('claimInsuranceCompany').value = claim.insuranceCompany || '';
            document.getElementById('claimPolicyNumber').value = claim.policyNumber || '';
            document.getElementById('claimAmount').value = claim.claimAmount;
            document.getElementById('claimStatus').value = claim.status;
            document.getElementById('claimApprovedAmount').value = claim.approvedAmount || '';
            document.getElementById('claimExpectedDate').value = claim.expectedDate || '';
            document.getElementById('claimSettlementDate').value = claim.settlementDate || '';
            document.getElementById('claimDescription').value = claim.description || '';
            document.getElementById('claimDocuments').value = claim.documents || '';
            document.getElementById('claimNotes').value = claim.notes || '';

            const addButton = document.querySelector('#insurance .btn-primary');
            addButton.textContent = 'Update Insurance Claim';
            addButton.onclick = () => updateInsuranceClaim(id);

            document.querySelector('#insurance .form-section').scrollIntoView({ behavior: 'smooth' });
        }

        function updateInsuranceClaim(id) {
            const claimIndex = insuranceClaims.findIndex(c => c.id === id);
            if (claimIndex === -1) return;

            insuranceClaims[claimIndex] = {
                ...insuranceClaims[claimIndex],
                title: document.getElementById('claimTitle').value,
                equipmentId: document.getElementById('claimEquipment').value || null,
                category: document.getElementById('claimCategory').value,
                incidentDate: document.getElementById('claimIncidentDate').value,
                filedDate: document.getElementById('claimFiledDate').value,
                insuranceCompany: document.getElementById('claimInsuranceCompany').value,
                policyNumber: document.getElementById('claimPolicyNumber').value,
                claimAmount: parseFloat(document.getElementById('claimAmount').value) || 0,
                status: document.getElementById('claimStatus').value,
                approvedAmount: parseFloat(document.getElementById('claimApprovedAmount').value) || 0,
                expectedDate: document.getElementById('claimExpectedDate').value,
                settlementDate: document.getElementById('claimSettlementDate').value,
                description: document.getElementById('claimDescription').value,
                documents: document.getElementById('claimDocuments').value,
                notes: document.getElementById('claimNotes').value
            };

            saveData('insuranceClaims', insuranceClaims);
            renderInsuranceClaims();
            renderMaintenance();
            renderEquipment();
            updateClaimsStats();
            clearClaimForm();

            const addButton = document.querySelector('#insurance .btn-primary');
            addButton.textContent = 'File Insurance Claim';
            addButton.onclick = addInsuranceClaim;
        }

        function deleteInsuranceClaim(id) {
            if (confirm('Are you sure you want to delete this insurance claim?')) {
                insuranceClaims = insuranceClaims.filter(c => c.id !== id);
                saveData('insuranceClaims', insuranceClaims);
                renderInsuranceClaims();
                renderMaintenance();
                renderEquipment();
                updateClaimsStats();
            }
        }

        function filterClaims() {
            const search = document.getElementById('claimSearch').value.toLowerCase();
            const statusFilter = document.getElementById('claimStatusFilter').value;

            let filtered = insuranceClaims.filter(claim => {
                const matchesSearch = claim.title.toLowerCase().includes(search) ||
                                     claim.category.toLowerCase().includes(search) ||
                                     (claim.insuranceCompany && claim.insuranceCompany.toLowerCase().includes(search));
                
                let matchesStatus = true;
                if (statusFilter === 'Pending') {
                    matchesStatus = ['Pending Submission', 'Submitted', 'Under Review', 'Approved', 'Partially Approved'].includes(claim.status);
                } else if (statusFilter === 'Cleared') {
                    matchesStatus = claim.status === 'Cleared/Paid';
                } else if (statusFilter === 'Rejected') {
                    matchesStatus = claim.status === 'Rejected';
                }

                return matchesSearch && matchesStatus;
            });

            const list = document.getElementById('insuranceClaimsList');
            if (filtered.length === 0) {
                list.innerHTML = '<tr><td colspan="9" style="text-align: center; padding: 40px; color: #6c757d;">No claims match your search</td></tr>';
                return;
            }

            list.innerHTML = filtered.map(claim => {
                const statusColor = getClaimStatusColor(claim.status);
                return `
                <tr>
                    <td>${claim.title}</td>
                    <td>${claim.category}</td>
                    <td>${claim.incidentDate || 'N/A'}</td>
                    <td>${claim.filedDate || 'N/A'}</td>
                    <td>KES ${claim.claimAmount.toFixed(2)}</td>
                    <td>${claim.approvedAmount > 0 ? 'KES ' + claim.approvedAmount.toFixed(2) : 'N/A'}</td>
                    <td><span class="badge badge-${statusColor}">${claim.status}</span></td>
                    <td>${claim.settlementDate || 'Pending'}</td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn btn-warning" onclick="editInsuranceClaim(${claim.id})">Edit</button>
                            <button class="btn btn-danger" onclick="deleteInsuranceClaim(${claim.id})">Delete</button>
                        </div>
                    </td>
                </tr>
            `;
            }).join('');
        }

        // Helper function to get claim status for equipment/maintenance
        function getEquipmentClaimStatus(equipmentId) {
            const claims = insuranceClaims.filter(c => c.equipmentId == equipmentId);
            if (claims.length === 0) return null;
            
            const pendingClaim = claims.find(c => ['Pending Submission', 'Submitted', 'Under Review', 'Approved', 'Partially Approved'].includes(c.status));
            const clearedClaim = claims.find(c => c.status === 'Cleared/Paid');
            
            if (pendingClaim) {
                return { status: 'Pending', claim: pendingClaim };
            } else if (clearedClaim) {
                return { status: 'Cleared', claim: clearedClaim };
            }
            return null;
        }

        // Equipment Reminders and Attention Items
        function checkEquipmentReminders() {
            const today = new Date();
            const itemsNeedingAttention = [];

            equipment.forEach(item => {
                const reasons = [];
                
                // Check replacements needed
                if (item.needsReplacement && item.needsReplacement > 0) {
                    reasons.push(`${item.needsReplacement} units need replacement`);
                }
                
                // Check service due
                if (item.nextService) {
                    const serviceDate = new Date(item.nextService);
                    const daysUntilService = Math.floor((serviceDate - today) / (1000 * 60 * 60 * 24));
                    if (daysUntilService <= 7 && daysUntilService >= 0) {
                        reasons.push(`Service due in ${daysUntilService} days`);
                    } else if (daysUntilService < 0) {
                        reasons.push(`Service overdue by ${Math.abs(daysUntilService)} days`);
                    }
                }
                
                // Check contract expiry
                if (item.serviceContract === 'Active' && item.contractExpiry) {
                    const expiryDate = new Date(item.contractExpiry);
                    const daysUntilExpiry = Math.floor((expiryDate - today) / (1000 * 60 * 60 * 24));
                    if (daysUntilExpiry <= 30 && daysUntilExpiry >= 0) {
                        reasons.push(`Service contract expires in ${daysUntilExpiry} days`);
                    } else if (daysUntilExpiry < 0) {
                        reasons.push(`Service contract expired`);
                    }
                }
                
                // Check warranty expiry
                if (item.warranty) {
                    const warrantyDate = new Date(item.warranty);
                    const daysUntilWarranty = Math.floor((warrantyDate - today) / (1000 * 60 * 60 * 24));
                    if (daysUntilWarranty <= 30 && daysUntilWarranty >= 0) {
                        reasons.push(`Warranty expires in ${daysUntilWarranty} days`);
                    }
                }
                
                // Check status
                if (item.status === 'Needs Service' || item.status === 'Needs Replacement' || item.status === 'Out of Service') {
                    reasons.push(`Status: ${item.status}`);
                }
                
                if (reasons.length > 0) {
                    itemsNeedingAttention.push({
                        ...item,
                        attentionReasons: reasons
                    });
                }
            });

            // Show browser notification if items need attention
            if (itemsNeedingAttention.length > 0 && 'Notification' in window) {
                if (Notification.permission === 'granted') {
                    new Notification('Equipment Attention Required', {
                        body: `${itemsNeedingAttention.length} item(s) need attention`,
                        icon: 'üîß'
                    });
                }
            }

            return itemsNeedingAttention;
        }

        // Lease Expiry Reminders
        function checkLeaseExpiry() {
            const today = new Date();
            const leasesExpiringSoon = [];

            tenants.forEach(tenant => {
                if (tenant.leaseEnd && tenant.status === 'Active') {
                    const leaseEndDate = new Date(tenant.leaseEnd);
                    const daysUntilExpiry = Math.floor((leaseEndDate - today) / (1000 * 60 * 60 * 24));
                    
                    // Check for leases expiring within 90 days (3 months)
                    if (daysUntilExpiry >= 0 && daysUntilExpiry <= 90) {
                        leasesExpiringSoon.push({
                            ...tenant,
                            daysUntilExpiry: daysUntilExpiry,
                            urgency: daysUntilExpiry <= 30 ? 'critical' : daysUntilExpiry <= 60 ? 'warning' : 'notice'
                        });
                    } else if (daysUntilExpiry < 0) {
                        // Already expired
                        leasesExpiringSoon.push({
                            ...tenant,
                            daysUntilExpiry: daysUntilExpiry,
                            urgency: 'expired'
                        });
                    }
                }
            });

            // Show browser notification for critical leases (30 days or less)
            const criticalLeases = leasesExpiringSoon.filter(l => l.urgency === 'critical' || l.urgency === 'expired');
            
            if (criticalLeases.length > 0 && 'Notification' in window) {
                if (Notification.permission === 'granted') {
                    const message = criticalLeases.length === 1 
                        ? `${criticalLeases[0].name}'s lease ${criticalLeases[0].urgency === 'expired' ? 'has expired' : 'expires in ' + criticalLeases[0].daysUntilExpiry + ' days'}`
                        : `${criticalLeases.length} lease(s) expiring soon or expired`;
                    
                    new Notification('‚ö†Ô∏è Lease Expiry Alert', {
                        body: message,
                        icon: 'üìã'
                    });
                }
            }

            return leasesExpiringSoon;
        }

        // Display lease expiry warnings in dashboard
        function renderLeaseExpiryWarnings() {
            const leasesExpiringSoon = checkLeaseExpiry();
            const warningsDiv = document.getElementById('leaseExpiryWarnings');
            
            if (!warningsDiv) return;
            
            if (leasesExpiringSoon.length === 0) {
                warningsDiv.innerHTML = '';
                return;
            }

            // Sort by urgency: expired, critical, warning, notice
            const urgencyOrder = { 'expired': 0, 'critical': 1, 'warning': 2, 'notice': 3 };
            leasesExpiringSoon.sort((a, b) => urgencyOrder[a.urgency] - urgencyOrder[b.urgency]);

            let html = '<div style="padding: 20px; background: #fff3cd; border-left: 4px solid #ffc107; border-radius: 8px; margin-bottom: 20px;">';
            html += '<h4 style="margin: 0 0 15px 0; color: #856404;">‚ö†Ô∏è Lease Expiry Alerts</h4>';
            
            leasesExpiringSoon.forEach(lease => {
                let icon = 'üìã';
                let color = '#856404';
                let message = '';
                
                if (lease.urgency === 'expired') {
                    icon = 'üî¥';
                    color = '#dc3545';
                    message = `<strong>${lease.name}</strong> (${lease.unit}) - Lease EXPIRED ${Math.abs(lease.daysUntilExpiry)} days ago`;
                } else if (lease.urgency === 'critical') {
                    icon = 'üî¥';
                    color = '#dc3545';
                    message = `<strong>${lease.name}</strong> (${lease.unit}) - Lease expires in <strong>${lease.daysUntilExpiry} days</strong> (URGENT!)`;
                } else if (lease.urgency === 'warning') {
                    icon = 'üü°';
                    color = '#ffc107';
                    message = `<strong>${lease.name}</strong> (${lease.unit}) - Lease expires in ${lease.daysUntilExpiry} days (~2 months)`;
                } else {
                    icon = '‚ö†Ô∏è';
                    color = '#856404';
                    message = `<strong>${lease.name}</strong> (${lease.unit}) - Lease expires in ${lease.daysUntilExpiry} days (~3 months)`;
                }
                
                html += `<div style="padding: 10px; margin-bottom: 8px; background: white; border-radius: 4px; color: ${color};">`;
                html += `${icon} ${message}`;
                html += `</div>`;
            });
            
            html += '</div>';
            warningsDiv.innerHTML = html;
        }

        // Rent Escalation Functions
        function checkRentEscalations() {
            const today = new Date();
            const escalationsDue = [];

            tenants.forEach(tenant => {
                if (tenant.escalation === 'None' || !tenant.nextEscalationDate || tenant.status !== 'Active') {
                    return;
                }

                const escalationDate = new Date(tenant.nextEscalationDate);
                const daysUntil = Math.floor((escalationDate - today) / (1000 * 60 * 60 * 24));

                // Alert 30 days before escalation
                if (daysUntil >= 0 && daysUntil <= 30) {
                    escalationsDue.push({
                        ...tenant,
                        daysUntil: daysUntil,
                        urgency: daysUntil <= 7 ? 'critical' : daysUntil <= 14 ? 'warning' : 'notice'
                    });
                } else if (daysUntil < 0 && daysUntil >= -7) {
                    // Overdue up to 7 days
                    escalationsDue.push({
                        ...tenant,
                        daysUntil: daysUntil,
                        urgency: 'overdue'
                    });
                }
            });

            // Show browser notification for critical escalations
            const criticalEscalations = escalationsDue.filter(e => e.urgency === 'critical' || e.urgency === 'overdue');
            
            if (criticalEscalations.length > 0 && 'Notification' in window) {
                if (Notification.permission === 'granted') {
                    const message = criticalEscalations.length === 1 
                        ? `${criticalEscalations[0].name}'s rent escalation ${criticalEscalations[0].urgency === 'overdue' ? 'is overdue' : 'due in ' + criticalEscalations[0].daysUntil + ' days'}`
                        : `${criticalEscalations.length} rent escalation(s) due soon or overdue`;
                    
                    new Notification('üí∞ Rent Escalation Alert', {
                        body: message,
                        icon: 'üí∞'
                    });
                }
            }

            return escalationsDue;
        }

        function renderRentEscalationWarnings() {
            const escalationsDue = checkRentEscalations();
            const warningsDiv = document.getElementById('rentEscalationWarnings');
            
            if (!warningsDiv) return;
            
            if (escalationsDue.length === 0) {
                warningsDiv.innerHTML = '';
                return;
            }

            // Sort by urgency
            const urgencyOrder = { 'overdue': 0, 'critical': 1, 'warning': 2, 'notice': 3 };
            escalationsDue.sort((a, b) => urgencyOrder[a.urgency] - urgencyOrder[b.urgency]);

            let html = '<div style="padding: 20px; background: #fff3cd; border-left: 4px solid #ffc107; border-radius: 8px; margin-bottom: 20px;">';
            html += '<h4 style="margin: 0 0 15px 0; color: #856404;">üí∞ Rent Escalation Alerts</h4>';
            
            escalationsDue.forEach(esc => {
                let icon = 'üí∞';
                let color = '#856404';
                let message = '';
                const newRent = calculateNewRent(esc.rent, esc.escalationRate);
                
                if (esc.urgency === 'overdue') {
                    icon = 'üî¥';
                    color = '#dc3545';
                    message = `<strong>${esc.name}</strong> (${esc.unit}) - Escalation OVERDUE by ${Math.abs(esc.daysUntil)} days | Current: KES ${esc.rent.toFixed(0)} ‚Üí New: KES ${newRent.toFixed(0)} (+${esc.escalationRate}%)`;
                } else if (esc.urgency === 'critical') {
                    icon = 'üî¥';
                    color = '#dc3545';
                    message = `<strong>${esc.name}</strong> (${esc.unit}) - Escalation in <strong>${esc.daysUntil} days</strong> (URGENT!) | Current: KES ${esc.rent.toFixed(0)} ‚Üí New: KES ${newRent.toFixed(0)} (+${esc.escalationRate}%)`;
                } else if (esc.urgency === 'warning') {
                    icon = 'üü°';
                    color = '#ffc107';
                    message = `<strong>${esc.name}</strong> (${esc.unit}) - Escalation in ${esc.daysUntil} days | Current: KES ${esc.rent.toFixed(0)} ‚Üí New: KES ${newRent.toFixed(0)} (+${esc.escalationRate}%)`;
                } else {
                    icon = '‚ö†Ô∏è';
                    color = '#856404';
                    message = `<strong>${esc.name}</strong> (${esc.unit}) - Escalation in ${esc.daysUntil} days (${esc.escalation}) | Current: KES ${esc.rent.toFixed(0)} ‚Üí New: KES ${newRent.toFixed(0)} (+${esc.escalationRate}%)`;
                }
                
                html += `<div style="padding: 10px; margin-bottom: 8px; background: white; border-radius: 4px; color: ${color}; display: flex; justify-content: space-between; align-items: center;">`;
                html += `<span>${icon} ${message}</span>`;
                html += `<button class="btn btn-primary" onclick="executeRentEscalation(${esc.id})" style="padding: 5px 10px; font-size: 12px;">Execute Now</button>`;
                html += `</div>`;
            });
            
            html += '</div>';
            warningsDiv.innerHTML = html;
        }

        function calculateNewRent(currentRent, escalationRate) {
            return currentRent * (1 + escalationRate / 100);
        }

        function executeRentEscalation(tenantId) {
            const tenant = tenants.find(t => t.id === tenantId);
            if (!tenant) return;

            const newRent = calculateNewRent(tenant.rent, tenant.escalationRate);
            
            const confirmMsg = `Execute Rent Escalation for ${tenant.name}?\n\n` +
                             `Current Rent: KES ${tenant.rent.toFixed(2)}\n` +
                             `Escalation Rate: ${tenant.escalationRate}%\n` +
                             `New Rent: KES ${newRent.toFixed(2)}\n\n` +
                             `This will update the rent immediately.`;
            
            if (!confirm(confirmMsg)) return;

            // Record escalation in history
            const escalationRecord = {
                date: new Date().toISOString().split('T')[0],
                oldRent: tenant.rent,
                newRent: newRent,
                rate: tenant.escalationRate,
                type: tenant.escalation
            };

            if (!tenant.escalationHistory) {
                tenant.escalationHistory = [];
            }
            tenant.escalationHistory.push(escalationRecord);

            // Update rent
            tenant.rent = newRent;
            tenant.lastEscalationDate = new Date().toISOString().split('T')[0];
            
            // Calculate next escalation date
            const nextDate = calculateNextEscalationDate(new Date(), tenant.escalation);
            tenant.nextEscalationDate = nextDate.toISOString().split('T')[0];

            saveData('tenants', tenants);
            renderTenants();
            renderRentEscalationWarnings();
            updateRentStatus();

            alert(`‚úÖ Rent Escalation Executed!\n\n` +
                  `${tenant.name} (${tenant.unit})\n` +
                  `Old Rent: KES ${escalationRecord.oldRent.toFixed(2)}\n` +
                  `New Rent: KES ${newRent.toFixed(2)}\n` +
                  `Next Escalation: ${tenant.nextEscalationDate}`);
        }

        function calculateNextEscalationDate(fromDate, escalationType) {
            const nextDate = new Date(fromDate);
            
            if (escalationType === 'Annual') {
                nextDate.setFullYear(nextDate.getFullYear() + 1);
            } else if (escalationType === 'Biannual') {
                nextDate.setMonth(nextDate.getMonth() + 6);
            }
            
            return nextDate;
        }


        // Toggle report filters based on report type
        function toggleReportFilters() {
            const reportType = document.getElementById('reportType').value;
            const filtersDiv = document.getElementById('equipmentFilters');
            const customDiv = document.getElementById('customReportSelector');
            
            if (reportType.includes('equipment') || reportType === 'combined' || reportType === 'custom-combined') {
                filtersDiv.style.display = 'block';
            } else {
                filtersDiv.style.display = 'none';
            }
            
            if (reportType === 'custom-combined') {
                customDiv.style.display = 'block';
            } else {
                customDiv.style.display = 'none';
            }
        }

        // Filter equipment based on selected criteria
        function filterEquipmentForReport() {
            let filtered = [...equipment];
            
            const floor = document.getElementById('filterFloor')?.value;
            const section = document.getElementById('filterSection')?.value;
            const category = document.getElementById('filterCategory')?.value;
            const status = document.getElementById('filterStatus')?.value;
            const insured = document.getElementById('filterInsured')?.value;
            const serviceContract = document.getElementById('filterServiceContract')?.value;
            const replacement = document.getElementById('filterReplacement')?.value;
            
            if (floor) filtered = filtered.filter(e => e.floor === floor);
            if (section) filtered = filtered.filter(e => e.section === section);
            if (category) filtered = filtered.filter(e => e.category === category);
            if (status) filtered = filtered.filter(e => e.status === status);
            if (insured) filtered = filtered.filter(e => e.insured === insured);
            if (serviceContract) filtered = filtered.filter(e => e.serviceContract === serviceContract);
            if (replacement === 'needs') filtered = filtered.filter(e => e.needsReplacement > 0);
            if (replacement === 'ok') filtered = filtered.filter(e => !e.needsReplacement || e.needsReplacement === 0);
            
            return filtered;
        }

        // Generate equipment detailed report
        function generateEquipmentDetailedReport() {
            const filtered = filterEquipmentForReport();
            
            let html = '<h4>Equipment Detailed Report - Replacements & Status</h4>';
            html += `<p><strong>Total Items:</strong> ${filtered.length}</p>`;
            
            const totalQty = filtered.reduce((sum, e) => sum + (e.quantity || 0), 0);
            const totalWorking = filtered.reduce((sum, e) => sum + (e.workingQty || 0), 0);
            const totalNeedReplacement = filtered.reduce((sum, e) => sum + (e.needsReplacement || 0), 0);
            
            html += `<p><strong>Total Units:</strong> ${totalQty} | <strong>Working:</strong> ${totalWorking} | <strong>Need Replacement:</strong> ${totalNeedReplacement}</p>`;
            
            // Group by floor and section
            const grouped = {};
            filtered.forEach(item => {
                const key = `${item.floor || 'No Floor'} - ${item.section || 'No Section'}`;
                if (!grouped[key]) grouped[key] = [];
                grouped[key].push(item);
            });
            
            html += '<div style="margin-top: 20px;">';
            Object.keys(grouped).forEach(key => {
                const items = grouped[key];
                const groupQty = items.reduce((sum, e) => sum + (e.quantity || 0), 0);
                const groupWorking = items.reduce((sum, e) => sum + (e.workingQty || 0), 0);
                const groupNeedReplacement = items.reduce((sum, e) => sum + (e.needsReplacement || 0), 0);
                
                html += `<div style="margin-bottom: 25px; padding: 15px; background: #f8f9fa; border-radius: 8px;">`;
                html += `<h5 style="color: #667eea; margin-bottom: 10px;">${key}</h5>`;
                html += `<p style="font-size: 13px; color: #666;">Total: ${groupQty} | Working: ${groupWorking} | Need Replacement: ${groupNeedReplacement}</p>`;
                html += '<table style="width: 100%; border-collapse: collapse; margin-top: 10px;">';
                html += '<tr style="background: #667eea; color: white;"><th style="padding: 8px; text-align: left;">Item</th><th>Category</th><th>Total</th><th>Working</th><th>Need Replace</th><th>Insured</th><th>Service Contract</th><th>Status</th></tr>';
                
                items.forEach(item => {
                    const needReplace = item.needsReplacement || 0;
                    const replaceColor = needReplace > 0 ? '#dc3545' : '#28a745';
                    
                    html += `<tr style="border-bottom: 1px solid #dee2e6;">`;
                    html += `<td style="padding: 8px;">${item.name}</td>`;
                    html += `<td style="padding: 8px;">${item.category}</td>`;
                    html += `<td style="padding: 8px; text-align: center;">${item.quantity || 0}</td>`;
                    html += `<td style="padding: 8px; text-align: center;">${item.workingQty || 0}</td>`;
                    html += `<td style="padding: 8px; text-align: center; color: ${replaceColor}; font-weight: bold;">${needReplace}</td>`;
                    html += `<td style="padding: 8px; text-align: center;">${item.insured || 'No'}</td>`;
                    html += `<td style="padding: 8px; text-align: center;">${item.serviceContract || 'None'}</td>`;
                    html += `<td style="padding: 8px;"><span class="badge badge-${getEquipStatusColor(item.status)}">${item.status}</span></td>`;
                    html += `</tr>`;
                });
                
                html += '</table></div>';
            });
            html += '</div>';
            
            return html;
        }

        // Generate items needing attention report
        function generateAttentionReport() {
            const itemsNeedingAttention = checkEquipmentReminders();
            
            let html = '<h4>‚ö†Ô∏è Items Needing Attention</h4>';
            html += `<p><strong>Total Items:</strong> ${itemsNeedingAttention.length}</p>`;
            
            if (itemsNeedingAttention.length === 0) {
                html += '<p style="color: #28a745; font-size: 16px; margin-top: 20px;">‚úÖ All equipment is in good condition! No immediate attention needed.</p>';
                return html;
            }
            
            html += '<table style="width: 100%; border-collapse: collapse; margin-top: 20px;">';
            html += '<tr style="background: #dc3545; color: white;"><th style="padding: 10px; text-align: left;">Equipment</th><th>Location</th><th>Attention Required</th><th>Status</th></tr>';
            
            itemsNeedingAttention.forEach(item => {
                const location = [item.floor, item.section, item.location].filter(Boolean).join(' - ') || 'N/A';
                html += `<tr style="border-bottom: 1px solid #dee2e6;">`;
                html += `<td style="padding: 10px;"><strong>${item.name}</strong><br><small>${item.category}</small></td>`;
                html += `<td style="padding: 10px;">${location}</td>`;
                html += `<td style="padding: 10px;">`;
                item.attentionReasons.forEach(reason => {
                    html += `‚Ä¢ ${reason}<br>`;
                });
                html += `</td>`;
                html += `<td style="padding: 10px;"><span class="badge badge-${getEquipStatusColor(item.status)}">${item.status}</span></td>`;
                html += `</tr>`;
            });
            
            html += '</table>';
            return html;
        }

        // Generate combined report
        function generateCombinedReport(from, to) {
            let html = '<h4>üìä Combined Comprehensive Report</h4>';
            html += `<p><strong>Date Range:</strong> ${from || 'All Time'} to ${to || 'Present'}</p>`;
            
            // Summary Statistics
            html += '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin: 20px 0;">';
            html += `<div style="background: #667eea; color: white; padding: 15px; border-radius: 8px;"><h5 style="margin: 0;">Equipment</h5><p style="font-size: 24px; margin: 10px 0 0 0;">${equipment.length}</p></div>`;
            html += `<div style="background: #28a745; color: white; padding: 15px; border-radius: 8px;"><h5 style="margin: 0;">Tenants</h5><p style="font-size: 24px; margin: 10px 0 0 0;">${tenants.length}</p></div>`;
            html += `<div style="background: #ffc107; color: white; padding: 15px; border-radius: 8px;"><h5 style="margin: 0;">Pending Maintenance</h5><p style="font-size: 24px; margin: 10px 0 0 0;">${maintenance.filter(m => m.status !== 'Completed').length}</p></div>`;
            html += `<div style="background: #dc3545; color: white; padding: 15px; border-radius: 8px;"><h5 style="margin: 0;">Insurance Claims</h5><p style="font-size: 24px; margin: 10px 0 0 0;">${insuranceClaims.length}</p></div>`;
            html += '</div>';
            
            // Equipment Section
            html += '<hr style="margin: 30px 0;"><h5 style="color: #667eea;">üì¶ Equipment Overview</h5>';
            html += generateEquipmentDetailedReport();
            
            // Attention Items
            html += '<hr style="margin: 30px 0;"><h5 style="color: #dc3545;">‚ö†Ô∏è Items Needing Attention</h5>';
            html += generateAttentionReport();
            
            // Tenant Leases
            html += '<hr style="margin: 30px 0;"><h5 style="color: #667eea;">üìÖ Tenant Leases & Expiry</h5>';
            html += generateTenantLeasesReport();
            
            // Maintenance Section  
            let filteredMaint = maintenance;
            if (from) filteredMaint = filteredMaint.filter(m => m.date >= from);
            if (to) filteredMaint = filteredMaint.filter(m => m.date <= to);
            html += '<hr style="margin: 30px 0;"><h5 style="color: #667eea;">üîß Maintenance Summary</h5>';
            html += generateMaintenanceReport(from, to);
            
            // Insurance Claims Section
            html += '<hr style="margin: 30px 0;"><h5 style="color: #667eea;">üõ°Ô∏è Insurance Claims</h5>';
            html += `<p><strong>Total Claims:</strong> ${insuranceClaims.length}</p>`;
            html += `<p><strong>Pending:</strong> ${insuranceClaims.filter(c => !['Cleared/Paid', 'Rejected'].includes(c.status)).length}</p>`;
            html += `<p><strong>Cleared:</strong> ${insuranceClaims.filter(c => c.status === 'Cleared/Paid').length}</p>`;
            
            return html;
        }

        // Generate Tenant Leases Report
        function generateTenantLeasesReport() {
            const today = new Date();
            
            let html = '<div style="margin-top: 20px;">';
            html += '<h4>üìÖ Tenant Leases & Expiry Report</h4>';
            html += `<p><strong>Total Tenants:</strong> ${tenants.length}</p>`;
            
            // Categorize tenants by lease status
            const expired = [];
            const critical = []; // < 30 days
            const warning = []; // 30-60 days
            const notice = []; // 60-90 days
            const safe = []; // > 90 days
            const noLease = [];
            
            tenants.forEach(tenant => {
                if (!tenant.leaseEnd) {
                    noLease.push(tenant);
                    return;
                }
                
                const leaseEndDate = new Date(tenant.leaseEnd);
                const daysUntilExpiry = Math.floor((leaseEndDate - today) / (1000 * 60 * 60 * 24));
                
                if (daysUntilExpiry < 0) {
                    expired.push({ ...tenant, daysUntilExpiry });
                } else if (daysUntilExpiry <= 30) {
                    critical.push({ ...tenant, daysUntilExpiry });
                } else if (daysUntilExpiry <= 60) {
                    warning.push({ ...tenant, daysUntilExpiry });
                } else if (daysUntilExpiry <= 90) {
                    notice.push({ ...tenant, daysUntilExpiry });
                } else {
                    safe.push({ ...tenant, daysUntilExpiry });
                }
            });
            
            // Summary counts
            html += '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; margin: 20px 0;">';
            html += `<div style="background: #dc3545; color: white; padding: 10px; border-radius: 4px; text-align: center;"><strong>Expired</strong><br>${expired.length}</div>`;
            html += `<div style="background: #ff6b6b; color: white; padding: 10px; border-radius: 4px; text-align: center;"><strong>Critical (‚â§30d)</strong><br>${critical.length}</div>`;
            html += `<div style="background: #ffc107; color: white; padding: 10px; border-radius: 4px; text-align: center;"><strong>Warning (30-60d)</strong><br>${warning.length}</div>`;
            html += `<div style="background: #ffeb3b; color: #333; padding: 10px; border-radius: 4px; text-align: center;"><strong>Notice (60-90d)</strong><br>${notice.length}</div>`;
            html += `<div style="background: #28a745; color: white; padding: 10px; border-radius: 4px; text-align: center;"><strong>Safe (>90d)</strong><br>${safe.length}</div>`;
            html += '</div>';
            
            // Expired Leases
            if (expired.length > 0) {
                html += '<div style="margin: 20px 0; padding: 15px; background: #f8d7da; border-left: 4px solid #dc3545; border-radius: 4px;">';
                html += '<h5 style="color: #721c24; margin: 0 0 10px 0;">üî¥ Expired Leases (Immediate Action Required)</h5>';
                html += '<table style="width: 100%; border-collapse: collapse;">';
                html += '<tr style="background: #dc3545; color: white;"><th style="padding: 8px; text-align: left;">Tenant</th><th>Unit</th><th>Lease End</th><th>Days Expired</th><th>Rent</th></tr>';
                expired.forEach(t => {
                    html += `<tr style="border-bottom: 1px solid #ddd;">`;
                    html += `<td style="padding: 8px;"><strong>${t.name}</strong></td>`;
                    html += `<td style="padding: 8px;">${t.unit}</td>`;
                    html += `<td style="padding: 8px;">${t.leaseEnd}</td>`;
                    html += `<td style="padding: 8px; color: #dc3545; font-weight: bold;">${Math.abs(t.daysUntilExpiry)} days ago</td>`;
                    html += `<td style="padding: 8px;">KES ${t.rent.toFixed(2)}</td>`;
                    html += `</tr>`;
                });
                html += '</table></div>';
            }
            
            // Critical Leases (‚â§30 days)
            if (critical.length > 0) {
                html += '<div style="margin: 20px 0; padding: 15px; background: #fff3cd; border-left: 4px solid #ff6b6b; border-radius: 4px;">';
                html += '<h5 style="color: #856404; margin: 0 0 10px 0;">üî¥ Critical - Expiring Within 30 Days</h5>';
                html += '<table style="width: 100%; border-collapse: collapse;">';
                html += '<tr style="background: #ff6b6b; color: white;"><th style="padding: 8px; text-align: left;">Tenant</th><th>Unit</th><th>Lease End</th><th>Days Left</th><th>Rent</th></tr>';
                critical.forEach(t => {
                    html += `<tr style="border-bottom: 1px solid #ddd;">`;
                    html += `<td style="padding: 8px;"><strong>${t.name}</strong></td>`;
                    html += `<td style="padding: 8px;">${t.unit}</td>`;
                    html += `<td style="padding: 8px;">${t.leaseEnd}</td>`;
                    html += `<td style="padding: 8px; color: #dc3545; font-weight: bold;">${t.daysUntilExpiry} days</td>`;
                    html += `<td style="padding: 8px;">KES ${t.rent.toFixed(2)}</td>`;
                    html += `</tr>`;
                });
                html += '</table></div>';
            }
            
            // Warning Leases (30-60 days)
            if (warning.length > 0) {
                html += '<div style="margin: 20px 0; padding: 15px; background: #fff8e1; border-left: 4px solid #ffc107; border-radius: 4px;">';
                html += '<h5 style="color: #856404; margin: 0 0 10px 0;">üü° Warning - Expiring in 30-60 Days</h5>';
                html += '<table style="width: 100%; border-collapse: collapse;">';
                html += '<tr style="background: #ffc107; color: white;"><th style="padding: 8px; text-align: left;">Tenant</th><th>Unit</th><th>Lease End</th><th>Days Left</th><th>Rent</th></tr>';
                warning.forEach(t => {
                    html += `<tr style="border-bottom: 1px solid #ddd;">`;
                    html += `<td style="padding: 8px;">${t.name}</td>`;
                    html += `<td style="padding: 8px;">${t.unit}</td>`;
                    html += `<td style="padding: 8px;">${t.leaseEnd}</td>`;
                    html += `<td style="padding: 8px; color: #ffc107; font-weight: bold;">${t.daysUntilExpiry} days</td>`;
                    html += `<td style="padding: 8px;">KES ${t.rent.toFixed(2)}</td>`;
                    html += `</tr>`;
                });
                html += '</table></div>';
            }
            
            // Notice Leases (60-90 days)
            if (notice.length > 0) {
                html += '<div style="margin: 20px 0; padding: 15px; background: #fffde7; border-left: 4px solid #ffeb3b; border-radius: 4px;">';
                html += '<h5 style="color: #856404; margin: 0 0 10px 0;">‚ö†Ô∏è Notice Period - Expiring in 60-90 Days</h5>';
                html += '<table style="width: 100%; border-collapse: collapse;">';
                html += '<tr style="background: #ffeb3b;"><th style="padding: 8px; text-align: left;">Tenant</th><th>Unit</th><th>Lease End</th><th>Days Left</th><th>Rent</th></tr>';
                notice.forEach(t => {
                    html += `<tr style="border-bottom: 1px solid #ddd;">`;
                    html += `<td style="padding: 8px;">${t.name}</td>`;
                    html += `<td style="padding: 8px;">${t.unit}</td>`;
                    html += `<td style="padding: 8px;">${t.leaseEnd}</td>`;
                    html += `<td style="padding: 8px;">${t.daysUntilExpiry} days (~3 months)</td>`;
                    html += `<td style="padding: 8px;">KES ${t.rent.toFixed(2)}</td>`;
                    html += `</tr>`;
                });
                html += '</table></div>';
            }
            
            // All Active Leases Summary
            html += '<div style="margin: 20px 0;">';
            html += '<h5 style="color: #667eea;">üìã All Active Tenants Summary</h5>';
            html += '<table style="width: 100%; border-collapse: collapse; margin-top: 10px;">';
            html += '<tr style="background: #667eea; color: white;"><th style="padding: 8px; text-align: left;">Tenant</th><th>Unit</th><th>Lease Start</th><th>Lease End</th><th>Status</th><th>Monthly Rent</th></tr>';
            
            tenants.filter(t => t.status === 'Active').forEach(tenant => {
                const statusInfo = getLeaseStatusInfo(tenant);
                html += `<tr style="border-bottom: 1px solid #ddd;">`;
                html += `<td style="padding: 8px;">${tenant.name}</td>`;
                html += `<td style="padding: 8px;">${tenant.unit}</td>`;
                html += `<td style="padding: 8px;">${tenant.leaseStart || 'N/A'}</td>`;
                html += `<td style="padding: 8px;">${tenant.leaseEnd || 'N/A'}</td>`;
                html += `<td style="padding: 8px;">${statusInfo}</td>`;
                html += `<td style="padding: 8px;">KES ${tenant.rent.toFixed(2)}</td>`;
                html += `</tr>`;
            });
            
            html += '</table></div>';
            html += '</div>';
            
            return html;
        }

        function getLeaseStatusInfo(tenant) {
            if (!tenant.leaseEnd) return 'No Lease End';
            
            const today = new Date();
            const leaseEndDate = new Date(tenant.leaseEnd);
            const daysUntilExpiry = Math.floor((leaseEndDate - today) / (1000 * 60 * 60 * 24));
            
            if (daysUntilExpiry < 0) return `<span style="color: #dc3545;">Expired</span>`;
            if (daysUntilExpiry <= 30) return `<span style="color: #dc3545;">${daysUntilExpiry}d - Critical</span>`;
            if (daysUntilExpiry <= 60) return `<span style="color: #ffc107;">${daysUntilExpiry}d - Warning</span>`;
            if (daysUntilExpiry <= 90) return `<span style="color: #ffeb3b;">${daysUntilExpiry}d - Notice</span>`;
            return `<span style="color: #28a745;">${daysUntilExpiry}d - Safe</span>`;
        }

        // Generate Custom Combined Report
        function generateCustomCombinedReport(from, to) {
            let html = '<h4>üìä Custom Combined Report</h4>';
            html += `<p><strong>Date Range:</strong> ${from || 'All Time'} to ${to || 'Present'}</p>`;
            
            const includeEquipment = document.getElementById('includeEquipment')?.checked;
            const includeAttention = document.getElementById('includeAttention')?.checked;
            const includeMaintenance = document.getElementById('includeMaintenance')?.checked;
            const includeTenantLeases = document.getElementById('includeTenantLeases')?.checked;
            const includeRent = document.getElementById('includeRent')?.checked;
            const includeArrears = document.getElementById('includeArrears')?.checked;
            const includeInsurance = document.getElementById('includeInsurance')?.checked;
            
            // Summary Statistics
            let statsCount = 0;
            html += '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin: 20px 0;">';
            
            if (includeEquipment) {
                html += `<div style="background: #667eea; color: white; padding: 15px; border-radius: 8px;"><h5 style="margin: 0;">Equipment</h5><p style="font-size: 24px; margin: 10px 0 0 0;">${equipment.length}</p></div>`;
                statsCount++;
            }
            if (includeTenantLeases) {
                html += `<div style="background: #28a745; color: white; padding: 15px; border-radius: 8px;"><h5 style="margin: 0;">Tenants</h5><p style="font-size: 24px; margin: 10px 0 0 0;">${tenants.length}</p></div>`;
                statsCount++;
            }
            if (includeMaintenance) {
                html += `<div style="background: #ffc107; color: white; padding: 15px; border-radius: 8px;"><h5 style="margin: 0;">Pending Maintenance</h5><p style="font-size: 24px; margin: 10px 0 0 0;">${maintenance.filter(m => m.status !== 'Completed').length}</p></div>`;
                statsCount++;
            }
            if (includeInsurance) {
                html += `<div style="background: #dc3545; color: white; padding: 15px; border-radius: 8px;"><h5 style="margin: 0;">Insurance Claims</h5><p style="font-size: 24px; margin: 10px 0 0 0;">${insuranceClaims.length}</p></div>`;
                statsCount++;
            }
            
            html += '</div>';
            
            // Equipment Section
            if (includeEquipment) {
                html += '<hr style="margin: 30px 0;"><h5 style="color: #667eea;">üì¶ Equipment Overview</h5>';
                html += generateEquipmentDetailedReport();
            }
            
            // Attention Items
            if (includeAttention) {
                html += '<hr style="margin: 30px 0;"><h5 style="color: #dc3545;">‚ö†Ô∏è Items Needing Attention</h5>';
                html += generateAttentionReport();
            }
            
            // Tenant Leases
            if (includeTenantLeases) {
                html += '<hr style="margin: 30px 0;"><h5 style="color: #667eea;">üìÖ Tenant Leases & Expiry</h5>';
                html += generateTenantLeasesReport();
            }
            
            // Maintenance Section
            if (includeMaintenance) {
                html += '<hr style="margin: 30px 0;"><h5 style="color: #667eea;">üîß Maintenance Summary</h5>';
                html += generateMaintenanceReport(from, to);
            }
            
            // Rent Collection
            if (includeRent) {
                html += '<hr style="margin: 30px 0;"><h5 style="color: #667eea;">üí∞ Rent Collection</h5>';
                html += generateRentReport(from, to);
            }
            
            // Arrears
            if (includeArrears) {
                html += '<hr style="margin: 30px 0;"><h5 style="color: #dc3545;">üí≥ Arrears Report</h5>';
                html += generateArrearsReport();
            }
            
            // Insurance Claims
            if (includeInsurance) {
                html += '<hr style="margin: 30px 0;"><h5 style="color: #667eea;">üõ°Ô∏è Insurance Claims</h5>';
                html += generateInsuranceClaimsReport();
            }
            
            // Preventive Maintenance
            const includePM = document.getElementById('includePM')?.checked;
            if (includePM) {
                html += '<hr style="margin: 30px 0;"><h5 style="color: #667eea;">üìÖ Preventive Maintenance</h5>';
                html += generatePMReport();
            }
            
            if (statsCount === 0) {
                html = '<h4>‚ö†Ô∏è No Report Sections Selected</h4><p>Please select at least one report section to include in your custom report.</p>';
            }
            
            return html;
        }

        // Preventive Maintenance Report Functions
        function generatePMReport() {
            const today = new Date();
            
            let html = '<div style="margin-top: 20px;">';
            html += '<h4>üìÖ Preventive Maintenance Schedule Report</h4>';
            html += `<p><strong>Total PM Schedules:</strong> ${preventiveMaintenance.length}</p>`;
            
            if (preventiveMaintenance.length === 0) {
                html += '<p style="color: #6c757d;">No PM schedules created yet.</p></div>';
                return html;
            }
            
            // Summary table
            html += '<table style="width: 100%; border-collapse: collapse; margin-top: 10px;">';
            html += '<tr style="background: #667eea; color: white;"><th style="padding: 8px; text-align: left;">Equipment</th><th>Type</th><th>Frequency</th><th>Next Due</th><th>Status</th><th>Priority</th></tr>';
            
            preventiveMaintenance.forEach(pm => {
                const equip = equipment.find(e => e.id == pm.equipmentId);
                const equipName = equip ? equip.name : 'Unknown';
                
                let daysInfo = 'N/A';
                if (pm.nextDue) {
                    const dueDate = new Date(pm.nextDue);
                    const daysUntil = Math.floor((dueDate - today) / (1000 * 60 * 60 * 24));
                    daysInfo = daysUntil < 0 ? `${Math.abs(daysUntil)}d overdue` : `${daysUntil}d`;
                }
                
                html += `<tr style="border-bottom: 1px solid #ddd;">`;
                html += `<td style="padding: 8px;">${equipName}</td>`;
                html += `<td style="padding: 8px;">${pm.maintenanceType}</td>`;
                html += `<td style="padding: 8px;">${pm.frequency}</td>`;
                html += `<td style="padding: 8px;">${pm.nextDue || 'N/A'}</td>`;
                html += `<td style="padding: 8px;">${daysInfo}</td>`;
                html += `<td style="padding: 8px;">${pm.priority}</td>`;
                html += `</tr>`;
            });
            
            html += '</table></div>';
            return html;
        }

        function generatePMOverdueReport() {
            const today = new Date();
            const overdue = [];
            
            preventiveMaintenance.forEach(pm => {
                if (pm.status !== 'Active' || !pm.nextDue) return;
                
                const dueDate = new Date(pm.nextDue);
                const daysUntil = Math.floor((dueDate - today) / (1000 * 60 * 60 * 24));
                
                if (daysUntil < 0) {
                    const equip = equipment.find(e => e.id == pm.equipmentId);
                    overdue.push({
                        ...pm,
                        daysOverdue: Math.abs(daysUntil),
                        equipName: equip?.name || 'Unknown'
                    });
                }
            });
            
            overdue.sort((a, b) => b.daysOverdue - a.daysOverdue);
            
            let html = '<h4>üî¥ Overdue PM Report</h4>';
            html += `<p><strong>Total Overdue:</strong> ${overdue.length}</p>`;
            
            if (overdue.length === 0) {
                html += '<p style="color: #28a745;">‚úÖ No overdue PM items!</p>';
                return html;
            }
            
            html += '<table style="width: 100%; border-collapse: collapse; margin-top: 10px;">';
            html += '<tr style="background: #dc3545; color: white;"><th style="padding: 8px; text-align: left;">Equipment</th><th>Type</th><th>Due Date</th><th>Days Overdue</th><th>Priority</th></tr>';
            
            overdue.forEach(pm => {
                html += `<tr style="border-bottom: 1px solid #ddd;">`;
                html += `<td style="padding: 8px;"><strong>${pm.equipName}</strong></td>`;
                html += `<td style="padding: 8px;">${pm.maintenanceType}</td>`;
                html += `<td style="padding: 8px;">${pm.nextDue}</td>`;
                html += `<td style="padding: 8px; color: #dc3545; font-weight: bold;">${pm.daysOverdue} days</td>`;
                html += `<td style="padding: 8px;">${pm.priority}</td>`;
                html += `</tr>`;
            });
            
            html += '</table>';
            return html;
        }

        function generatePMHistoryReport(from, to) {
            let filtered = [...pmCompletionHistory];
            
            if (from) filtered = filtered.filter(h => h.completedDate >= from);
            if (to) filtered = filtered.filter(h => h.completedDate <= to);
            
            filtered.sort((a, b) => new Date(b.completedDate) - new Date(a.completedDate));
            
            let html = '<h4>üìä PM Completion History</h4>';
            html += `<p><strong>Date Range:</strong> ${from || 'All Time'} to ${to || 'Present'}</p>`;
            html += `<p><strong>Completions:</strong> ${filtered.length}</p>`;
            
            if (filtered.length === 0) {
                html += '<p style="color: #6c757d;">No completions in this period.</p>';
                return html;
            }
            
            html += '<table style="width: 100%; border-collapse: collapse; margin-top: 10px;">';
            html += '<tr style="background: #667eea; color: white;"><th style="padding: 8px; text-align: left;">Date</th><th>Equipment</th><th>Type</th><th>Completed By</th></tr>';
            
            filtered.forEach(h => {
                const equip = equipment.find(e => e.id == h.equipmentId);
                const equipName = equip?.name || 'Unknown';
                const completedDate = new Date(h.completedDate).toLocaleDateString();
                
                html += `<tr style="border-bottom: 1px solid #ddd;">`;
                html += `<td style="padding: 8px;">${completedDate}</td>`;
                html += `<td style="padding: 8px;">${equipName}</td>`;
                html += `<td style="padding: 8px;">${h.maintenanceType}</td>`;
                html += `<td style="padding: 8px;">${h.completedBy || 'N/A'}</td>`;
                html += `</tr>`;
            });
            
            html += '</table>';
            return html;
        }

        // Preventive Maintenance Functions
        function updatePMEquipmentDropdown() {
            const dropdown = document.getElementById('pmEquipment');
            if (dropdown) {
                dropdown.innerHTML = '<option value="">Select Equipment</option>' + 
                    equipment.map(item => {
                        const locationInfo = [item.floor, item.section, item.location].filter(Boolean).join(' - ') || 'Location N/A';
                        return `<option value="${item.id}">${item.name} (${locationInfo})</option>`;
                    }).join('');
            }
        }

        function addPreventiveMaintenance() {
            const equipmentId = document.getElementById('pmEquipment').value;
            if (!equipmentId) {
                alert('Please select equipment');
                return;
            }

            const pm = {
                id: Date.now(),
                equipmentId: parseInt(equipmentId),
                maintenanceType: document.getElementById('pmType').value,
                frequency: document.getElementById('pmFrequency').value,
                nextDue: document.getElementById('pmNextDue').value,
                duration: parseInt(document.getElementById('pmDuration').value) || 30,
                assignedTo: document.getElementById('pmAssignedTo').value,
                priority: document.getElementById('pmPriority').value,
                status: document.getElementById('pmStatus').value,
                tasks: document.getElementById('pmTasks').value,
                notes: document.getElementById('pmNotes').value,
                createdAt: new Date().toISOString(),
                lastCompleted: null,
                completionCount: 0
            };

            if (!pm.nextDue) {
                alert('Please set next due date');
                return;
            }

            preventiveMaintenance.push(pm);
            saveData('preventiveMaintenance', preventiveMaintenance);
            renderPMSchedules();
            updatePMStats();
            clearPMForm();
        }

        function clearPMForm() {
            document.getElementById('pmEquipment').value = '';
            document.getElementById('pmType').value = 'Inspection';
            document.getElementById('pmFrequency').value = 'Monthly';
            document.getElementById('pmNextDue').value = '';
            document.getElementById('pmDuration').value = '';
            document.getElementById('pmAssignedTo').value = '';
            document.getElementById('pmPriority').value = 'Medium';
            document.getElementById('pmStatus').value = 'Active';
            document.getElementById('pmTasks').value = '';
            document.getElementById('pmNotes').value = '';
        }

        function renderPMSchedules() {
            const list = document.getElementById('pmSchedulesList');
            if (!list) return;

            if (preventiveMaintenance.length === 0) {
                list.innerHTML = '<tr><td colspan="8" style="text-align: center; padding: 40px; color: #6c757d;">No preventive maintenance schedules yet. Create your first schedule above!</td></tr>';
                return;
            }

            const today = new Date();

            list.innerHTML = preventiveMaintenance.map(pm => {
                const equip = equipment.find(e => e.id == pm.equipmentId);
                const equipName = equip ? equip.name : 'Unknown Equipment';
                
                let daysUntilDue = 'N/A';
                let dueBadge = '<span class="badge badge-secondary">No Date</span>';
                
                if (pm.nextDue) {
                    const dueDate = new Date(pm.nextDue);
                    const daysUntil = Math.floor((dueDate - today) / (1000 * 60 * 60 * 24));
                    daysUntilDue = daysUntil;
                    
                    if (daysUntil < 0) {
                        dueBadge = `<span class="badge badge-danger">‚ö†Ô∏è ${Math.abs(daysUntil)}d overdue</span>`;
                    } else if (daysUntil === 0) {
                        dueBadge = '<span class="badge badge-danger">üî¥ Due Today</span>';
                    } else if (daysUntil <= 7) {
                        dueBadge = `<span class="badge badge-warning">üü° ${daysUntil}d</span>`;
                    } else {
                        dueBadge = `<span class="badge badge-success">‚úÖ ${daysUntil}d</span>`;
                    }
                }

                const priorityColor = {
                    'Low': 'secondary',
                    'Medium': 'info',
                    'High': 'warning',
                    'Critical': 'danger'
                }[pm.priority] || 'secondary';

                return `
                <tr>
                    <td>${equipName}</td>
                    <td>${pm.maintenanceType}</td>
                    <td>${pm.frequency}</td>
                    <td>${pm.nextDue || 'N/A'}</td>
                    <td>${dueBadge}</td>
                    <td><span class="badge badge-${priorityColor}">${pm.priority}</span></td>
                    <td><span class="badge badge-${pm.status === 'Active' ? 'success' : 'secondary'}">${pm.status}</span></td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn btn-success" onclick="completePM(${pm.id})" title="Mark as Complete">‚úì</button>
                            <button class="btn btn-warning" onclick="editPM(${pm.id})">Edit</button>
                            <button class="btn btn-danger" onclick="deletePM(${pm.id})">Delete</button>
                        </div>
                    </td>
                </tr>
            `;
            }).join('');

            renderPMOverdueWarnings();
        }

        function updatePMStats() {
            const today = new Date();
            let activeCount = 0;
            let overdueCount = 0;
            let dueWeekCount = 0;
            
            // Calculate completed this month
            const thisMonth = new Date().getMonth();
            const thisYear = new Date().getFullYear();
            const completedThisMonth = pmCompletionHistory.filter(h => {
                const completedDate = new Date(h.completedDate);
                return completedDate.getMonth() === thisMonth && completedDate.getFullYear() === thisYear;
            }).length;

            preventiveMaintenance.forEach(pm => {
                if (pm.status === 'Active') {
                    activeCount++;
                    
                    if (pm.nextDue) {
                        const dueDate = new Date(pm.nextDue);
                        const daysUntil = Math.floor((dueDate - today) / (1000 * 60 * 60 * 24));
                        
                        if (daysUntil < 0) {
                            overdueCount++;
                        } else if (daysUntil <= 7) {
                            dueWeekCount++;
                        }
                    }
                }
            });

            const activeEl = document.getElementById('activePMCount');
            const overdueEl = document.getElementById('overduePMCount');
            const dueWeekEl = document.getElementById('dueWeekPMCount');
            const completedEl = document.getElementById('completedPMCount');

            if (activeEl) activeEl.textContent = activeCount;
            if (overdueEl) overdueEl.textContent = overdueCount;
            if (dueWeekEl) dueWeekEl.textContent = dueWeekCount;
            if (completedEl) completedEl.textContent = completedThisMonth;
        }

        function renderPMOverdueWarnings() {
            const today = new Date();
            const overdue = [];
            const dueSoon = [];

            preventiveMaintenance.forEach(pm => {
                if (pm.status !== 'Active' || !pm.nextDue) return;
                
                const dueDate = new Date(pm.nextDue);
                const daysUntil = Math.floor((dueDate - today) / (1000 * 60 * 60 * 24));
                const equip = equipment.find(e => e.id == pm.equipmentId);
                
                if (daysUntil < 0) {
                    overdue.push({ ...pm, daysUntil, equipName: equip?.name || 'Unknown' });
                } else if (daysUntil <= 7) {
                    dueSoon.push({ ...pm, daysUntil, equipName: equip?.name || 'Unknown' });
                }
            });

            const warningsDiv = document.getElementById('pmOverdueWarnings');
            if (!warningsDiv) return;

            if (overdue.length === 0 && dueSoon.length === 0) {
                warningsDiv.innerHTML = '';
                return;
            }

            let html = '<div style="padding: 20px; background: #fff3cd; border-left: 4px solid #ffc107; border-radius: 8px;">';
            html += '<h4 style="margin: 0 0 15px 0; color: #856404;">‚ö†Ô∏è Preventive Maintenance Alerts</h4>';
            
            if (overdue.length > 0) {
                html += '<div style="margin-bottom: 15px;">';
                html += '<strong style="color: #dc3545;">üî¥ Overdue Maintenance:</strong>';
                overdue.forEach(pm => {
                    html += `<div style="padding: 8px; margin-top: 5px; background: white; border-radius: 4px; color: #dc3545;">`;
                    html += `${pm.equipName} - ${pm.maintenanceType} (${Math.abs(pm.daysUntil)} days overdue)`;
                    html += `</div>`;
                });
                html += '</div>';
            }

            if (dueSoon.length > 0) {
                html += '<div>';
                html += '<strong style="color: #856404;">üü° Due This Week:</strong>';
                dueSoon.forEach(pm => {
                    html += `<div style="padding: 8px; margin-top: 5px; background: white; border-radius: 4px; color: #856404;">`;
                    html += `${pm.equipName} - ${pm.maintenanceType} (${pm.daysUntil} days)`;
                    html += `</div>`;
                });
                html += '</div>';
            }

            html += '</div>';
            warningsDiv.innerHTML = html;
        }

        function completePM(id) {
            const pm = preventiveMaintenance.find(p => p.id === id);
            if (!pm) return;

            const equip = equipment.find(e => e.id == pm.equipmentId);
            const equipName = equip ? equip.name : 'Unknown Equipment';

            if (!confirm(`Mark "${equipName} - ${pm.maintenanceType}" as complete?`)) return;

            // Record completion
            const completion = {
                id: Date.now(),
                pmId: pm.id,
                equipmentId: pm.equipmentId,
                maintenanceType: pm.maintenanceType,
                completedDate: new Date().toISOString(),
                completedBy: pm.assignedTo || 'Unknown',
                notes: ''
            };

            pmCompletionHistory.push(completion);
            saveData('pmCompletionHistory', pmCompletionHistory);

            // Update PM schedule
            pm.lastCompleted = completion.completedDate;
            pm.completionCount = (pm.completionCount || 0) + 1;
            
            // Calculate next due date
            const nextDue = calculateNextDueDate(new Date(), pm.frequency);
            pm.nextDue = nextDue.toISOString().split('T')[0];

            saveData('preventiveMaintenance', preventiveMaintenance);
            renderPMSchedules();
            updatePMStats();

            alert(`‚úÖ Maintenance completed! Next due: ${pm.nextDue}`);
        }

        function calculateNextDueDate(fromDate, frequency) {
            const nextDate = new Date(fromDate);
            
            switch(frequency) {
                case 'Weekly':
                    nextDate.setDate(nextDate.getDate() + 7);
                    break;
                case 'Bi-weekly':
                    nextDate.setDate(nextDate.getDate() + 14);
                    break;
                case 'Monthly':
                    nextDate.setMonth(nextDate.getMonth() + 1);
                    break;
                case 'Quarterly':
                    nextDate.setMonth(nextDate.getMonth() + 3);
                    break;
                case 'Semi-annually':
                    nextDate.setMonth(nextDate.getMonth() + 6);
                    break;
                case 'Annually':
                    nextDate.setFullYear(nextDate.getFullYear() + 1);
                    break;
            }
            
            return nextDate;
        }

        function editPM(id) {
            const pm = preventiveMaintenance.find(p => p.id === id);
            if (!pm) return;

            document.getElementById('pmEquipment').value = pm.equipmentId;
            document.getElementById('pmType').value = pm.maintenanceType;
            document.getElementById('pmFrequency').value = pm.frequency;
            document.getElementById('pmNextDue').value = pm.nextDue;
            document.getElementById('pmDuration').value = pm.duration;
            document.getElementById('pmAssignedTo').value = pm.assignedTo || '';
            document.getElementById('pmPriority').value = pm.priority;
            document.getElementById('pmStatus').value = pm.status;
            document.getElementById('pmTasks').value = pm.tasks || '';
            document.getElementById('pmNotes').value = pm.notes || '';

            const addButton = document.querySelector('#preventive .btn-primary');
            addButton.textContent = 'Update PM Schedule';
            addButton.onclick = () => updatePM(id);

            document.querySelector('#preventive .form-section').scrollIntoView({ behavior: 'smooth' });
        }

        function updatePM(id) {
            const pmIndex = preventiveMaintenance.findIndex(p => p.id === id);
            if (pmIndex === -1) return;

            preventiveMaintenance[pmIndex] = {
                ...preventiveMaintenance[pmIndex],
                equipmentId: parseInt(document.getElementById('pmEquipment').value),
                maintenanceType: document.getElementById('pmType').value,
                frequency: document.getElementById('pmFrequency').value,
                nextDue: document.getElementById('pmNextDue').value,
                duration: parseInt(document.getElementById('pmDuration').value) || 30,
                assignedTo: document.getElementById('pmAssignedTo').value,
                priority: document.getElementById('pmPriority').value,
                status: document.getElementById('pmStatus').value,
                tasks: document.getElementById('pmTasks').value,
                notes: document.getElementById('pmNotes').value
            };

            saveData('preventiveMaintenance', preventiveMaintenance);
            renderPMSchedules();
            updatePMStats();
            clearPMForm();

            const addButton = document.querySelector('#preventive .btn-primary');
            addButton.textContent = 'Add PM Schedule';
            addButton.onclick = addPreventiveMaintenance;
        }

        function deletePM(id) {
            if (confirm('Are you sure you want to delete this PM schedule?')) {
                preventiveMaintenance = preventiveMaintenance.filter(p => p.id !== id);
                saveData('preventiveMaintenance', preventiveMaintenance);
                renderPMSchedules();
                updatePMStats();
            }
        }

        function filterPMSchedules() {
            const search = document.getElementById('pmSearch').value.toLowerCase();
            const statusFilter = document.getElementById('pmFilterStatus').value;
            const today = new Date();

            let filtered = preventiveMaintenance.filter(pm => {
                const equip = equipment.find(e => e.id == pm.equipmentId);
                const equipName = equip ? equip.name.toLowerCase() : '';
                
                const matchesSearch = equipName.includes(search) || 
                                     pm.maintenanceType.toLowerCase().includes(search);
                
                let matchesStatus = true;
                if (statusFilter === 'Active') {
                    matchesStatus = pm.status === 'Active';
                } else if (statusFilter === 'Overdue') {
                    if (pm.nextDue) {
                        const dueDate = new Date(pm.nextDue);
                        const daysUntil = Math.floor((dueDate - today) / (1000 * 60 * 60 * 24));
                        matchesStatus = daysUntil < 0;
                    } else {
                        matchesStatus = false;
                    }
                } else if (statusFilter === 'Due Soon') {
                    if (pm.nextDue) {
                        const dueDate = new Date(pm.nextDue);
                        const daysUntil = Math.floor((dueDate - today) / (1000 * 60 * 60 * 24));
                        matchesStatus = daysUntil >= 0 && daysUntil <= 7;
                    } else {
                        matchesStatus = false;
                    }
                }

                return matchesSearch && matchesStatus;
            });

            // Re-render with filtered data temporarily
            const list = document.getElementById('pmSchedulesList');
            if (filtered.length === 0) {
                list.innerHTML = '<tr><td colspan="8" style="text-align: center; padding: 40px; color: #6c757d;">No PM schedules match your search</td></tr>';
                return;
            }

            // Would need to duplicate renderPMSchedules logic here for filtered data
            // For simplicity, just re-render all
            renderPMSchedules();
        }

        // History Report Functions
        function generateMaintenanceHistoryReport(from, to) {
            // Only show completed maintenance
            let completed = maintenance.filter(m => m.status === 'Completed');
            
            if (from) completed = completed.filter(m => m.date >= from);
            if (to) completed = completed.filter(m => m.date <= to);
            
            // Sort by date (newest first)
            completed.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            const totalCost = completed.reduce((sum, m) => sum + m.cost, 0);
            
            let html = '<h4>üìã Maintenance History (Completed Archive)</h4>';
            html += `<p><strong>Date Range:</strong> ${from || 'All Time'} to ${to || 'Present'}</p>`;
            html += `<p><strong>Total Completed Tasks:</strong> ${completed.length}</p>`;
            html += `<p><strong>Total Cost:</strong> KES ${totalCost.toFixed(2)}</p>`;
            
            if (completed.length === 0) {
                html += '<p style="color: #6c757d; margin-top: 20px;">No completed maintenance tasks in this period.</p>';
                return html;
            }
            
            // Group by month
            const byMonth = {};
            completed.forEach(m => {
                const monthKey = m.date.substring(0, 7); // YYYY-MM
                if (!byMonth[monthKey]) byMonth[monthKey] = [];
                byMonth[monthKey].push(m);
            });
            
            // Summary by month
            html += '<div style="margin: 20px 0;"><h5>Monthly Summary</h5><ul>';
            Object.keys(byMonth).sort().reverse().forEach(month => {
                const tasks = byMonth[month];
                const monthCost = tasks.reduce((sum, m) => sum + m.cost, 0);
                html += `<li><strong>${month}:</strong> ${tasks.length} tasks, KES ${monthCost.toFixed(2)}</li>`;
            });
            html += '</ul></div>';
            
            // Detailed list
            html += '<div style="margin: 20px 0;"><h5>Completed Tasks Details</h5>';
            html += '<table style="width: 100%; border-collapse: collapse;">';
            html += '<tr style="background: #667eea; color: white;"><th style="padding: 8px; text-align: left;">Date</th><th>Property</th><th>Type</th><th>Description</th><th>Assigned To</th><th>Cost</th></tr>';
            
            completed.forEach(m => {
                const equip = equipment.find(e => e.id == m.equipmentId);
                const equipName = equip ? equip.name : 'N/A';
                
                html += `<tr style="border-bottom: 1px solid #ddd;">`;
                html += `<td style="padding: 8px;">${m.date}</td>`;
                html += `<td style="padding: 8px;">${m.property}</td>`;
                html += `<td style="padding: 8px;">${m.type}</td>`;
                html += `<td style="padding: 8px;">${m.description.substring(0, 60)}${m.description.length > 60 ? '...' : ''}</td>`;
                html += `<td style="padding: 8px;">${m.assignedTo || 'Unassigned'}</td>`;
                html += `<td style="padding: 8px;">KES ${m.cost.toFixed(2)}</td>`;
                html += `</tr>`;
            });
            
            html += '</table></div>';
            return html;
        }

        function generateEquipmentHistoryReport(from, to) {
            // This would track equipment changes - for now show current inventory with acquisition dates
            let html = '<h4>üì¶ Equipment History Report</h4>';
            html += `<p><strong>Date Range:</strong> ${from || 'All Time'} to ${to || 'Present'}</p>`;
            html += `<p><strong>Total Equipment Items:</strong> ${equipment.length}</p>`;
            
            // Group by acquisition year (if we had that data)
            html += '<div style="margin: 20px 0;"><h5>Current Equipment Inventory</h5>';
            html += '<table style="width: 100%; border-collapse: collapse;">';
            html += '<tr style="background: #667eea; color: white;"><th style="padding: 8px; text-align: left;">Equipment</th><th>Category</th><th>Floor</th><th>Section</th><th>Quantity</th><th>Status</th><th>Warranty Until</th></tr>';
            
            equipment.forEach(e => {
                html += `<tr style="border-bottom: 1px solid #ddd;">`;
                html += `<td style="padding: 8px;">${e.name}</td>`;
                html += `<td style="padding: 8px;">${e.category}</td>`;
                html += `<td style="padding: 8px;">${e.floor || 'N/A'}</td>`;
                html += `<td style="padding: 8px;">${e.section || 'N/A'}</td>`;
                html += `<td style="padding: 8px;">${e.quantity || 1}</td>`;
                html += `<td style="padding: 8px;">${e.status}</td>`;
                html += `<td style="padding: 8px;">${e.warrantyExpiry || 'N/A'}</td>`;
                html += `</tr>`;
            });
            
            html += '</table></div>';
            
            html += '<p style="margin-top: 20px; color: #6c757d; font-size: 14px;">üí° Tip: Equipment changes and additions are tracked. Future versions will show detailed change history.</p>';
            
            return html;
        }

        function generateRentHistoryReport(from, to) {
            let filtered = [...payments];
            
            if (from) filtered = filtered.filter(p => p.date >= from);
            if (to) filtered = filtered.filter(p => p.date <= to);
            
            // Sort by date (newest first)
            filtered.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            const total = filtered.reduce((sum, p) => sum + p.amount, 0);
            
            let html = '<h4>üí∞ Rent Payment History</h4>';
            html += `<p><strong>Date Range:</strong> ${from || 'All Time'} to ${to || 'Present'}</p>`;
            html += `<p><strong>Total Payments:</strong> ${filtered.length}</p>`;
            html += `<p><strong>Total Amount Collected:</strong> KES ${total.toFixed(2)}</p>`;
            
            if (filtered.length === 0) {
                html += '<p style="color: #6c757d; margin-top: 20px;">No rent payments in this period.</p>';
                return html;
            }
            
            // Group by tenant
            const byTenant = {};
            filtered.forEach(p => {
                const tenant = tenants.find(t => t.id === p.tenantId);
                const tenantName = tenant ? tenant.name : 'Unknown Tenant';
                if (!byTenant[tenantName]) {
                    byTenant[tenantName] = {
                        payments: [],
                        total: 0,
                        unit: tenant ? tenant.unit : 'N/A'
                    };
                }
                byTenant[tenantName].payments.push(p);
                byTenant[tenantName].total += p.amount;
            });
            
            // Summary by tenant
            html += '<div style="margin: 20px 0;"><h5>Summary by Tenant</h5>';
            html += '<table style="width: 100%; border-collapse: collapse;">';
            html += '<tr style="background: #28a745; color: white;"><th style="padding: 8px; text-align: left;">Tenant</th><th>Unit</th><th>Payments</th><th>Total Amount</th></tr>';
            
            Object.keys(byTenant).sort().forEach(tenantName => {
                const data = byTenant[tenantName];
                html += `<tr style="border-bottom: 1px solid #ddd;">`;
                html += `<td style="padding: 8px;">${tenantName}</td>`;
                html += `<td style="padding: 8px;">${data.unit}</td>`;
                html += `<td style="padding: 8px;">${data.payments.length}</td>`;
                html += `<td style="padding: 8px;">KES ${data.total.toFixed(2)}</td>`;
                html += `</tr>`;
            });
            html += '</table></div>';
            
            // Detailed payment list
            html += '<div style="margin: 20px 0;"><h5>Payment Details</h5>';
            html += '<table style="width: 100%; border-collapse: collapse;">';
            html += '<tr style="background: #667eea; color: white;"><th style="padding: 8px; text-align: left;">Date</th><th>Tenant</th><th>Unit</th><th>Amount</th><th>Method</th></tr>';
            
            filtered.forEach(p => {
                const tenant = tenants.find(t => t.id === p.tenantId);
                html += `<tr style="border-bottom: 1px solid #ddd;">`;
                html += `<td style="padding: 8px;">${p.date}</td>`;
                html += `<td style="padding: 8px;">${tenant ? tenant.name : 'Unknown'}</td>`;
                html += `<td style="padding: 8px;">${tenant ? tenant.unit : 'N/A'}</td>`;
                html += `<td style="padding: 8px;">KES ${p.amount.toFixed(2)}</td>`;
                html += `<td style="padding: 8px;">${p.method}</td>`;
                html += `</tr>`;
            });
            
            html += '</table></div>';
            return html;
        }

        function generateEscalationHistoryReport(from, to) {
            let html = '<h4>üìà Rent Escalation History</h4>';
            html += `<p><strong>Date Range:</strong> ${from || 'All Time'} to ${to || 'Present'}</p>`;
            
            const tenantsWithEscalations = tenants.filter(t => t.escalationHistory && t.escalationHistory.length > 0);
            
            if (tenantsWithEscalations.length === 0) {
                html += '<p style="color: #6c757d; margin-top: 20px;">No rent escalations executed yet.</p>';
                return html;
            }
            
            html += `<p><strong>Tenants with Escalations:</strong> ${tenantsWithEscalations.length}</p>`;
            
            // Collect all escalations
            const allEscalations = [];
            tenantsWithEscalations.forEach(tenant => {
                tenant.escalationHistory.forEach(esc => {
                    allEscalations.push({
                        ...esc,
                        tenantName: tenant.name,
                        unit: tenant.unit
                    });
                });
            });
            
            // Filter by date
            let filtered = allEscalations;
            if (from) filtered = filtered.filter(e => e.date >= from);
            if (to) filtered = filtered.filter(e => e.date <= to);
            
            // Sort by date (newest first)
            filtered.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            html += `<p><strong>Total Escalations:</strong> ${filtered.length}</p>`;
            
            if (filtered.length === 0) {
                html += '<p style="color: #6c757d; margin-top: 20px;">No escalations in the selected date range.</p>';
                return html;
            }
            
            // Calculate total increase
            const totalIncrease = filtered.reduce((sum, e) => sum + (e.newRent - e.oldRent), 0);
            html += `<p><strong>Total Rent Increase:</strong> KES ${totalIncrease.toFixed(2)}</p>`;
            
            // Detailed table
            html += '<div style="margin: 20px 0;">';
            html += '<table style="width: 100%; border-collapse: collapse;">';
            html += '<tr style="background: #667eea; color: white;"><th style="padding: 8px; text-align: left;">Date</th><th>Tenant</th><th>Unit</th><th>Type</th><th>Old Rent</th><th>New Rent</th><th>Increase</th><th>Rate</th></tr>';
            
            filtered.forEach(e => {
                const increase = e.newRent - e.oldRent;
                html += `<tr style="border-bottom: 1px solid #ddd;">`;
                html += `<td style="padding: 8px;">${e.date}</td>`;
                html += `<td style="padding: 8px;">${e.tenantName}</td>`;
                html += `<td style="padding: 8px;">${e.unit}</td>`;
                html += `<td style="padding: 8px;">${e.type}</td>`;
                html += `<td style="padding: 8px;">KES ${e.oldRent.toFixed(2)}</td>`;
                html += `<td style="padding: 8px;">KES ${e.newRent.toFixed(2)}</td>`;
                html += `<td style="padding: 8px; color: #28a745; font-weight: bold;">+KES ${increase.toFixed(2)}</td>`;
                html += `<td style="padding: 8px;">${e.rate}%</td>`;
                html += `</tr>`;
            });
            
            html += '</table></div>';
            return html;
        }

        // PDF Generation and Sharing Functions
        let currentReportData = null;

        function downloadReportPDF() {
            const reportType = document.getElementById('reportType').value;
            const dateFrom = document.getElementById('reportFrom').value;
            const dateTo = document.getElementById('reportTo').value;

            // Initialize jsPDF
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            // Add decorative header box
            doc.setDrawColor(102, 126, 234);
            doc.setLineWidth(0.5);
            doc.rect(15, 10, 180, 35);
            
            // Add inner decorative line
            doc.setDrawColor(118, 75, 162);
            doc.setLineWidth(0.3);
            doc.rect(17, 12, 176, 31);

            // Add organization name
            doc.setFontSize(22);
            doc.setFont(undefined, 'bold');
            doc.setTextColor(102, 126, 234);
            doc.text("ADAM'S MASJID", 105, 22, { align: 'center' });
            
            // Add subtitle
            doc.setFontSize(12);
            doc.setFont(undefined, 'normal');
            doc.setTextColor(80, 80, 80);
            doc.text('Property Management System', 105, 30, { align: 'center' });
            
            // Add report title
            doc.setFontSize(14);
            doc.setFont(undefined, 'bold');
            doc.setTextColor(0, 0, 0);
            doc.text('Property Management Report', 105, 38, { align: 'center' });

            // Add report details below header box
            doc.setFontSize(9);
            doc.setFont(undefined, 'normal');
            doc.setTextColor(100, 100, 100);
            const reportDate = new Date().toLocaleDateString('en-US', { 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            });
            doc.text(`Report Generated: ${reportDate}`, 105, 52, { align: 'center' });
            
            if (dateFrom || dateTo) {
                const dateRange = `Report Period: ${dateFrom || 'Beginning'} to ${dateTo || 'Present'}`;
                doc.text(dateRange, 105, 58, { align: 'center' });
            }

            doc.setTextColor(0, 0, 0);
            let yPos = dateFrom || dateTo ? 68 : 62;

            // Generate report based on type
            switch(reportType) {
                case 'maintenance':
                    generateMaintenancePDF(doc, yPos, dateFrom, dateTo);
                    break;
                case 'equipment':
                    generateEquipmentPDF(doc, yPos);
                    break;
                case 'equipment-detailed':
                    generateEquipmentDetailedPDF(doc, yPos);
                    break;
                case 'equipment-attention':
                    generateAttentionPDF(doc, yPos);
                    break;
                case 'preventive-maintenance':
                    generatePMPDF(doc, yPos);
                    break;
                case 'pm-overdue':
                    generatePMOverduePDF(doc, yPos);
                    break;
                case 'pm-history':
                    generatePMHistoryPDF(doc, yPos, dateFrom, dateTo);
                    break;
                case 'tenants-leases':
                    generateTenantLeasesPDF(doc, yPos);
                    break;
                case 'insurance-claims':
                    generateInsuranceClaimsPDF(doc, yPos);
                    break;
                case 'rent':
                    generateRentPDF(doc, yPos, dateFrom, dateTo);
                    break;
                case 'arrears':
                    generateArrearsPDF(doc, yPos);
                    break;
                case 'tenants':
                    generateTenantsPDF(doc, yPos);
                    break;
                case 'combined':
                case 'custom-combined':
                    // For combined reports, use HTML to PDF approach
                    generateCombinedPDF(doc, yPos, reportType, dateFrom, dateTo);
                    break;
                default:
                    doc.setFontSize(12);
                    doc.text('Report type not supported for PDF export yet.', 20, yPos);
                    doc.text('Please use the on-screen report view.', 20, yPos + 10);
            }

            // Add footer to all pages
            const pageCount = doc.internal.getNumberOfPages();
            for (let i = 1; i <= pageCount; i++) {
                doc.setPage(i);
                
                // Footer line
                doc.setDrawColor(102, 126, 234);
                doc.setLineWidth(0.3);
                doc.line(20, 280, 190, 280);
                
                // Footer text
                doc.setFontSize(8);
                doc.setTextColor(100, 100, 100);
                doc.text("Adam's Masjid Property Management System", 20, 285);
                doc.text(`Page ${i} of ${pageCount}`, 190, 285, { align: 'right' });
                
                // System info
                doc.setFontSize(7);
                doc.text('Generated from Adam\'s Masjid Property Management System', 105, 290, { align: 'center' });
            }

            // Save PDF
            const fileName = `Adams-Masjid-${reportType}-Report-${reportDate.replace(/\//g, '-')}.pdf`;
            doc.save(fileName);
        }

        function generateMaintenancePDF(doc, startY, from, to) {
            let filtered = maintenance;
            if (from) filtered = filtered.filter(m => m.date >= from);
            if (to) filtered = filtered.filter(m => m.date <= to);

            const totalCost = filtered.reduce((sum, m) => sum + m.cost, 0);
            const byStatus = {};
            const byPriority = {};
            filtered.forEach(m => {
                byStatus[m.status] = (byStatus[m.status] || 0) + 1;
                byPriority[m.priority] = (byPriority[m.priority] || 0) + 1;
            });

            doc.setFontSize(14);
            doc.setFont(undefined, 'bold');
            doc.text('Maintenance Summary Report', 20, startY);

            doc.setFontSize(10);
            doc.setFont(undefined, 'normal');
            doc.text(`Total Tasks: ${filtered.length}`, 20, startY + 8);
            doc.text(`Total Cost: KES ${totalCost.toFixed(2)}`, 20, startY + 14);
            
            // Status breakdown
            let statusText = 'By Status: ';
            Object.entries(byStatus).forEach(([status, count], idx) => {
                statusText += `${status}: ${count}${idx < Object.keys(byStatus).length - 1 ? ', ' : ''}`;
            });
            doc.setFontSize(9);
            doc.text(statusText, 20, startY + 20);
            
            // Priority breakdown
            let priorityText = 'By Priority: ';
            Object.entries(byPriority).forEach(([priority, count], idx) => {
                priorityText += `${priority}: ${count}${idx < Object.keys(byPriority).length - 1 ? ', ' : ''}`;
            });
            doc.text(priorityText, 20, startY + 26);

            if (filtered.length === 0) {
                doc.setFontSize(10);
                doc.text('No maintenance tasks in this period.', 20, startY + 35);
                return;
            }

            // Create detailed table
            const tableData = filtered.map(m => {
                const equip = equipment.find(e => e.id == m.equipmentId);
                const equipName = equip ? equip.name : 'N/A';
                
                return [
                    m.date,
                    m.property,
                    m.type,
                    equipName.substring(0, 25),
                    m.priority,
                    m.status,
                    m.assignedTo || 'N/A',
                    `KES ${m.cost.toFixed(0)}`
                ];
            });

            doc.autoTable({
                startY: startY + 32,
                head: [['Date', 'Property', 'Type', 'Equipment', 'Priority', 'Status', 'Assigned To', 'Cost']],
                body: tableData,
                theme: 'striped',
                headStyles: { 
                    fillColor: [102, 126, 234],
                    fontSize: 8,
                    fontStyle: 'bold'
                },
                styles: { fontSize: 7 },
                columnStyles: {
                    0: { cellWidth: 20 },
                    1: { cellWidth: 25 },
                    2: { cellWidth: 25 },
                    3: { cellWidth: 25 },
                    4: { cellWidth: 18 },
                    5: { cellWidth: 20 },
                    6: { cellWidth: 25 },
                    7: { cellWidth: 20 }
                }
            });
            
            // Add notes section on new page if there are tasks with descriptions
            const tasksWithDesc = filtered.filter(m => m.description && m.description.trim());
            if (tasksWithDesc.length > 0) {
                doc.addPage();
                let detailY = 20;
                
                doc.setFontSize(12);
                doc.setFont(undefined, 'bold');
                doc.text('Maintenance Task Details', 20, detailY);
                
                detailY += 10;
                
                tasksWithDesc.forEach((m, idx) => {
                    if (detailY > 270) {
                        doc.addPage();
                        detailY = 20;
                    }
                    
                    doc.setFontSize(10);
                    doc.setFont(undefined, 'bold');
                    doc.text(`${idx + 1}. ${m.property} - ${m.type}`, 20, detailY);
                    
                    detailY += 6;
                    doc.setFontSize(8);
                    doc.setFont(undefined, 'normal');
                    doc.text(`Date: ${m.date} | Priority: ${m.priority} | Status: ${m.status}`, 25, detailY);
                    
                    detailY += 5;
                    doc.setFont(undefined, 'italic');
                    const descLines = doc.splitTextToSize(m.description, 165);
                    doc.text(descLines, 25, detailY);
                    
                    detailY += (descLines.length * 4) + 6;
                });
            }
        }

        function generateEquipmentPDF(doc, startY) {
            doc.setFontSize(14);
            doc.setFont(undefined, 'bold');
            doc.text('Equipment Inventory Report', 20, startY);

            doc.setFontSize(11);
            doc.setFont(undefined, 'normal');
            doc.text(`Total Equipment Items: ${equipment.length}`, 20, startY + 10);
            
            // Calculate total quantity
            const totalQty = equipment.reduce((sum, e) => sum + (e.quantity || 1), 0);
            doc.text(`Total Quantity: ${totalQty} units`, 20, startY + 17);

            const tableData = equipment.map(e => [
                e.name,
                e.category,
                e.floor || 'N/A',
                e.section || 'N/A',
                e.quantity || 1,
                e.status,
                e.nextService || 'N/A'
            ]);

            doc.autoTable({
                startY: startY + 25,
                head: [['Equipment', 'Category', 'Floor', 'Section', 'Qty', 'Status', 'Next Service']],
                body: tableData,
                theme: 'striped',
                headStyles: { 
                    fillColor: [102, 126, 234],
                    fontSize: 9,
                    fontStyle: 'bold'
                },
                styles: { fontSize: 8 },
                columnStyles: {
                    0: { cellWidth: 35 },
                    1: { cellWidth: 35 },
                    2: { cellWidth: 25 },
                    3: { cellWidth: 30 },
                    4: { cellWidth: 15 },
                    5: { cellWidth: 25 },
                    6: { cellWidth: 25 }
                }
            });
        }

        function generateRentPDF(doc, startY, from, to) {
            let filtered = payments;
            if (from) filtered = filtered.filter(p => p.date >= from);
            if (to) filtered = filtered.filter(p => p.date <= to);

            const total = filtered.reduce((sum, p) => sum + p.amount, 0);

            doc.setFontSize(14);
            doc.text('Rent Collection Report', 20, startY);

            doc.setFontSize(11);
            doc.text(`Total Payments: ${filtered.length}`, 20, startY + 10);
            doc.text(`Total Collected: KES ${total.toFixed(2)}`, 20, startY + 17);

            const tableData = filtered.map(p => {
                const tenant = tenants.find(t => t.id === p.tenantId);
                return [
                    p.date,
                    tenant ? tenant.name : 'Unknown',
                    tenant ? tenant.unit : 'N/A',
                    `KES ${p.amount.toFixed(2)}`,
                    p.method
                ];
            });

            doc.autoTable({
                startY: startY + 25,
                head: [['Date', 'Tenant', 'Unit', 'Amount', 'Method']],
                body: tableData,
                theme: 'striped',
                headStyles: { fillColor: [102, 126, 234] }
            });
        }

        function generateArrearsPDF(doc, startY) {
            doc.setFontSize(14);
            doc.setFont(undefined, 'bold');
            doc.text('Arrears Report', 20, startY);

            const arrearsData = [];
            let totalArrears = 0;

            tenants.forEach(tenant => {
                const tenantPayments = payments.filter(p => p.tenantId === tenant.id);
                const totalPaid = tenantPayments.reduce((sum, p) => sum + p.amount, 0);
                const leaseStart = new Date(tenant.leaseStart);
                const now = new Date();
                const monthsDiff = (now.getFullYear() - leaseStart.getFullYear()) * 12 + 
                                   (now.getMonth() - leaseStart.getMonth());
                const expectedTotal = tenant.rent * Math.max(0, monthsDiff);
                const arrears = Math.max(0, expectedTotal - totalPaid);

                if (arrears > 0) {
                    const monthsOwed = Math.floor(arrears / tenant.rent);
                    arrearsData.push({
                        name: tenant.name,
                        unit: tenant.unit,
                        phone: tenant.phone || 'N/A',
                        rent: tenant.rent,
                        arrears: arrears,
                        monthsOwed: monthsOwed,
                        totalPaid: totalPaid,
                        expected: expectedTotal
                    });
                    totalArrears += arrears;
                }
            });
            
            // Sort by arrears amount (highest first)
            arrearsData.sort((a, b) => b.arrears - a.arrears);

            doc.setFontSize(10);
            doc.setFont(undefined, 'normal');
            doc.text(`Total Outstanding Arrears: KES ${totalArrears.toFixed(2)}`, 20, startY + 8);
            doc.text(`Number of Tenants with Arrears: ${arrearsData.length}`, 20, startY + 14);
            
            if (arrearsData.length > 0) {
                const avgArrears = totalArrears / arrearsData.length;
                doc.text(`Average Arrears per Tenant: KES ${avgArrears.toFixed(2)}`, 20, startY + 20);
            }

            if (arrearsData.length === 0) {
                doc.setTextColor(40, 167, 69);
                doc.text('‚úÖ No arrears found! All tenants are up to date.', 20, startY + 30);
                doc.setTextColor(0, 0, 0);
                return;
            }

            const tableData = arrearsData.map(a => [
                a.name,
                a.unit,
                a.phone.substring(0, 15),
                `KES ${a.rent.toFixed(0)}`,
                `${a.monthsOwed} month${a.monthsOwed !== 1 ? 's' : ''}`,
                `KES ${a.arrears.toFixed(2)}`,
                `KES ${a.totalPaid.toFixed(0)}`
            ]);

            doc.autoTable({
                startY: startY + 28,
                head: [['Tenant', 'Unit', 'Phone', 'Monthly', 'Months Owed', 'Arrears', 'Paid']],
                body: tableData,
                theme: 'striped',
                headStyles: { 
                    fillColor: [220, 53, 69],
                    fontSize: 8,
                    fontStyle: 'bold'
                },
                styles: { fontSize: 7 },
                columnStyles: {
                    0: { cellWidth: 35 },
                    1: { cellWidth: 20 },
                    2: { cellWidth: 25 },
                    3: { cellWidth: 25 },
                    4: { cellWidth: 25 },
                    5: { cellWidth: 30 },
                    6: { cellWidth: 25 }
                }
            });
            
            // Add follow-up actions section
            const finalY = doc.lastAutoTable.finalY;
            if (finalY < 250) {
                doc.setFontSize(10);
                doc.setFont(undefined, 'bold');
                doc.text('üí° Recommended Actions:', 20, finalY + 15);
                
                doc.setFontSize(8);
                doc.setFont(undefined, 'normal');
                doc.text('1. Contact tenants with arrears immediately', 25, finalY + 22);
                doc.text('2. Send reminder notices via WhatsApp/Email', 25, finalY + 27);
                doc.text('3. Set up payment plans for tenants with large arrears', 25, finalY + 32);
                doc.text('4. Consider late payment penalties as per lease agreement', 25, finalY + 37);
            }
        }

        function generateTenantsPDF(doc, startY) {
            doc.setFontSize(14);
            doc.text('Tenant List', 20, startY);

            doc.setFontSize(11);
            doc.text(`Total Tenants: ${tenants.length}`, 20, startY + 10);
            doc.text(`Active: ${tenants.filter(t => t.status === 'Active').length}`, 20, startY + 17);
            doc.text(`Past: ${tenants.filter(t => t.status === 'Past Tenant').length}`, 20, startY + 24);

            const tableData = tenants.map(t => [
                t.name,
                t.unit,
                t.email || 'N/A',
                t.phone || 'N/A',
                `KES ${t.rent.toFixed(2)}`,
                t.status
            ]);

            doc.autoTable({
                startY: startY + 32,
                head: [['Name', 'Unit', 'Email', 'Phone', 'Rent', 'Status']],
                body: tableData,
                theme: 'striped',
                headStyles: { fillColor: [102, 126, 234] }
            });
        }

        function generateEquipmentDetailedPDF(doc, startY) {
            const filtered = filterEquipmentForReport();
            
            doc.setFontSize(14);
            doc.setFont(undefined, 'bold');
            doc.text('Equipment Detailed Report', 20, startY);

            const totalQty = filtered.reduce((sum, e) => sum + (e.quantity || 0), 0);
            const totalWorking = filtered.reduce((sum, e) => sum + (e.workingQty || 0), 0);
            const totalNeedReplacement = filtered.reduce((sum, e) => sum + (e.needsReplacement || 0), 0);

            doc.setFontSize(10);
            doc.setFont(undefined, 'normal');
            doc.text(`Total Items: ${filtered.length}`, 20, startY + 8);
            doc.text(`Total Units: ${totalQty} | Working: ${totalWorking} | Need Replacement: ${totalNeedReplacement}`, 20, startY + 14);

            const tableData = filtered.map(e => [
                e.name,
                (e.floor || 'N/A').substring(0, 15),
                (e.section || 'N/A').substring(0, 20),
                e.quantity || 0,
                e.workingQty || 0,
                e.needsReplacement || 0,
                e.insured || 'No',
                e.status
            ]);

            doc.autoTable({
                startY: startY + 20,
                head: [['Equipment', 'Floor', 'Section', 'Total', 'Work', 'Replace', 'Insured', 'Status']],
                body: tableData,
                theme: 'striped',
                headStyles: { fillColor: [102, 126, 234], fontSize: 8 },
                styles: { fontSize: 7 },
                columnStyles: {
                    0: { cellWidth: 40 },
                    1: { cellWidth: 25 },
                    2: { cellWidth: 30 },
                    3: { cellWidth: 15 },
                    4: { cellWidth: 15 },
                    5: { cellWidth: 18 },
                    6: { cellWidth: 18 },
                    7: { cellWidth: 25 }
                }
            });
        }

        function generateAttentionPDF(doc, startY) {
            const itemsNeedingAttention = checkEquipmentReminders();
            
            doc.setFontSize(14);
            doc.setFont(undefined, 'bold');
            doc.text('Items Needing Attention', 20, startY);

            doc.setFontSize(10);
            doc.setFont(undefined, 'normal');
            doc.text(`Total Items: ${itemsNeedingAttention.length}`, 20, startY + 8);

            if (itemsNeedingAttention.length === 0) {
                doc.setTextColor(40, 167, 69);
                doc.text('All equipment is in good condition!', 20, startY + 20);
                doc.setTextColor(0, 0, 0);
                return;
            }

            const tableData = itemsNeedingAttention.map(item => [
                item.name,
                [item.floor, item.section].filter(Boolean).join(' - ') || 'N/A',
                item.attentionReasons.join('; ').substring(0, 60),
                item.status
            ]);

            doc.autoTable({
                startY: startY + 16,
                head: [['Equipment', 'Location', 'Attention Required', 'Status']],
                body: tableData,
                theme: 'striped',
                headStyles: { fillColor: [220, 53, 69], fontSize: 9 },
                styles: { fontSize: 8 }
            });
        }

        function generatePMPDF(doc, startY) {
            doc.setFontSize(14);
            doc.setFont(undefined, 'bold');
            doc.text('Preventive Maintenance Schedule', 20, startY);

            doc.setFontSize(10);
            doc.setFont(undefined, 'normal');
            doc.text(`Total PM Schedules: ${preventiveMaintenance.length}`, 20, startY + 8);

            if (preventiveMaintenance.length === 0) {
                doc.text('No PM schedules created yet.', 20, startY + 20);
                return;
            }

            const today = new Date();
            const tableData = preventiveMaintenance.map(pm => {
                const equip = equipment.find(e => e.id == pm.equipmentId);
                const equipName = equip ? equip.name : 'Unknown';
                
                let daysInfo = 'N/A';
                if (pm.nextDue) {
                    const dueDate = new Date(pm.nextDue);
                    const daysUntil = Math.floor((dueDate - today) / (1000 * 60 * 60 * 24));
                    daysInfo = daysUntil < 0 ? `${Math.abs(daysUntil)}d overdue` : `${daysUntil}d`;
                }
                
                return [
                    equipName.substring(0, 30),
                    pm.maintenanceType,
                    pm.frequency,
                    pm.nextDue || 'N/A',
                    daysInfo,
                    pm.priority
                ];
            });

            doc.autoTable({
                startY: startY + 16,
                head: [['Equipment', 'Type', 'Frequency', 'Next Due', 'Status', 'Priority']],
                body: tableData,
                theme: 'striped',
                headStyles: { fillColor: [102, 126, 234], fontSize: 8 },
                styles: { fontSize: 7 }
            });
        }

        function generatePMOverduePDF(doc, startY) {
            const today = new Date();
            const overdue = [];
            
            preventiveMaintenance.forEach(pm => {
                if (pm.status !== 'Active' || !pm.nextDue) return;
                
                const dueDate = new Date(pm.nextDue);
                const daysUntil = Math.floor((dueDate - today) / (1000 * 60 * 60 * 24));
                
                if (daysUntil < 0) {
                    const equip = equipment.find(e => e.id == pm.equipmentId);
                    overdue.push({
                        ...pm,
                        daysOverdue: Math.abs(daysUntil),
                        equipName: equip?.name || 'Unknown'
                    });
                }
            });

            doc.setFontSize(14);
            doc.setFont(undefined, 'bold');
            doc.text('Overdue PM Report', 20, startY);

            doc.setFontSize(10);
            doc.setFont(undefined, 'normal');
            doc.text(`Total Overdue: ${overdue.length}`, 20, startY + 8);

            if (overdue.length === 0) {
                doc.setTextColor(40, 167, 69);
                doc.text('No overdue PM items!', 20, startY + 20);
                doc.setTextColor(0, 0, 0);
                return;
            }

            const tableData = overdue.map(pm => [
                pm.equipName,
                pm.maintenanceType,
                pm.nextDue,
                `${pm.daysOverdue} days`,
                pm.priority
            ]);

            doc.autoTable({
                startY: startY + 16,
                head: [['Equipment', 'Type', 'Due Date', 'Days Overdue', 'Priority']],
                body: tableData,
                theme: 'striped',
                headStyles: { fillColor: [220, 53, 69], fontSize: 9 },
                styles: { fontSize: 8 }
            });
        }

        function generatePMHistoryPDF(doc, startY, from, to) {
            let filtered = [...pmCompletionHistory];
            
            if (from) filtered = filtered.filter(h => h.completedDate >= from);
            if (to) filtered = filtered.filter(h => h.completedDate <= to);

            doc.setFontSize(14);
            doc.setFont(undefined, 'bold');
            doc.text('PM Completion History', 20, startY);

            doc.setFontSize(10);
            doc.setFont(undefined, 'normal');
            doc.text(`Total Completions: ${filtered.length}`, 20, startY + 8);

            if (filtered.length === 0) {
                doc.text('No completions in this period.', 20, startY + 20);
                return;
            }

            const tableData = filtered.map(h => {
                const equip = equipment.find(e => e.id == h.equipmentId);
                const equipName = equip?.name || 'Unknown';
                const completedDate = new Date(h.completedDate).toLocaleDateString();
                
                return [
                    completedDate,
                    equipName,
                    h.maintenanceType,
                    h.completedBy || 'N/A'
                ];
            });

            doc.autoTable({
                startY: startY + 16,
                head: [['Date', 'Equipment', 'Type', 'Completed By']],
                body: tableData,
                theme: 'striped',
                headStyles: { fillColor: [102, 126, 234] },
                styles: { fontSize: 8 }
            });
        }

        function generateTenantLeasesPDF(doc, startY) {
            const today = new Date();
            
            doc.setFontSize(14);
            doc.setFont(undefined, 'bold');
            doc.text('Tenant Leases & Expiry Report', 20, startY);

            doc.setFontSize(10);
            doc.setFont(undefined, 'normal');
            doc.text(`Total Tenants: ${tenants.length}`, 20, startY + 8);

            const tableData = tenants.map(t => {
                let leaseStatus = 'N/A';
                if (t.leaseEnd) {
                    const leaseEndDate = new Date(t.leaseEnd);
                    const daysUntil = Math.floor((leaseEndDate - today) / (1000 * 60 * 60 * 24));
                    
                    if (daysUntil < 0) {
                        leaseStatus = `Expired ${Math.abs(daysUntil)}d ago`;
                    } else if (daysUntil <= 30) {
                        leaseStatus = `${daysUntil}d (Critical)`;
                    } else if (daysUntil <= 90) {
                        leaseStatus = `${daysUntil}d (Warning)`;
                    } else {
                        leaseStatus = `${daysUntil}d`;
                    }
                }
                
                return [
                    t.name,
                    t.unit,
                    t.leaseStart || 'N/A',
                    t.leaseEnd || 'N/A',
                    leaseStatus,
                    `KES ${t.rent.toFixed(0)}`
                ];
            });

            doc.autoTable({
                startY: startY + 16,
                head: [['Tenant', 'Unit', 'Start', 'End', 'Days Left', 'Rent']],
                body: tableData,
                theme: 'striped',
                headStyles: { fillColor: [102, 126, 234], fontSize: 9 },
                styles: { fontSize: 8 }
            });
        }

        function generateInsuranceClaimsPDF(doc, startY) {
            doc.setFontSize(14);
            doc.setFont(undefined, 'bold');
            doc.text('Insurance Claims Report', 20, startY);

            const pending = insuranceClaims.filter(c => !['Cleared/Paid', 'Rejected'].includes(c.status));
            const cleared = insuranceClaims.filter(c => c.status === 'Cleared/Paid');
            const totalClaimed = insuranceClaims.reduce((sum, c) => sum + c.claimAmount, 0);
            const totalRecovered = cleared.reduce((sum, c) => sum + (c.approvedAmount || c.claimAmount), 0);

            doc.setFontSize(10);
            doc.setFont(undefined, 'normal');
            doc.text(`Total Claims: ${insuranceClaims.length}`, 20, startY + 8);
            doc.text(`Pending: ${pending.length} | Cleared: ${cleared.length}`, 20, startY + 14);
            doc.text(`Total Claimed: KES ${totalClaimed.toFixed(2)}`, 20, startY + 20);
            doc.text(`Total Recovered: KES ${totalRecovered.toFixed(2)}`, 20, startY + 26);

            if (insuranceClaims.length === 0) {
                return;
            }

            const tableData = insuranceClaims.map(c => [
                c.claimTitle.substring(0, 30),
                c.category,
                c.incidentDate,
                `KES ${c.claimAmount.toFixed(0)}`,
                c.status
            ]);

            doc.autoTable({
                startY: startY + 34,
                head: [['Claim Title', 'Category', 'Incident Date', 'Amount', 'Status']],
                body: tableData,
                theme: 'striped',
                headStyles: { fillColor: [102, 126, 234], fontSize: 9 },
                styles: { fontSize: 8 }
            });
        }

        function generateCombinedPDF(doc, startY, reportType, dateFrom, dateTo) {
            doc.setFontSize(14);
            doc.setFont(undefined, 'bold');
            doc.text('Combined Comprehensive Report', 20, startY);
            
            doc.setFontSize(9);
            doc.setFont(undefined, 'normal');
            doc.text(`Report Period: ${dateFrom || 'All Time'} to ${dateTo || 'Present'}`, 20, startY + 8);
            
            // Summary statistics
            let currentY = startY + 18;
            
            doc.setFontSize(11);
            doc.setFont(undefined, 'bold');
            doc.text('üìä Summary Statistics', 20, currentY);
            
            currentY += 7;
            doc.setFontSize(9);
            doc.setFont(undefined, 'normal');
            
            const stats = [
                `Equipment: ${equipment.length} items (${equipment.reduce((s, e) => s + (e.quantity || 1), 0)} total units)`,
                `Tenants: ${tenants.length} total (${tenants.filter(t => t.status === 'Active').length} active)`,
                `Maintenance: ${maintenance.length} tasks (${maintenance.filter(m => m.status !== 'Completed').length} pending)`,
                `PM Schedules: ${preventiveMaintenance.length} (${preventiveMaintenance.filter(p => p.status === 'Active').length} active)`,
                `Insurance Claims: ${insuranceClaims.length} (${insuranceClaims.filter(c => !['Cleared/Paid', 'Rejected'].includes(c.status)).length} pending)`
            ];
            
            stats.forEach(stat => {
                doc.text(stat, 25, currentY);
                currentY += 5;
            });
            
            currentY += 5;
            
            // Equipment Section
            doc.setFontSize(12);
            doc.setFont(undefined, 'bold');
            doc.setTextColor(102, 126, 234);
            doc.text('üì¶ Equipment Overview', 20, currentY);
            doc.setTextColor(0, 0, 0);
            
            currentY += 2;
            
            const equipFiltered = filterEquipmentForReport();
            const totalQty = equipFiltered.reduce((sum, e) => sum + (e.quantity || 0), 0);
            const totalWorking = equipFiltered.reduce((sum, e) => sum + (e.workingQty || 0), 0);
            const totalNeedReplacement = equipFiltered.reduce((sum, e) => sum + (e.needsReplacement || 0), 0);
            
            const equipTableData = equipFiltered.slice(0, 20).map(e => [
                e.name.substring(0, 25),
                (e.floor || 'N/A').substring(0, 12),
                e.quantity || 0,
                e.workingQty || 0,
                e.needsReplacement || 0,
                e.status.substring(0, 12)
            ]);
            
            doc.autoTable({
                startY: currentY + 5,
                head: [['Equipment', 'Floor', 'Total', 'Working', 'Replace', 'Status']],
                body: equipTableData,
                theme: 'striped',
                headStyles: { fillColor: [102, 126, 234], fontSize: 8 },
                styles: { fontSize: 7 },
                margin: { left: 20 }
            });
            
            currentY = doc.lastAutoTable.finalY + 10;
            
            // Items Needing Attention
            if (currentY > 240) {
                doc.addPage();
                currentY = 20;
            }
            
            const itemsNeedingAttention = checkEquipmentReminders();
            if (itemsNeedingAttention.length > 0) {
                doc.setFontSize(12);
                doc.setFont(undefined, 'bold');
                doc.setTextColor(220, 53, 69);
                doc.text('‚ö†Ô∏è Items Needing Attention', 20, currentY);
                doc.setTextColor(0, 0, 0);
                
                const attentionTableData = itemsNeedingAttention.slice(0, 10).map(item => [
                    item.name.substring(0, 30),
                    [item.floor, item.section].filter(Boolean).join(' - ').substring(0, 25) || 'N/A',
                    item.attentionReasons.join('; ').substring(0, 50),
                    item.status
                ]);
                
                doc.autoTable({
                    startY: currentY + 5,
                    head: [['Equipment', 'Location', 'Attention Required', 'Status']],
                    body: attentionTableData,
                    theme: 'striped',
                    headStyles: { fillColor: [220, 53, 69], fontSize: 8 },
                    styles: { fontSize: 7 },
                    margin: { left: 20 }
                });
                
                currentY = doc.lastAutoTable.finalY + 10;
            }
            
            // Preventive Maintenance
            if (currentY > 240) {
                doc.addPage();
                currentY = 20;
            }
            
            if (preventiveMaintenance.length > 0) {
                doc.setFontSize(12);
                doc.setFont(undefined, 'bold');
                doc.setTextColor(102, 126, 234);
                doc.text('üìÖ Preventive Maintenance', 20, currentY);
                doc.setTextColor(0, 0, 0);
                
                const today = new Date();
                const pmTableData = preventiveMaintenance.slice(0, 15).map(pm => {
                    const equip = equipment.find(e => e.id == pm.equipmentId);
                    const equipName = equip ? equip.name : 'Unknown';
                    
                    let daysInfo = 'N/A';
                    if (pm.nextDue) {
                        const dueDate = new Date(pm.nextDue);
                        const daysUntil = Math.floor((dueDate - today) / (1000 * 60 * 60 * 24));
                        daysInfo = daysUntil < 0 ? `${Math.abs(daysUntil)}d over` : `${daysUntil}d`;
                    }
                    
                    return [
                        equipName.substring(0, 25),
                        pm.maintenanceType.substring(0, 15),
                        pm.frequency,
                        daysInfo,
                        pm.priority
                    ];
                });
                
                doc.autoTable({
                    startY: currentY + 5,
                    head: [['Equipment', 'Type', 'Frequency', 'Due In', 'Priority']],
                    body: pmTableData,
                    theme: 'striped',
                    headStyles: { fillColor: [102, 126, 234], fontSize: 8 },
                    styles: { fontSize: 7 },
                    margin: { left: 20 }
                });
                
                currentY = doc.lastAutoTable.finalY + 10;
            }
            
            // Maintenance Tasks
            if (currentY > 240) {
                doc.addPage();
                currentY = 20;
            }
            
            let filteredMaint = maintenance;
            if (dateFrom) filteredMaint = filteredMaint.filter(m => m.date >= dateFrom);
            if (dateTo) filteredMaint = filteredMaint.filter(m => m.date <= dateTo);
            
            if (filteredMaint.length > 0) {
                doc.setFontSize(12);
                doc.setFont(undefined, 'bold');
                doc.setTextColor(102, 126, 234);
                doc.text('üîß Recent Maintenance', 20, currentY);
                doc.setTextColor(0, 0, 0);
                
                const maintTableData = filteredMaint.slice(0, 15).map(m => [
                    m.date,
                    m.property.substring(0, 20),
                    m.type.substring(0, 20),
                    m.status,
                    `KES ${m.cost.toFixed(0)}`
                ]);
                
                doc.autoTable({
                    startY: currentY + 5,
                    head: [['Date', 'Property', 'Type', 'Status', 'Cost']],
                    body: maintTableData,
                    theme: 'striped',
                    headStyles: { fillColor: [102, 126, 234], fontSize: 8 },
                    styles: { fontSize: 7 },
                    margin: { left: 20 }
                });
                
                currentY = doc.lastAutoTable.finalY + 10;
            }
            
            // Tenant Leases
            if (currentY > 240) {
                doc.addPage();
                currentY = 20;
            }
            
            const today = new Date();
            const leasesExpiringSoon = tenants.filter(t => {
                if (!t.leaseEnd) return false;
                const leaseEndDate = new Date(t.leaseEnd);
                const daysUntil = Math.floor((leaseEndDate - today) / (1000 * 60 * 60 * 24));
                return daysUntil <= 90 && daysUntil >= 0;
            });
            
            if (leasesExpiringSoon.length > 0) {
                doc.setFontSize(12);
                doc.setFont(undefined, 'bold');
                doc.setTextColor(255, 193, 7);
                doc.text('üìÖ Leases Expiring Soon (90 days)', 20, currentY);
                doc.setTextColor(0, 0, 0);
                
                const leaseTableData = leasesExpiringSoon.map(t => {
                    const leaseEndDate = new Date(t.leaseEnd);
                    const daysUntil = Math.floor((leaseEndDate - today) / (1000 * 60 * 60 * 24));
                    
                    return [
                        t.name,
                        t.unit,
                        t.leaseEnd,
                        `${daysUntil} days`,
                        `KES ${t.rent.toFixed(0)}`
                    ];
                });
                
                doc.autoTable({
                    startY: currentY + 5,
                    head: [['Tenant', 'Unit', 'Lease End', 'Days Left', 'Rent']],
                    body: leaseTableData,
                    theme: 'striped',
                    headStyles: { fillColor: [255, 193, 7], fontSize: 8 },
                    styles: { fontSize: 7 },
                    margin: { left: 20 }
                });
                
                currentY = doc.lastAutoTable.finalY + 10;
            }
            
            // Insurance Claims
            if (currentY > 240) {
                doc.addPage();
                currentY = 20;
            }
            
            const pendingClaims = insuranceClaims.filter(c => !['Cleared/Paid', 'Rejected'].includes(c.status));
            if (pendingClaims.length > 0) {
                doc.setFontSize(12);
                doc.setFont(undefined, 'bold');
                doc.setTextColor(102, 126, 234);
                doc.text('üõ°Ô∏è Pending Insurance Claims', 20, currentY);
                doc.setTextColor(0, 0, 0);
                
                const claimsTableData = pendingClaims.slice(0, 10).map(c => [
                    c.claimTitle.substring(0, 30),
                    c.category.substring(0, 15),
                    c.incidentDate,
                    `KES ${c.claimAmount.toFixed(0)}`,
                    c.status.substring(0, 15)
                ]);
                
                doc.autoTable({
                    startY: currentY + 5,
                    head: [['Claim', 'Category', 'Date', 'Amount', 'Status']],
                    body: claimsTableData,
                    theme: 'striped',
                    headStyles: { fillColor: [102, 126, 234], fontSize: 8 },
                    styles: { fontSize: 7 },
                    margin: { left: 20 }
                });
            }
        }

        function emailReport() {
            const reportType = document.getElementById('reportType').value;
            const reportTypeNames = {
                'maintenance': 'Maintenance Summary',
                'equipment': 'Equipment Inventory',
                'rent': 'Rent Collection',
                'arrears': 'Arrears Report',
                'tenants': 'Tenant List'
            };

            const subject = `Adam's Masjid - ${reportTypeNames[reportType]} Report`;
            const body = `Please find attached the ${reportTypeNames[reportType]} report generated on ${new Date().toLocaleDateString()}.

This report was generated from Adam's Masjid Property Management System.

Note: Please download the PDF report using the "Download as PDF" button and attach it to your email.`;

            const mailtoLink = `mailto:?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
            window.open(mailtoLink);

            alert('üí° Tip: Click "Download as PDF" first, then attach the PDF file to your email.');
        }

        function sendReportViaWhatsApp() {
            if (!settings.adminPhone) {
                alert('Please configure admin WhatsApp number in Settings first!');
                return;
            }

            const reportType = document.getElementById('reportType').value;
            const reportTypeNames = {
                'maintenance': 'Maintenance Summary',
                'equipment': 'Equipment Inventory',
                'rent': 'Rent Collection',
                'arrears': 'Arrears Report',
                'tenants': 'Tenant List'
            };

            const reportContent = document.getElementById('reportContent').innerText;
            const truncatedContent = reportContent.substring(0, 500) + (reportContent.length > 500 ? '...' : '');

            const message = `üïå *Adam's Masjid - ${reportTypeNames[reportType]}*

üìä *Report Generated:* ${new Date().toLocaleDateString()}

${truncatedContent}

_Full report available as PDF download_`;

            const encodedMessage = encodeURIComponent(message);
            const whatsappUrl = `https://wa.me/${settings.adminPhone.replace(/\D/g, '')}?text=${encodedMessage}`;
            
            window.open(whatsappUrl, '_blank');
            
            alert('üí° Tip: For the complete report, download as PDF and share the file separately.');
        }

        // Firebase Configuration Functions
        function loadFirebaseConfigForm() {
            if (firebaseConfig) {
                document.getElementById('firebaseApiKey').value = firebaseConfig.apiKey || '';
                document.getElementById('firebaseAuthDomain').value = firebaseConfig.authDomain || '';
                document.getElementById('firebaseDatabaseURL').value = firebaseConfig.databaseURL || '';
                document.getElementById('firebaseProjectId').value = firebaseConfig.projectId || '';
                document.getElementById('firebaseStorageBucket').value = firebaseConfig.storageBucket || '';
                document.getElementById('firebaseMessagingSenderId').value = firebaseConfig.messagingSenderId || '';
                document.getElementById('firebaseAppId').value = firebaseConfig.appId || '';
            }
        }

        function saveFirebaseConfig() {
            const config = {
                apiKey: document.getElementById('firebaseApiKey').value.trim(),
                authDomain: document.getElementById('firebaseAuthDomain').value.trim(),
                databaseURL: document.getElementById('firebaseDatabaseURL').value.trim(),
                projectId: document.getElementById('firebaseProjectId').value.trim(),
                storageBucket: document.getElementById('firebaseStorageBucket').value.trim(),
                messagingSenderId: document.getElementById('firebaseMessagingSenderId').value.trim(),
                appId: document.getElementById('firebaseAppId').value.trim()
            };

            // Validate required fields
            if (!config.apiKey || !config.databaseURL || !config.projectId) {
                showFirebaseStatus('Please fill in at least API Key, Database URL, and Project ID', 'error');
                return;
            }

            // Save config
            firebaseConfig = config;
            localStorage.setItem('firebaseConfig', JSON.stringify(config));

            // Reload page to initialize Firebase
            showFirebaseStatus('Configuration saved! Reloading to connect...', 'success');
            setTimeout(() => {
                location.reload();
            }, 2000);
        }

        function testConnection() {
            if (!firebaseConfig) {
                showFirebaseStatus('‚ùå Firebase not configured. Please enter your Firebase configuration and click "Save Firebase Config & Connect" first.', 'error');
                return;
            }

            if (!database) {
                showFirebaseStatus('‚ùå Firebase database not initialized. Please save your configuration and reload the page.', 'error');
                return;
            }

            showFirebaseStatus('üîÑ Testing connection to Firebase...', 'info');
            
            // Create a timeout promise
            const timeoutPromise = new Promise((_, reject) => {
                setTimeout(() => reject(new Error('Connection timeout - please check your Firebase configuration and internet connection')), 10000);
            });

            // Try to write and read a test value
            const testPromise = database.ref('connectionTest').set({
                timestamp: Date.now(),
                message: 'Connection test successful',
                from: 'Adams Masjid Property Management'
            }).then(() => {
                return database.ref('connectionTest').once('value');
            }).then((snapshot) => {
                if (snapshot.exists()) {
                    showFirebaseStatus('‚úÖ Connection successful! Your data is being saved to the cloud. Firebase is working correctly.', 'success');
                    // Clean up test data
                    database.ref('connectionTest').remove();
                } else {
                    showFirebaseStatus('‚ö†Ô∏è Connection established but unable to read data. Check your Firebase database rules.', 'error');
                }
            });

            // Race between test and timeout
            Promise.race([testPromise, timeoutPromise])
                .catch((error) => {
                    console.error('Connection test error:', error);
                    showFirebaseStatus('‚ùå Connection failed: ' + error.message + '. Please verify your Firebase configuration.', 'error');
                });
        }

        function showFirebaseStatus(message, type) {
            const statusDiv = document.getElementById('firebaseStatus');
            statusDiv.style.display = 'block';
            
            const colors = {
                success: { bg: '#d4edda', border: '#28a745', text: '#155724' },
                error: { bg: '#f8d7da', border: '#dc3545', text: '#721c24' },
                info: { bg: '#d1ecf1', border: '#17a2b8', text: '#0c5460' }
            };
            
            const color = colors[type] || colors.info;
            statusDiv.style.background = color.bg;
            statusDiv.style.borderLeft = `4px solid ${color.border}`;
            statusDiv.style.color = color.text;
            statusDiv.innerHTML = message;
        }

        // Settings Functions
        function loadSettings() {
            document.getElementById('adminName').value = settings.adminName || '';
            document.getElementById('adminPhone').value = settings.adminPhone || '';
            document.getElementById('enableReminders').checked = settings.enableReminders || false;
        }

        function saveSettings() {
            settings = {
                adminName: document.getElementById('adminName').value,
                adminPhone: document.getElementById('adminPhone').value,
                enableReminders: document.getElementById('enableReminders').checked
            };
            
            // Save to both localStorage and Firebase
            localStorage.setItem('settings', JSON.stringify(settings));
            if (isFirebaseConnected && database) {
                database.ref('settings').set(settings);
            }
            
            alert('Settings saved successfully!');
            renderMaintenance();
            renderUpcomingReminders();
        }

        // WhatsApp Functions
        function sendWhatsAppReminder(taskId) {
            const task = maintenance.find(t => t.id === taskId);
            if (!task) return;

            if (!settings.adminPhone) {
                alert('Please configure admin WhatsApp number in Settings first!');
                return;
            }

            const message = `üïå *Adam's Masjid - Maintenance Reminder*

üìã *Task:* ${task.description}
üè¢ *Property:* ${task.property}
üîß *Type:* ${task.type}
‚ö†Ô∏è *Priority:* ${task.priority}
üìÖ *Scheduled:* ${task.date}
üë§ *Assigned:* ${task.assigned || 'Unassigned'}
üí∞ *Cost:* KES ${task.cost.toFixed(2)}

${task.notes ? 'üìù *Notes:* ' + task.notes : ''}`;

            const encodedMessage = encodeURIComponent(message);
            const whatsappUrl = `https://wa.me/${settings.adminPhone.replace(/\D/g, '')}?text=${encodedMessage}`;
            
            // Mark reminder as sent
            task.reminderSent = true;
            saveData('maintenance', maintenance);
            
            // Open WhatsApp
            window.open(whatsappUrl, '_blank');
        }

        function checkReminders() {
            if (!settings.enableReminders) return;

            const now = new Date();
            maintenance.forEach(task => {
                if (task.reminder && !task.reminderSent) {
                    const reminderTime = new Date(task.reminder);
                    const timeDiff = reminderTime - now;
                    
                    // Show notification if reminder is within 5 minutes
                    if (timeDiff > 0 && timeDiff <= 5 * 60 * 1000) {
                        showReminderNotification(task);
                    }
                }
            });
        }

        function showReminderNotification(task) {
            if (Notification.permission === 'granted') {
                new Notification('üïå Adam\'s Masjid - Task Reminder', {
                    body: `${task.description} - ${task.property}`,
                    icon: 'üîî'
                });
            }
        }

        function renderUpcomingReminders() {
            const container = document.getElementById('upcomingReminders');
            const now = new Date();
            
            const upcomingTasks = maintenance
                .filter(task => task.reminder && new Date(task.reminder) > now)
                .sort((a, b) => new Date(a.reminder) - new Date(b.reminder))
                .slice(0, 10);

            if (upcomingTasks.length === 0) {
                container.innerHTML = '<p style="text-align: center; padding: 40px; color: #6c757d;">No upcoming reminders</p>';
                return;
            }

            container.innerHTML = upcomingTasks.map(task => `
                <div class="reminder-card">
                    <h4>${task.description}</h4>
                    <p><strong>Property:</strong> ${task.property}</p>
                    <p><strong>Reminder:</strong> ${new Date(task.reminder).toLocaleString()}</p>
                    <p><strong>Priority:</strong> <span class="badge badge-${getPriorityColor(task.priority)}">${task.priority}</span></p>
                    ${settings.adminPhone ? `
                        <button class="btn btn-whatsapp" onclick="sendWhatsAppReminder(${task.id})" style="margin-top: 10px;">
                            üì± Send WhatsApp Reminder Now
                        </button>
                    ` : ''}
                </div>
            `).join('');
        }

        // Request notification permission
        if ('Notification' in window && Notification.permission === 'default') {
            Notification.requestPermission();
        }

        // Helper Functions
        function getPriorityColor(priority) {
            const colors = {
                'Low': 'info',
                'Medium': 'warning',
                'High': 'warning',
                'Emergency': 'danger'
            };
            return colors[priority] || 'info';
        }

        function getStatusColor(status) {
            const colors = {
                'Pending': 'warning',
                'In Progress': 'info',
                'Completed': 'success',
                'On Hold': 'danger'
            };
            return colors[status] || 'info';
        }

        function getEquipStatusColor(status) {
            const colors = {
                'Operational': 'success',
                'Needs Service': 'warning',
                'Out of Service': 'danger',
                'Under Warranty': 'info'
            };
            return colors[status] || 'info';
        }

        function getTenantStatusColor(status) {
            const colors = {
                'Active': 'success',
                'Notice Given': 'warning',
                'Past Tenant': 'info'
            };
            return colors[status] || 'info';
        }

        // Data Recovery and Diagnostic Functions
        function deepScanAllStorage() {
            const output = document.getElementById('dataStatusOutput');
            output.style.display = 'block';
            
            let report = '=== DEEP STORAGE SCAN ===\n\n';
            report += 'Scanning all browser storage locations...\n\n';
            
            // Scan localStorage
            report += '--- LOCALSTORAGE (All Keys) ---\n';
            let foundKeys = [];
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                const value = localStorage.getItem(key);
                const size = value ? value.length : 0;
                foundKeys.push(key);
                report += `${i + 1}. "${key}" (${size} chars)\n`;
                
                // Try to parse and show preview
                try {
                    const parsed = JSON.parse(value);
                    if (Array.isArray(parsed)) {
                        report += `   Array with ${parsed.length} items\n`;
                        if (parsed.length > 0 && parsed[0].name) {
                            report += `   First item: ${parsed[0].name || parsed[0].property || parsed[0].type || 'Unknown'}\n`;
                        }
                    } else if (typeof parsed === 'object') {
                        report += `   Object with keys: ${Object.keys(parsed).slice(0, 5).join(', ')}\n`;
                    }
                } catch (e) {
                    report += `   Non-JSON data\n`;
                }
            }
            
            if (foundKeys.length === 0) {
                report += 'NO DATA FOUND IN LOCALSTORAGE!\n';
            }
            
            report += '\n--- EXPECTED KEYS ---\n';
            const expectedKeys = ['maintenance', 'equipment', 'tenants', 'payments', 'insuranceClaims', 'preventiveMaintenance', 'pmCompletionHistory', 'settings'];
            expectedKeys.forEach(key => {
                const exists = foundKeys.includes(key);
                report += `${exists ? '‚úÖ' : '‚ùå'} ${key}\n`;
            });
            
            // Scan sessionStorage
            report += '\n--- SESSIONSTORAGE ---\n';
            if (sessionStorage.length > 0) {
                for (let i = 0; i < sessionStorage.length; i++) {
                    const key = sessionStorage.key(i);
                    const value = sessionStorage.getItem(key);
                    report += `${i + 1}. "${key}" (${value.length} chars)\n`;
                }
            } else {
                report += 'Empty\n';
            }
            
            // Check IndexedDB
            report += '\n--- INDEXEDDB ---\n';
            if (window.indexedDB) {
                report += 'Available (advanced scan needed)\n';
            } else {
                report += 'Not available\n';
            }
            
            // Memory check
            report += '\n--- CURRENT MEMORY ---\n';
            report += `Maintenance: ${maintenance.length} items\n`;
            report += `Equipment: ${equipment.length} items\n`;
            report += `Tenants: ${tenants.length} items\n`;
            report += `Payments: ${payments.length} items\n`;
            report += `Insurance: ${insuranceClaims.length} items\n`;
            report += `PM: ${preventiveMaintenance.length} items\n`;
            
            report += '\n--- DIAGNOSIS ---\n';
            const totalInStorage = foundKeys.filter(k => expectedKeys.includes(k)).length;
            const totalInMemory = maintenance.length + equipment.length + tenants.length;
            
            if (totalInMemory > 0) {
                report += '‚úÖ Data exists in memory and is showing\n';
            } else if (totalInStorage > 0) {
                report += '‚ö†Ô∏è Data exists in storage but not loaded\n';
                report += 'ACTION: Click "Force Reload All Data"\n';
            } else {
                report += '‚ùå CRITICAL: No data found anywhere\n';
                report += '\nPOSSIBLE DATA LOSS!\n';
                report += '\nRECOVERY OPTIONS:\n';
                report += '1. Check if you have a backup file\n';
                report += '2. Check Firebase Console for cloud data\n';
                report += '3. Check browser history (different session?)\n';
                report += '4. Check Downloads folder for exported backups\n';
                report += '5. Use "Import Backup File" if you have one\n';
            }
            
            output.textContent = report;
            console.log(report);
            
            // Also show alert
            if (totalInMemory === 0 && totalInStorage === 0) {
                alert('‚ö†Ô∏è CRITICAL DATA SITUATION\n\nNo data found in browser storage.\n\nDo you have:\n- A backup file (.json)?\n- Data in Firebase?\n- Access from another browser/device?\n\nCheck the recovery options in Settings tab.');
            }
        }

        function importBackupFile() {
            const fileInput = document.getElementById('importFileInput');
            const file = fileInput.files[0];
            
            if (!file) {
                alert('Please select a backup file first');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    
                    // Validate data structure
                    if (!data.maintenance && !data.equipment && !data.tenants) {
                        throw new Error('Invalid backup file structure');
                    }
                    
                    // Confirm import
                    const summary = `Import this backup file?\n\n` +
                                  `Maintenance: ${(data.maintenance || []).length} items\n` +
                                  `Equipment: ${(data.equipment || []).length} items\n` +
                                  `Tenants: ${(data.tenants || []).length} items\n` +
                                  `Payments: ${(data.payments || []).length} items\n` +
                                  `Insurance: ${(data.insuranceClaims || []).length} items\n` +
                                  `PM Schedules: ${(data.preventiveMaintenance || []).length} items\n\n` +
                                  `This will REPLACE current data!`;
                    
                    if (!confirm(summary)) return;
                    
                    // Import data
                    maintenance = data.maintenance || [];
                    equipment = data.equipment || [];
                    tenants = data.tenants || [];
                    payments = data.payments || [];
                    insuranceClaims = data.insuranceClaims || [];
                    preventiveMaintenance = data.preventiveMaintenance || [];
                    pmCompletionHistory = data.pmCompletionHistory || [];
                    
                    // Save to localStorage
                    localStorage.setItem('maintenance', JSON.stringify(maintenance));
                    localStorage.setItem('equipment', JSON.stringify(equipment));
                    localStorage.setItem('tenants', JSON.stringify(tenants));
                    localStorage.setItem('payments', JSON.stringify(payments));
                    localStorage.setItem('insuranceClaims', JSON.stringify(insuranceClaims));
                    localStorage.setItem('preventiveMaintenance', JSON.stringify(preventiveMaintenance));
                    localStorage.setItem('pmCompletionHistory', JSON.stringify(pmCompletionHistory));
                    
                    // Refresh displays
                    forceReloadData();
                    
                    alert('‚úÖ DATA RESTORED SUCCESSFULLY!\n\nYour backup has been imported.\n\nCheck all tabs to verify your data.');
                    
                } catch (error) {
                    alert('‚ùå Import Failed\n\nError: ' + error.message + '\n\nPlease check the file format.');
                    console.error('Import error:', error);
                }
            };
            
            reader.readAsText(file);
        }

        function importManualData() {
            const textarea = document.getElementById('manualDataInput');
            const jsonText = textarea.value.trim();
            
            if (!jsonText) {
                alert('Please paste JSON data first');
                return;
            }
            
            try {
                const data = JSON.parse(jsonText);
                
                // Confirm import
                const summary = `Import this data?\n\n` +
                              `Maintenance: ${(data.maintenance || []).length} items\n` +
                              `Equipment: ${(data.equipment || []).length} items\n` +
                              `Tenants: ${(data.tenants || []).length} items\n` +
                              `Payments: ${(data.payments || []).length} items\n\n` +
                              `This will REPLACE current data!`;
                
                if (!confirm(summary)) return;
                
                // Import
                if (data.maintenance) {
                    maintenance = data.maintenance;
                    localStorage.setItem('maintenance', JSON.stringify(maintenance));
                }
                if (data.equipment) {
                    equipment = data.equipment;
                    localStorage.setItem('equipment', JSON.stringify(equipment));
                }
                if (data.tenants) {
                    tenants = data.tenants;
                    localStorage.setItem('tenants', JSON.stringify(tenants));
                }
                if (data.payments) {
                    payments = data.payments;
                    localStorage.setItem('payments', JSON.stringify(payments));
                }
                if (data.insuranceClaims) {
                    insuranceClaims = data.insuranceClaims;
                    localStorage.setItem('insuranceClaims', JSON.stringify(insuranceClaims));
                }
                if (data.preventiveMaintenance) {
                    preventiveMaintenance = data.preventiveMaintenance;
                    localStorage.setItem('preventiveMaintenance', JSON.stringify(preventiveMaintenance));
                }
                
                // Refresh
                forceReloadData();
                
                alert('‚úÖ DATA IMPORTED!\n\nManual data has been imported successfully.');
                textarea.value = '';
                
            } catch (error) {
                alert('‚ùå Invalid JSON\n\nError: ' + error.message + '\n\nPlease check the format.');
                console.error('Parse error:', error);
            }
        }

        function checkDataStatus() {
            const output = document.getElementById('dataStatusOutput');
            output.style.display = 'block';
            
            let report = '=== DATA STATUS REPORT ===\n\n';
            report += 'Generated: ' + new Date().toLocaleString() + '\n\n';
            
            // Check memory arrays
            report += '--- IN-MEMORY DATA ---\n';
            report += `Maintenance Tasks: ${maintenance.length} items\n`;
            report += `Equipment: ${equipment.length} items\n`;
            report += `Tenants: ${tenants.length} items\n`;
            report += `Payments: ${payments.length} items\n`;
            report += `Insurance Claims: ${insuranceClaims.length} items\n`;
            report += `PM Schedules: ${preventiveMaintenance.length} items\n`;
            report += `PM History: ${pmCompletionHistory.length} items\n\n`;
            
            // Check localStorage
            report += '--- LOCALSTORAGE DATA ---\n';
            const lsMaint = localStorage.getItem('maintenance');
            const lsEquip = localStorage.getItem('equipment');
            const lsTenants = localStorage.getItem('tenants');
            const lsPayments = localStorage.getItem('payments');
            const lsClaims = localStorage.getItem('insuranceClaims');
            const lsPM = localStorage.getItem('preventiveMaintenance');
            const lsPMHistory = localStorage.getItem('pmCompletionHistory');
            
            report += `Maintenance: ${lsMaint ? JSON.parse(lsMaint).length + ' items' : 'EMPTY or NULL'}\n`;
            report += `Equipment: ${lsEquip ? JSON.parse(lsEquip).length + ' items' : 'EMPTY or NULL'}\n`;
            report += `Tenants: ${lsTenants ? JSON.parse(lsTenants).length + ' items' : 'EMPTY or NULL'}\n`;
            report += `Payments: ${lsPayments ? JSON.parse(lsPayments).length + ' items' : 'EMPTY or NULL'}\n`;
            report += `Insurance: ${lsClaims ? JSON.parse(lsClaims).length + ' items' : 'EMPTY or NULL'}\n`;
            report += `PM Schedules: ${lsPM ? JSON.parse(lsPM).length + ' items' : 'EMPTY or NULL'}\n`;
            report += `PM History: ${lsPMHistory ? JSON.parse(lsPMHistory).length + ' items' : 'EMPTY or NULL'}\n\n`;
            
            // Check Firebase status
            report += '--- FIREBASE STATUS ---\n';
            report += `Connected: ${isFirebaseConnected ? 'YES' : 'NO'}\n`;
            report += `Firebase App: ${firebaseApp ? 'Initialized' : 'Not Initialized'}\n`;
            report += `Database: ${database ? 'Available' : 'Not Available'}\n\n`;
            
            // Overall status
            report += '--- DIAGNOSIS ---\n';
            const totalMemory = maintenance.length + equipment.length + tenants.length + payments.length;
            const hasLocalStorage = lsMaint || lsEquip || lsTenants || lsPayments;
            
            if (totalMemory > 0) {
                report += '‚úÖ STATUS: Data loaded in memory\n';
                report += '   Your data is accessible and showing in the app.\n\n';
            } else if (hasLocalStorage) {
                report += '‚ö†Ô∏è STATUS: Data exists in localStorage but not loaded\n';
                report += '   ACTION: Click "Force Reload All Data" button\n\n';
            } else {
                report += '‚ùå STATUS: No data found\n';
                report += '   POSSIBLE CAUSES:\n';
                report += '   1. Fresh installation (no data added yet)\n';
                report += '   2. Data in Firebase only (need to fix rules)\n';
                report += '   3. Browser cache cleared recently\n';
                report += '   4. Different browser/device\n\n';
                report += '   ACTION: Check Firebase Console for your data\n';
            }
            
            output.textContent = report;
            
            // Also log to console
            console.log(report);
        }

        function viewLocalStorageData() {
            const output = document.getElementById('dataStatusOutput');
            output.style.display = 'block';
            
            let report = '=== LOCALSTORAGE DETAILED VIEW ===\n\n';
            
            // Maintenance
            const lsMaint = localStorage.getItem('maintenance');
            if (lsMaint) {
                const data = JSON.parse(lsMaint);
                report += `--- MAINTENANCE (${data.length} items) ---\n`;
                data.slice(0, 3).forEach((item, idx) => {
                    report += `${idx + 1}. ${item.property} - ${item.type} (${item.date})\n`;
                });
                if (data.length > 3) report += `... and ${data.length - 3} more\n`;
                report += '\n';
            } else {
                report += '--- MAINTENANCE ---\nNo data\n\n';
            }
            
            // Equipment
            const lsEquip = localStorage.getItem('equipment');
            if (lsEquip) {
                const data = JSON.parse(lsEquip);
                report += `--- EQUIPMENT (${data.length} items) ---\n`;
                data.slice(0, 3).forEach((item, idx) => {
                    report += `${idx + 1}. ${item.name} - ${item.category} (${item.floor || 'N/A'})\n`;
                });
                if (data.length > 3) report += `... and ${data.length - 3} more\n`;
                report += '\n';
            } else {
                report += '--- EQUIPMENT ---\nNo data\n\n';
            }
            
            // Tenants
            const lsTenants = localStorage.getItem('tenants');
            if (lsTenants) {
                const data = JSON.parse(lsTenants);
                report += `--- TENANTS (${data.length} items) ---\n`;
                data.slice(0, 3).forEach((item, idx) => {
                    report += `${idx + 1}. ${item.name} - Unit ${item.unit} (KES ${item.rent})\n`;
                });
                if (data.length > 3) report += `... and ${data.length - 3} more\n`;
                report += '\n';
            } else {
                report += '--- TENANTS ---\nNo data\n\n';
            }
            
            // Payments
            const lsPayments = localStorage.getItem('payments');
            if (lsPayments) {
                const data = JSON.parse(lsPayments);
                report += `--- PAYMENTS (${data.length} items) ---\n`;
                data.slice(0, 3).forEach((item, idx) => {
                    report += `${idx + 1}. ${item.date} - KES ${item.amount} (${item.method})\n`;
                });
                if (data.length > 3) report += `... and ${data.length - 3} more\n`;
                report += '\n';
            } else {
                report += '--- PAYMENTS ---\nNo data\n\n';
            }
            
            report += '\nüí° TIP: If you see data above, click "Force Reload All Data"\n';
            
            output.textContent = report;
            console.log(report);
        }

        function exportAllData() {
            const allData = {
                exportDate: new Date().toISOString(),
                maintenance: maintenance.length > 0 ? maintenance : JSON.parse(localStorage.getItem('maintenance') || '[]'),
                equipment: equipment.length > 0 ? equipment : JSON.parse(localStorage.getItem('equipment') || '[]'),
                tenants: tenants.length > 0 ? tenants : JSON.parse(localStorage.getItem('tenants') || '[]'),
                payments: payments.length > 0 ? payments : JSON.parse(localStorage.getItem('payments') || '[]'),
                insuranceClaims: insuranceClaims.length > 0 ? insuranceClaims : JSON.parse(localStorage.getItem('insuranceClaims') || '[]'),
                preventiveMaintenance: preventiveMaintenance.length > 0 ? preventiveMaintenance : JSON.parse(localStorage.getItem('preventiveMaintenance') || '[]'),
                pmCompletionHistory: pmCompletionHistory.length > 0 ? pmCompletionHistory : JSON.parse(localStorage.getItem('pmCompletionHistory') || '[]')
            };
            
            const dataStr = JSON.stringify(allData, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `property-mgmt-backup-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            
            alert('‚úÖ Data exported successfully!\n\nFile: property-mgmt-backup-' + new Date().toISOString().split('T')[0] + '.json\n\nThis file contains ALL your data as a backup.');
            
            // Show summary
            const output = document.getElementById('dataStatusOutput');
            output.style.display = 'block';
            output.textContent = `=== DATA EXPORT SUMMARY ===\n\nExported: ${new Date().toLocaleString()}\n\nMaintenance: ${allData.maintenance.length} items\nEquipment: ${allData.equipment.length} items\nTenants: ${allData.tenants.length} items\nPayments: ${allData.payments.length} items\nInsurance: ${allData.insuranceClaims.length} items\nPM Schedules: ${allData.preventiveMaintenance.length} items\nPM History: ${allData.pmCompletionHistory.length} items\n\n‚úÖ File downloaded to your Downloads folder`;
        }

        function forceReloadData() {
            if (confirm('Force reload all data from localStorage?\n\nThis will:\n1. Load data from browser storage\n2. Refresh all displays\n3. Override current memory\n\nContinue?')) {
                // Force load from localStorage
                maintenance = JSON.parse(localStorage.getItem('maintenance') || '[]');
                equipment = JSON.parse(localStorage.getItem('equipment') || '[]');
                tenants = JSON.parse(localStorage.getItem('tenants') || '[]');
                payments = JSON.parse(localStorage.getItem('payments') || '[]');
                insuranceClaims = JSON.parse(localStorage.getItem('insuranceClaims') || '[]');
                preventiveMaintenance = JSON.parse(localStorage.getItem('preventiveMaintenance') || '[]');
                pmCompletionHistory = JSON.parse(localStorage.getItem('pmCompletionHistory') || '[]');
                
                // Refresh all displays
                renderMaintenance();
                renderEquipment();
                renderTenants();
                renderPayments();
                renderInsuranceClaims();
                renderPMSchedules();
                updateDashboard();
                updateTenantDropdown();
                updateEquipmentDropdown();
                updateClaimEquipmentDropdown();
                updatePMEquipmentDropdown();
                updateRentStatus();
                updatePMStats();
                updateClaimsStats();
                checkReminders();
                checkEquipmentReminders();
                checkLeaseExpiry();
                checkRentEscalations();
                renderLeaseExpiryWarnings();
                renderRentEscalationWarnings();
                renderUpcomingReminders();
                
                const total = maintenance.length + equipment.length + tenants.length + payments.length;
                
                if (total > 0) {
                    alert(`‚úÖ Data Reloaded Successfully!\n\nLoaded from localStorage:\n‚Ä¢ Maintenance: ${maintenance.length}\n‚Ä¢ Equipment: ${equipment.length}\n‚Ä¢ Tenants: ${tenants.length}\n‚Ä¢ Payments: ${payments.length}\n‚Ä¢ Insurance: ${insuranceClaims.length}\n‚Ä¢ PM Schedules: ${preventiveMaintenance.length}\n\nCheck your tabs now!`);
                } else {
                    alert('‚ö†Ô∏è No Data Found in LocalStorage\n\nPossible reasons:\n1. Fresh installation\n2. Data only in Firebase\n3. Browser storage cleared\n\nCheck Firebase Console or import a backup file.');
                }
                
                // Show status
                checkDataStatus();
            }
        }
    </script>
</body>
</html>